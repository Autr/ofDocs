<!doctype html>
<html data-n-head-ssr>
  <head>
    <title>ofArduino.cpp | openframeworks | ofDocs</title><meta data-n-head="ssr" data-hid="description" name="description" content="openFrameworks documentation and examples browser"><meta data-n-head="ssr" data-hid="keyword" name="keyword" content=""><meta data-n-head="ssr" property="og:description" content="openFrameworks documentation and examples browser" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="ofArduino.cpp | openframeworks | ofDocs" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="/files/images/ofw-logo.png" vmid="og:image"><link rel="preload" href="/_nuxt/3213b67383225fc2f59b.js" as="script"><link rel="preload" href="/_nuxt/5fe5bba000836bc4a25f.js" as="script"><link rel="preload" href="/_nuxt/fe12c0cb7395fa1032f4.css" as="style"><link rel="preload" href="/_nuxt/f8d94d1c92ade1d8a6da.js" as="script"><link rel="preload" href="/_nuxt/a24b354526a25539cceb.css" as="style"><link rel="preload" href="/_nuxt/9a7e20c23e9625feab77.js" as="script"><link rel="preload" href="/_nuxt/21c4d0f9583096394838.css" as="style"><link rel="preload" href="/_nuxt/d1291586b31fa28ca9d5.js" as="script"><link rel="stylesheet" href="/_nuxt/fe12c0cb7395fa1032f4.css"><link rel="stylesheet" href="/_nuxt/a24b354526a25539cceb.css"><link rel="stylesheet" href="/_nuxt/21c4d0f9583096394838.css">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div id="app" class="unknown"><div id="menu"><h1 class="of"><div class="inner"><span><a href="/" class="nuxt-link-active"><div class="txt"><span class="docs f7 questrial">ofDocs </span><span class="version">0.11.0</span></div></a></span></div></h1><div id="search"><div class="inner"><div class="field text"><div class="field-inner"><svg viewbox="0 0 36 36" x="0px" y="0px" enable-background="new 0 0 36 36" xml:space="preserve"><path d="M35.525,31.228l-8.88-8.882c1.444-2.238,2.298-4.895,2.298-7.752c0-7.909-6.438-14.343-14.346-14.343						c-7.911,0-14.343,6.434-14.343,14.343c0,7.911,6.433,14.344,14.343,14.344c2.856,0,5.513-0.849,7.752-2.294l8.88,8.88						c0.295,0.297,0.782,0.297,1.076,0l3.22-3.221C35.824,32.008,35.824,31.523,35.525,31.228z M4.81,14.593						c0-5.396,4.391-9.788,9.788-9.788c5.398,0,9.787,4.392,9.787,9.788c0,5.398-4.389,9.789-9.787,9.789						C9.2,24.382,4.81,19.991,4.81,14.593z"></path></svg><!----><div class="text-wrapper"><input id="search_field" name="search_field" placeholder="Search (Alt+F)" autocomplete="off" tabindex="0"></div><!----><!----></div></div></div><div id="results" class="mt1"></div></div><div id="lists" class="menu-inner mt1"><div class="inner"><div class="item documentation"><a href="/documentation/" title="/documentation/"><i class="ico" style="display:none"></i><span>documentation</span><span style="display:none">documentation</span></a><!----></div><div class="item examples"><a href="/examples/" title="/examples/"><i class="ico" style="display:none"></i><span>examples</span><span style="display:none">examples</span></a><!----></div><div class="item openframeworks"><a href="/openframeworks/" title="/openframeworks/" class="nuxt-link-active"><i class="ico" style="display:none"></i><span>openFrameworks</span><span style="display:none">openframeworks</span></a><div class="list"><div class="item 3d"><a href="/openframeworks/3d/" title="/openframeworks/3d/"><i class="ico" style="display:none"></i><span style="display:none"></span><span>3d</span></a><!----></div><div class="item app"><a href="/openframeworks/app/" title="/openframeworks/app/"><i class="ico" style="display:none">web</i><span style="display:none"></span><span>app</span></a><!----></div><div class="item communication"><a href="/openframeworks/communication/" title="/openframeworks/communication/" class="nuxt-link-active"><i class="ico" style="display:none">language</i><span style="display:none"></span><span>communication</span></a><div class="list"><div class="item ofArduino.cpp"><a href="/openframeworks/communication/ofArduino_cpp" title="/openframeworks/communication/ofArduino.cpp" class="nuxt-link-exact-active nuxt-link-active"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofArduino.cpp</span></a><div class="list"></div></div><div class="item ofArduino.h"><a href="/openframeworks/communication/ofArduino_h" title="/openframeworks/communication/ofArduino.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofArduino.h</span></a><!----></div><div class="item ofSerial.cpp"><a href="/openframeworks/communication/ofSerial_cpp" title="/openframeworks/communication/ofSerial.cpp"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofSerial.cpp</span></a><!----></div><div class="item ofSerial.h"><a href="/openframeworks/communication/ofSerial_h" title="/openframeworks/communication/ofSerial.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofSerial.h</span></a><!----></div></div></div><div class="item events"><a href="/openframeworks/events/" title="/openframeworks/events/"><i class="ico" style="display:none">question_answer</i><span style="display:none"></span><span>events</span></a><!----></div><div class="item gl"><a href="/openframeworks/gl/" title="/openframeworks/gl/"><i class="ico" style="display:none"></i><span style="display:none"></span><span>gl</span></a><!----></div><div class="item graphics"><a href="/openframeworks/graphics/" title="/openframeworks/graphics/"><i class="ico" style="display:none">category</i><span style="display:none"></span><span>graphics</span></a><!----></div><div class="item math"><a href="/openframeworks/math/" title="/openframeworks/math/"><i class="ico" style="display:none">border_clear</i><span style="display:none"></span><span>math</span></a><!----></div><div class="item sound"><a href="/openframeworks/sound/" title="/openframeworks/sound/"><i class="ico" style="display:none">volume_up</i><span style="display:none"></span><span>sound</span></a><!----></div><div class="item types"><a href="/openframeworks/types/" title="/openframeworks/types/"><i class="ico" style="display:none">ring_volume</i><span style="display:none"></span><span>types</span></a><!----></div><div class="item utils"><a href="/openframeworks/utils/" title="/openframeworks/utils/"><i class="ico" style="display:none">build</i><span style="display:none"></span><span>utils</span></a><!----></div><div class="item video"><a href="/openframeworks/video/" title="/openframeworks/video/"><i class="ico" style="display:none">videocam</i><span style="display:none"></span><span>video</span></a><!----></div></div></div><div class="item addons"><a href="/addons/" title="/addons/"><i class="ico" style="display:none">extension</i><span>addons</span><span style="display:none">addons</span></a><!----></div><div class="item guides"><a href="/guides/" title="/guides/"><i class="ico" style="display:none"></i><span>guides</span><span style="display:none">guides</span></a><!----></div></div></div></div><div id="document"><div id="renderer" class="main"><div absolute="/Users/gilbertsinnott/Code/openFrameworks/libs/openFrameworks/communication/ofArduino.cpp" route="/openframeworks/communication/ofArduino.cpp" dir="../libs/openFrameworks/communication" ext="cpp" type="source" id="226" parent="225" siblings="" translations="[object Object]" class="doc-header"><div class="doc-header-inner"><div class="inner"><div class="mt2 mb2"><span class="breadcrumbs"><span class="crumb"><a href="/" class="pink nuxt-link-active">ofDocs</a><span class="chevron right"></span></span><span class="crumb"><a href="/openframeworks/" class="pink nuxt-link-active">openframeworks </a><!----><span class="chevron right"></span></span><span class="crumb"><a href="/openframeworks/communication/" class="pink nuxt-link-active">communication </a><!----><span class="chevron right"></span></span><span class="crumb"><!----><span class="link selector"><span>ofArduino.cpp </span><span class="chevron bottom"></span><select><option value="/openframeworks/communication/ofArduino_cpp">ofArduino.cpp</option><option value="/openframeworks/communication/ofArduino_h">ofArduino.h</option><option value="/openframeworks/communication/ofSerial_cpp">ofSerial.cpp</option><option value="/openframeworks/communication/ofSerial_h">ofSerial.h</option></select></span><!----></span></span></div></div></div></div><div id="code-page" static="true" class="markdown"><div id="side-menu"><!----><div id="see-also" filename="communication" absolute="/Users/gilbertsinnott/Code/openFrameworks/libs/openFrameworks/communication" dir="../libs/openFrameworks" route="/openframeworks/communication/" ext="" type="folder" children="226,227,228,229" icon="language" parent="195" breadcrumbs="195" class="see-also"><h4>See also</h4><div class="also"><a href="/documentation/communication/"><span class="origin">documentation</span><span class="name">communication</span></a></div><div class="also"><a href="/examples/communication/"><span class="origin">examples</span><span class="name">communication</span></a></div></div></div><div id="code-render"><div class="inner"><pre><code><span class="token comment" spellcheck="true">/*
 * 11/5/15:
 *   - updated for arduino 2.5.0 and configurable firmata
 *
 * 1/9/13:
 *   - Fixed issue where digitalPinchange
 *
 * 9/28/11:
 *   - updated to be Firmata 2.3/Arduino 1.0 compatible
 *   - fixed ability to use analog pins as digital inputs
 *
 * 3/5/11:
 *   - added servo support for firmata 2.2 and greater (should be
 *     backwards compatible with Erik Sjodin's older firmata servo
 *     implementation)
 *
 *
 * Copyright 2007-2008 (c) Erik Sjodin, eriksjodin.net
 * Wiring version 2011 (c) Carlos Mario Rodriguez and Hernando Barragan
 * Updates 2015 (c) Dom Amato
 *
 * Devloped at: The Interactive Institutet / Art and Technology,
 * OF Lab / Ars Electronica
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial _portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofArduino.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofUtils.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofMath.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofLog.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

 <span class="token comment" spellcheck="true">// TODO thread it?</span>
 <span class="token comment" spellcheck="true">// TODO throw event or exception if the serial port goes down...</span>
 <span class="token comment" spellcheck="true">//---------------------------------------------------------------------------</span>
ofArduino<span class="token operator">::</span><span class="token function">ofArduino</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_portStatus <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	_waitForData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	_analogHistoryLength <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	_digitalHistoryLength <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	_stringHistoryLength <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	_sysExHistoryLength <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	_initialized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	_totalDigitalPins <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	_executeMultiByteCommand <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 0x00 a pin mode (input), not a command in Firmata -> fail hard</span>
	_multiByteChannel <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	_firstAnalogPin <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">&</span> e <span class="token operator">:</span> _storedInputData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		e <span class="token operator">=</span> UCHAR_MAX<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&</span> e <span class="token operator">:</span> _digitalPinMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		e <span class="token operator">=</span> INT_MAX<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&</span> e <span class="token operator">:</span> _digitalPinValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		e <span class="token operator">=</span> INT_MAX<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&</span> e <span class="token operator">:</span> _digitalPortValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		e <span class="token operator">=</span> INT_MAX<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&</span> e <span class="token operator">:</span> _digitalPortReporting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		e <span class="token operator">=</span> INT_MAX<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&</span> e <span class="token operator">:</span> _digitalPinReporting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		e <span class="token operator">=</span> INT_MAX<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&</span> e <span class="token operator">:</span> _analogPinReporting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		e <span class="token operator">=</span> INT_MAX<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&</span> e <span class="token operator">:</span> _servoValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		e <span class="token operator">=</span> INT_MAX<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	connected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	connectTime <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>

	_majorFirmwareVersion <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	_minorFirmwareVersion <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	_firmwareName <span class="token operator">=</span> <span class="token string">"Unknown"</span><span class="token punctuation">;</span>

	bUseDelay <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ofArduino<span class="token operator">::</span><span class="token operator">~</span><span class="token function">ofArduino</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_port<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// initialize pins once we get the Firmata version back from the Arduino board</span>
<span class="token comment" spellcheck="true">// the version is sent automatically by the Arduino board on startup</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">initPins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>_initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>                 <span class="token comment" spellcheck="true">// already initialized</span>
	<span class="token punctuation">}</span>

	_digitalHistory<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>_totalDigitalPins <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_digitalPinMode<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>_totalDigitalPins <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_digitalPinValue<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>_totalDigitalPins <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_digitalPinReporting<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>_totalDigitalPins <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_servoValue<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>_totalDigitalPins <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	_analogHistory<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>_totalDigitalPins <span class="token operator">-</span> _firstAnalogPin <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_analogPinReporting<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>_totalDigitalPins <span class="token operator">-</span> _firstAnalogPin <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">// ports</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ARD_TOTAL_PORTS<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_digitalPortValue<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		_digitalPortReporting<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_OFF<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment" spellcheck="true">// digital pins</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _firstAnalogPin<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_digitalPinValue<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		_digitalPinMode<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_OUTPUT<span class="token punctuation">;</span>
		_digitalPinReporting<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_OFF<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment" spellcheck="true">// analog in pins</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> _firstAnalogPin<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _totalDigitalPins<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_analogPinReporting<span class="token punctuation">[</span>i <span class="token operator">-</span> _firstAnalogPin<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_OFF<span class="token punctuation">;</span>
		<span class="token comment" spellcheck="true">// analog pins used as digital</span>
		_digitalPinMode<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_ANALOG<span class="token punctuation">;</span>
		_digitalPinValue<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _totalDigitalPins<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_servoValue<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	_initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>EInitialized<span class="token punctuation">,</span> _majorFirmwareVersion<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> ofArduino<span class="token operator">::</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string <span class="token operator">&</span> device<span class="token punctuation">,</span> <span class="token keyword">int</span> baud<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	connectTime <span class="token operator">=</span> <span class="token function">ofGetElapsedTimef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_initialized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	connected <span class="token operator">=</span> _port<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> baud<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendFirmwareVersionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> connected<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// this method is not recommended</span>
<span class="token comment" spellcheck="true">// the preferred method is to listen for the EInitialized event in your application</span>
<span class="token keyword">bool</span> ofArduino<span class="token operator">::</span><span class="token function">isArduinoReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bUseDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_initialized <span class="token operator">&&</span> <span class="token punctuation">(</span><span class="token function">ofGetElapsedTimef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> connectTime<span class="token punctuation">)</span> <span class="token operator">></span> OF_ARDUINO_DELAY_LENGTH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendPinCapabilityRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			connected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> connected<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">setUseDelay</span><span class="token punctuation">(</span><span class="token keyword">bool</span> bDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	bUseDelay <span class="token operator">=</span> bDelay<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">setDigitalHistoryLength</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_digitalHistoryLength <span class="token operator">=</span> length<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">setAnalogHistoryLength</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_analogHistoryLength <span class="token operator">=</span> length<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">setSysExHistoryLength</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_sysExHistoryLength <span class="token operator">=</span> length<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">setStringHistoryLength</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_stringHistoryLength <span class="token operator">=</span> length<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_port<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	vector <span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> bytesToProcess<span class="token punctuation">;</span>
	<span class="token keyword">int</span> bytesToRead <span class="token operator">=</span> _port<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bytesToRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		bytesToProcess<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>bytesToRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment" spellcheck="true">//its possible we dont get all the bytes</span>
		<span class="token keyword">int</span> bytesRead <span class="token operator">=</span> _port<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span><span class="token operator">&</span>bytesToProcess<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bytesToRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bytesRead<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">processData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bytesToProcess<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">getAnalog</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAnalogPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span><span class="token function">convertAnalogPinToDigital</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> ARD_ANALOG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Analog Input has not been configured for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	pin <span class="token operator">=</span> <span class="token function">convertDigitalPinToAnalog</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_analogHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> _analogHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">getDigital</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_INPUT <span class="token operator">||</span> _digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_INPUT_PULLUP<span class="token punctuation">)</span> <span class="token operator">&&</span> _digitalHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> _digitalHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_OUTPUT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> _digitalPinValue<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">getPwm</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>pwmSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"PWM is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_PWM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> _digitalPinValue<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

vector <span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> ofArduino<span class="token operator">::</span><span class="token function">getSysEx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> _sysExHistory<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

string ofArduino<span class="token operator">::</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> _stringHistory<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">getDigitalPinMode</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> _digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendDigital</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token keyword">bool</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_INPUT <span class="token operator">||</span> _digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_INPUT_PULLUP <span class="token operator">||</span> _digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_OUTPUT<span class="token punctuation">)</span> <span class="token operator">&&</span> <span class="token punctuation">(</span>_digitalPinValue<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">!=</span> value <span class="token operator">||</span> force<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		_digitalPinValue<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>

		<span class="token comment" spellcheck="true">// set the bit</span>
		<span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token punctuation">(</span>pin <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0x0F</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
			_digitalPortValue<span class="token punctuation">[</span>port<span class="token punctuation">]</span> <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>pin <span class="token operator">&</span> <span class="token number">0x07</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment" spellcheck="true">// clear the bit</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			_digitalPortValue<span class="token punctuation">[</span>port<span class="token punctuation">]</span> <span class="token operator">&</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>pin <span class="token operator">&</span> <span class="token number">0x07</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">sendByte</span><span class="token punctuation">(</span>DIGITAL_MESSAGE <span class="token operator">|</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>_digitalPortValue<span class="token punctuation">[</span>port<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendPwm</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token keyword">bool</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>pwmSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"PWM is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_PWM <span class="token operator">&&</span> <span class="token punctuation">(</span>_digitalPinValue<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">!=</span> value <span class="token operator">||</span> force<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>ANALOG_MESSAGE <span class="token operator">|</span> pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
		_digitalPinValue<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendSysEx</span><span class="token punctuation">(</span><span class="token keyword">int</span> command<span class="token punctuation">,</span> vector <span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
	vector <span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span><span class="token operator">::</span>iterator it <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
		it<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendSysExBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendSysExEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendString</span><span class="token punctuation">(</span>string str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>STRING_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	string<span class="token operator">::</span>iterator it <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> str<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
		it<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendProtocolVersionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>REPORT_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendFirmwareVersionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>REPORT_FIRMWARE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//this currently isn't supported as the resonse is not mapped</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendPinCofigurationRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>PIN_STATE_QUERY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendPinCapabilityRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>CAPABILITY_QUERY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendAnalogMappingRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ANALOG_MAPPING_QUERY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendPinStateQuery</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>PIN_STATE_QUERY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>pin <span class="token operator">&</span> <span class="token number">0x7f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SYSTEM_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendAnalogPinReporting</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAnalogPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment" spellcheck="true">//the digital pin mode needs the digital pin #</span>
	_digitalPinMode<span class="token punctuation">[</span><span class="token function">convertAnalogPinToDigital</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> ARD_ANALOG<span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">//the sent message needs the analog pin #</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>REPORT_ANALOG <span class="token operator">|</span> <span class="token function">convertDigitalPinToAnalog</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	_analogPinReporting<span class="token punctuation">[</span><span class="token function">convertDigitalPinToAnalog</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendDigitalPinMode</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> ARD_INPUT<span class="token operator">:</span>
	<span class="token keyword">case</span> ARD_INPUT_PULLUP<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>inputSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Input is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ARD_OUTPUT<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>outputSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Output is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ARD_ANALOG<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>analogSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Analog is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ARD_PWM<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>pwmSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"PWM is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ARD_SERVO<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>servoSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Servo Control is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ARD_I2C<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>i2cSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"I2C is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ARD_ONEWIRE<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>onewireSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Onewire is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ARD_STEPPER<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>stepperSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Stepper Control is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ARD_ENCODER<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>encoderSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Encoder Control is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ARD_SERIAL<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>serialSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Serial is not supported for pin"</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">default</span><span class="token operator">:</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Mode is not supported"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SET_PIN_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Tx pins 0-6</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	_digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">=</span> mode<span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">// turn on or off reporting on the port</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> ARD_INPUT <span class="token operator">||</span> mode <span class="token operator">==</span> ARD_INPUT_PULLUP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendDigitalPinReporting</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> ARD_ON<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">sendDigitalPinReporting</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> ARD_OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">getAnalogPinReporting</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAnalogPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span><span class="token function">convertAnalogPinToDigital</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> ARD_ANALOG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Analog Input has not been configured for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment" spellcheck="true">//these are just safety checks</span>
	pin <span class="token operator">=</span> <span class="token function">convertDigitalPinToAnalog</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> _analogPinReporting<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

list <span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">*</span> ofArduino<span class="token operator">::</span><span class="token function">getAnalogHistory</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAnalogPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span><span class="token function">convertAnalogPinToDigital</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> ARD_ANALOG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Analog Input has not been configured for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	pin <span class="token operator">=</span> <span class="token function">convertDigitalPinToAnalog</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">&</span>_analogHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

list <span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">*</span> ofArduino<span class="token operator">::</span><span class="token function">getDigitalHistory</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&</span>_digitalHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

list <span class="token operator">&lt;</span>vector <span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> <span class="token operator">></span> <span class="token operator">*</span> ofArduino<span class="token operator">::</span><span class="token function">getSysExHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&</span>_sysExHistory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

list <span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token operator">*</span> ofArduino<span class="token operator">::</span><span class="token function">getStringHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&</span>_stringHistory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">getMajorFirmwareVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> _majorFirmwareVersion<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">getMinorFirmwareVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> _minorFirmwareVersion<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

string ofArduino<span class="token operator">::</span><span class="token function">getFirmwareName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> _firmwareName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> ofArduino<span class="token operator">::</span><span class="token function">isInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> _initialized<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> ofArduino<span class="token operator">::</span><span class="token function">isAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment" spellcheck="true">//should return false if there is a serial error thus the arduino is not attached</span>
	<span class="token keyword">return</span> _port<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ------------------------------ private functions</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">processData</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> inputData<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">char</span> msg<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">"Received Byte: %i"</span><span class="token punctuation">,</span> inputData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment" spellcheck="true">//Logger::get("Application").information(msg);</span>

	<span class="token comment" spellcheck="true">// we have command data</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_waitForData <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&&</span> inputData <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_waitForData<span class="token operator">--</span><span class="token punctuation">;</span>

		<span class="token comment" spellcheck="true">// collect the data</span>
		_storedInputData<span class="token punctuation">[</span>_waitForData<span class="token punctuation">]</span> <span class="token operator">=</span> inputData<span class="token punctuation">;</span>

		<span class="token comment" spellcheck="true">// we have all data executeMultiByteCommand</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>_waitForData <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span>_executeMultiByteCommand<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> DIGITAL_MESSAGE<span class="token operator">:</span>
				<span class="token function">processDigitalPort</span><span class="token punctuation">(</span>_multiByteChannel<span class="token punctuation">,</span> <span class="token punctuation">(</span>_storedInputData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">|</span> _storedInputData<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>

			<span class="token keyword">case</span> REPORT_VERSION<span class="token operator">:</span>    <span class="token comment" spellcheck="true">// report version</span>
				_majorFirmwareVersion <span class="token operator">=</span> _storedInputData<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				_minorFirmwareVersion <span class="token operator">=</span> _storedInputData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>EFirmwareVersionReceived<span class="token punctuation">,</span> _majorFirmwareVersion<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>

			<span class="token keyword">case</span> ANALOG_MESSAGE<span class="token operator">:</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>_initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>_analogHistory<span class="token punctuation">[</span>_multiByteChannel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">int</span> previous <span class="token operator">=</span> _analogHistory<span class="token punctuation">[</span>_multiByteChannel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

						_analogHistory<span class="token punctuation">[</span>_multiByteChannel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_storedInputData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">|</span> _storedInputData<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>_analogHistory<span class="token punctuation">[</span>_multiByteChannel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> _analogHistoryLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							_analogHistory<span class="token punctuation">[</span>_multiByteChannel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>

						<span class="token comment" spellcheck="true">// trigger an event if the pin has changed value</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>_analogHistory<span class="token punctuation">[</span>_multiByteChannel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> previous<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>EAnalogPinChanged<span class="token punctuation">,</span> _multiByteChannel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span> <span class="token punctuation">{</span>
						_analogHistory<span class="token punctuation">[</span>_multiByteChannel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_storedInputData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">|</span> _storedInputData<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>_analogHistory<span class="token punctuation">[</span>_multiByteChannel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> _analogHistoryLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							_analogHistory<span class="token punctuation">[</span>_multiByteChannel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment" spellcheck="true">// we have SysEx command data</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_waitForData <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment" spellcheck="true">// we have all sysex data</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>inputData <span class="token operator">==</span> END_SYSEX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			_waitForData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">processSysExData</span><span class="token punctuation">(</span>_sysExData<span class="token punctuation">)</span><span class="token punctuation">;</span>
			_sysExData<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment" spellcheck="true">// still have data, collect it</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			_sysExData<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>inputData<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment" spellcheck="true">// we have a command</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>

		<span class="token keyword">int</span> command<span class="token punctuation">;</span>

		<span class="token comment" spellcheck="true">// extract the command and channel info from a byte if it is less than 0xF0</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>inputData <span class="token operator">&lt;</span> <span class="token number">0xF0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			command <span class="token operator">=</span> inputData <span class="token operator">&</span> <span class="token number">0xF0</span><span class="token punctuation">;</span>
			_multiByteChannel <span class="token operator">=</span> inputData <span class="token operator">&</span> <span class="token number">0x0F</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment" spellcheck="true">// commands in the 0xF* range don't use channel data</span>
			command <span class="token operator">=</span> inputData<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">switch</span> <span class="token punctuation">(</span>command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> REPORT_VERSION<span class="token operator">:</span>
		<span class="token keyword">case</span> DIGITAL_MESSAGE<span class="token operator">:</span>
		<span class="token keyword">case</span> ANALOG_MESSAGE<span class="token operator">:</span>
			_waitForData <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 2 bytes needed</span>
			_executeMultiByteCommand <span class="token operator">=</span> command<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>

		<span class="token keyword">case</span> START_SYSEX<span class="token operator">:</span>
			_sysExData<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			_waitForData <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// n bytes needed, -1 is used to indicate sysex message</span>
			_executeMultiByteCommand <span class="token operator">=</span> command<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// sysex data is assumed to be 8-bit bytes split into two 7-bit bytes.</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">processSysExData</span><span class="token punctuation">(</span>vector <span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	string str<span class="token punctuation">;</span>

	vector <span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> buffer<span class="token punctuation">;</span>
	<span class="token comment" spellcheck="true">//int i = 1;</span>

	<span class="token comment" spellcheck="true">// act on reserved sysEx messages (extended commands) or trigger SysEx event...</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//first byte in buffer is command</span>
	<span class="token keyword">case</span> REPORT_FIRMWARE<span class="token operator">:</span>
		<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Recieved Firmware Report"</span><span class="token punctuation">;</span>
		it <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		it<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// skip the first byte, which is the firmware version command</span>
		_majorFirmwareVersion <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
		it<span class="token operator">++</span><span class="token punctuation">;</span>
		_minorFirmwareVersion <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
		it<span class="token operator">++</span><span class="token punctuation">;</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			buffer <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
			it<span class="token operator">++</span><span class="token punctuation">;</span>
			buffer <span class="token operator">+</span><span class="token operator">=</span> <span class="token operator">*</span>it <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span>
			it<span class="token operator">++</span><span class="token punctuation">;</span>
			str <span class="token operator">+</span><span class="token operator">=</span> buffer<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		_firmwareName <span class="token operator">=</span> str<span class="token punctuation">;</span>

		<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>EFirmwareVersionReceived<span class="token punctuation">,</span> _majorFirmwareVersion<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment" spellcheck="true">// trigger the initialization event</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendPinCapabilityRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> STRING_DATA<span class="token operator">:</span>
		<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Recieved Firamta String"</span><span class="token punctuation">;</span>
		it <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		it<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// skip the first byte, which is the string command</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			buffer <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
			it<span class="token operator">++</span><span class="token punctuation">;</span>
			buffer <span class="token operator">+</span><span class="token operator">=</span> <span class="token operator">*</span>it <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span>
			it<span class="token operator">++</span><span class="token punctuation">;</span>
			str <span class="token operator">+</span><span class="token operator">=</span> buffer<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		_stringHistory<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>_stringHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> _stringHistoryLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			_stringHistory<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>EStringReceived<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> I2C_REPLY<span class="token operator">:</span>
		<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Recieved I2C Reply"</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">7</span> <span class="token operator">&&</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			Firmata_I2C_Data i2creply<span class="token punctuation">;</span>
			it <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			i2creply<span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">++</span>it <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">++</span>it <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			i2creply<span class="token punctuation">.</span>reg <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">++</span>it <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">++</span>it <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			it<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				str <span class="token operator">+</span><span class="token operator">=</span> <span class="token operator">*</span>it <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">++</span>it <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				it<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			i2creply<span class="token punctuation">.</span>data <span class="token operator">=</span> str<span class="token punctuation">;</span>
			<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>EI2CDataRecieved<span class="token punctuation">,</span> i2creply<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"Arduino I2C"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Incorrect Number of Bytes recieved, possible buffer overflow"</span><span class="token punctuation">;</span>
			<span class="token function">purge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ENCODER_DATA<span class="token operator">:</span>
		<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Recieved Encoder Data"</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

			vector<span class="token operator">&lt;</span>Firmata_Encoder_Data<span class="token operator">></span> encoderReply<span class="token punctuation">;</span>
			Firmata_Encoder_Data tempEncoderReply<span class="token punctuation">;</span>
			<span class="token keyword">int</span> encoderPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">unsigned</span> <span class="token keyword">char</span> encBuffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

			it <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			it<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// skip the first byte, which is the string command</span>

			<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				tempEncoderReply<span class="token punctuation">.</span>ID <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it <span class="token operator">&</span> ENCODER_CHANNEL_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
				tempEncoderReply<span class="token punctuation">.</span>direction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it <span class="token operator">&</span> ENCODER_DIRECTION_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>

				it<span class="token operator">++</span><span class="token punctuation">;</span>

				encBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token operator">++</span> <span class="token operator">&</span> <span class="token number">0x7F</span><span class="token punctuation">;</span>
				encBuffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token operator">++</span> <span class="token operator">&</span> <span class="token number">0x7F</span><span class="token punctuation">;</span>
				encBuffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token operator">++</span> <span class="token operator">&</span> <span class="token number">0x7F</span><span class="token punctuation">;</span>
				encBuffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token operator">++</span> <span class="token operator">&</span> <span class="token number">0x7F</span><span class="token punctuation">;</span>

				encoderPos <span class="token operator">=</span> encBuffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				encoderPos <span class="token operator">&lt;&lt;=</span> <span class="token number">7</span><span class="token punctuation">;</span>
				encoderPos <span class="token operator">|</span><span class="token operator">=</span> encBuffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				encoderPos <span class="token operator">&lt;&lt;=</span> <span class="token number">7</span><span class="token punctuation">;</span>
				encoderPos <span class="token operator">|</span><span class="token operator">=</span> encBuffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				encoderPos <span class="token operator">&lt;&lt;=</span> <span class="token number">7</span><span class="token punctuation">;</span>
				encoderPos <span class="token operator">|</span><span class="token operator">=</span> encBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

				tempEncoderReply<span class="token punctuation">.</span>position <span class="token operator">=</span> encoderPos<span class="token punctuation">;</span>
				encoderReply<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>tempEncoderReply<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>EEncoderDataReceived<span class="token punctuation">,</span> encoderReply<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"Arduino Encoder"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Incorrect Number of Bytes recieved, possible buffer overflow"</span><span class="token punctuation">;</span>
			<span class="token function">purge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> SERIAL_MESSAGE<span class="token operator">:</span>
	<span class="token punctuation">{</span>
		<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Recieved Serial Message"</span><span class="token punctuation">;</span>
		Firmata_Serial_Data reply<span class="token punctuation">;</span>

		it <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment" spellcheck="true">//unsigned char command = *it & 0xF0;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> portId <span class="token operator">=</span> <span class="token operator">*</span>it <span class="token operator">&</span> <span class="token number">0x0F</span><span class="token punctuation">;</span>
		it<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// skip the first byte, which is the command and port</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			buffer <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
			it<span class="token operator">++</span><span class="token punctuation">;</span>
			buffer <span class="token operator">+</span><span class="token operator">=</span> <span class="token operator">*</span>it <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span>
			it<span class="token operator">++</span><span class="token punctuation">;</span>
			str <span class="token operator">+</span><span class="token operator">=</span> buffer<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>portId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> HW_SERIAL0<span class="token operator">:</span>
			reply<span class="token punctuation">.</span>portID <span class="token operator">=</span> HW_SERIAL0<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> HW_SERIAL1<span class="token operator">:</span>
			reply<span class="token punctuation">.</span>portID <span class="token operator">=</span> HW_SERIAL1<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> HW_SERIAL2<span class="token operator">:</span>
			reply<span class="token punctuation">.</span>portID <span class="token operator">=</span> HW_SERIAL2<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> HW_SERIAL3<span class="token operator">:</span>
			reply<span class="token punctuation">.</span>portID <span class="token operator">=</span> HW_SERIAL3<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> SW_SERIAL0<span class="token operator">:</span>
			reply<span class="token punctuation">.</span>portID <span class="token operator">=</span> SW_SERIAL0<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> SW_SERIAL1<span class="token operator">:</span>
			reply<span class="token punctuation">.</span>portID <span class="token operator">=</span> SW_SERIAL1<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> SW_SERIAL2<span class="token operator">:</span>
			reply<span class="token punctuation">.</span>portID <span class="token operator">=</span> SW_SERIAL2<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> SW_SERIAL3<span class="token operator">:</span>
			reply<span class="token punctuation">.</span>portID <span class="token operator">=</span> SW_SERIAL3<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"Arduino Serial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Port does not exist or is not defined"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		reply<span class="token punctuation">.</span>data <span class="token operator">=</span> str<span class="token punctuation">;</span>
		<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>ESerialDataReceived<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> CAPABILITY_RESPONSE<span class="token operator">:</span>
	<span class="token punctuation">{</span>
		<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Recieved Capability Response"</span><span class="token punctuation">;</span>
		it <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		it <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// skip the first byte, which is the string command</span>

		<span class="token keyword">int</span> pin <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

		firmataInputSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		firmataOutputSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		firmataAnalogSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		firmataPwmSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		firmataServoSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		firmataI2cSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		firmataSerialSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		firmataOnewireSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		firmataStepperSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		firmataEncoderSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> ARD_INPUT<span class="token operator">:</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>inputSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>outputSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				firmataInputSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				firmataOutputSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				it <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> ARD_ANALOG<span class="token operator">:</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>analogSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				it <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>firmataAnalogSupported<span class="token punctuation">)</span>
					_firstAnalogPin <span class="token operator">=</span> pin<span class="token punctuation">;</span>
				firmataAnalogSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> ARD_PWM<span class="token operator">:</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>pwmSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				firmataPwmSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				it <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> ARD_SERVO<span class="token operator">:</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>servoSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				firmataServoSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				it <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> ARD_I2C<span class="token operator">:</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>i2cSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				firmataI2cSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				it <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> ARD_SERIAL<span class="token operator">:</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>serialSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				firmataI2cSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				it <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> ARD_ONEWIRE<span class="token operator">:</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>onewireSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				firmataOnewireSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				it <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> ARD_STEPPER<span class="token operator">:</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>stepperSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				firmataStepperSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				it <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> ARD_ENCODER<span class="token operator">:</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>encoderSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				firmataEncoderSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				it <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span>
				it<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					supportedPinTypes temp<span class="token punctuation">;</span>
					pinCapabilities<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token operator">++</span>pin<span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		_totalDigitalPins <span class="token operator">=</span> pin<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendAnalogMappingRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> ANALOG_MAPPING_RESPONSE<span class="token operator">:</span>
	<span class="token punctuation">{</span>
		<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Recieved Analog Map Query Response"</span><span class="token punctuation">;</span>
		it <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> pin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">bool</span> fAPin <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		it<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// skip the first byte, which is the string command</span>
		_totalAnalogPins <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment" spellcheck="true">//from the firmata protocol</span>
			<span class="token comment" spellcheck="true">//analog channel corresponding to pin x, or 127 if pin x does not support analog</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>it <span class="token operator">!=</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				analogPinMap<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">,</span> pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
				_totalAnalogPins<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token comment" spellcheck="true">//these should be set by the capability query but just incase</span>
				pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>analogSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>firmataAnalogSupported<span class="token punctuation">)</span>
					firmataAnalogSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

				<span class="token comment" spellcheck="true">//lets also make sure that the capability response and this match up</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fAPin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>pin <span class="token operator">!=</span> _firstAnalogPin<span class="token punctuation">)</span>
						<span class="token function">ofLogNotice</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Capabaility Query and Analog Map don't match up"</span><span class="token punctuation">;</span>
					_firstAnalogPin <span class="token operator">=</span> pin<span class="token punctuation">;</span>
					fAPin <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			pin<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token operator">*</span>it<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">initPins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> PIN_STATE_RESPONSE<span class="token operator">:</span>
	<span class="token punctuation">{</span>
		<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Recieved Pin State Query Response"</span><span class="token punctuation">;</span>
		it <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		it<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// skip the first byte, which is the string command</span>
		<span class="token keyword">int</span> pin <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token operator">++</span><span class="token punctuation">;</span>
		Firmata_Pin_Modes mode<span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> ARD_INPUT<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_INPUT<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ARD_INPUT_PULLUP<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_INPUT_PULLUP<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ARD_OUTPUT<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_OUTPUT<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ARD_ANALOG<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_ANALOG<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ARD_PWM<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_PWM<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ARD_SERVO<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_SERVO<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ARD_I2C<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_I2C<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ARD_SERIAL<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_SERIAL<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ARD_ONEWIRE<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_ONEWIRE<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ARD_STEPPER<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_STEPPER<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ARD_ENCODER<span class="token operator">:</span>
			mode <span class="token operator">=</span> Firmata_Pin_Modes<span class="token operator">::</span>MODE_ENCODER<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//		int val;</span>
		<span class="token keyword">int</span> shift <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//			val = *it &lt;&lt; shift;</span>
			it<span class="token operator">++</span><span class="token punctuation">;</span>
			shift <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//clear whatever is left</span>
		<span class="token comment" spellcheck="true">//int pinVal[2] = { pin, val }; //I think this was supposed to be the return value</span>
		pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Firmata_Pin_Modes<span class="token operator">></span> <span class="token function">reply</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>EPinStateResponseReceived<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">default</span><span class="token operator">:</span>    <span class="token comment" spellcheck="true">// the message isn't in Firmatas extended command set</span>
		<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"This message isn't in Firmatas extended command set"</span><span class="token punctuation">;</span>
		_sysExHistory<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>_sysExHistory<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> _sysExHistoryLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			_sysExHistory<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>ESysExReceived<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">processDigitalPort</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_initialized<span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> mask<span class="token punctuation">;</span>
	<span class="token keyword">int</span> previous<span class="token punctuation">;</span>
	<span class="token keyword">int</span> pin<span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		pin <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token punctuation">(</span>port <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pin <span class="token operator">&lt;=</span> _totalDigitalPins <span class="token operator">&&</span> <span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_INPUT <span class="token operator">||</span> _digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_INPUT_PULLUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_digitalHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				previous <span class="token operator">=</span> _digitalHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span> previous <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

			mask <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">;</span>
			_digitalHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value <span class="token operator">&</span> mask<span class="token punctuation">)</span> <span class="token operator">>></span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>_digitalHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> _digitalHistoryLength<span class="token punctuation">)</span>
				_digitalHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment" spellcheck="true">// trigger an event if the pin has changed value</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>_digitalHistory<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> previous<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">ofNotifyEvent</span><span class="token punctuation">(</span>EDigitalPinChanged<span class="token punctuation">,</span> pin<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendDigitalPortReporting</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>REPORT_DIGITAL <span class="token operator">|</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	_digitalPortReporting<span class="token punctuation">[</span>port<span class="token punctuation">]</span> <span class="token operator">=</span> mode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendDigitalPinReporting</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>pin <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> ARD_OFF <span class="token operator">||</span> mode <span class="token operator">==</span> ARD_ON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_digitalPinReporting<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">=</span> mode<span class="token punctuation">;</span>
		<span class="token function">sendDigitalPortReporting</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendByte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_port<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// in Firmata (and MIDI) data bytes are 7-bits. The 8th bit serves as a flag to mark a byte as either command or data.</span>
<span class="token comment" spellcheck="true">// therefore you need two data bytes to send 8-bits (a char).</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>value <span class="token operator">&</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// LSB</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>value <span class="token operator">>></span> <span class="token number">7</span> <span class="token operator">&</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// MSB</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// SysEx data is sent as 8-bit bytes split into two 7-bit bytes, this function merges two 7-bit bytes back into one 8-bit byte.</span>
<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">getValueFromTwo7bitBytes</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> lsb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> msb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>msb <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">|</span> lsb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">getInvertedValueFromTwo7bitBytes</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> lsb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> msb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> msb <span class="token operator">|</span> <span class="token punctuation">(</span>lsb <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/********************************************
*
*
*				Servo Functions
*
*
********************************************/</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendServoAttach</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">int</span> minPulse<span class="token punctuation">,</span> <span class="token keyword">int</span> maxPulse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>servoSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Servo Control is not supported for pin"</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERVO_CONFIG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>minPulse<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>maxPulse<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	_digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_SERVO<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendServo</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token keyword">bool</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>servoSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Servo Control is not supported for pin "</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">!=</span> ARD_SERVO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Servo Control is not configured for pin "</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">". Did you send a servo attach message?"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_digitalPinValue<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">!=</span> value <span class="token operator">||</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pin <span class="token operator">></span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>EXTENDED_ANALOG<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>ANALOG_MESSAGE <span class="token operator">|</span> pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
			_digitalPinValue<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">getServo</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>servoSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Servo Control is not supported for pin"</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_digitalPinMode<span class="token punctuation">[</span>pin<span class="token punctuation">]</span> <span class="token operator">==</span> ARD_SERVO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> _digitalPinValue<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/********************************************
*
*
*				Stepper Functions
*
*
********************************************/</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendStepper2Wire</span><span class="token punctuation">(</span><span class="token keyword">int</span> dirPin<span class="token punctuation">,</span> <span class="token keyword">int</span> stepPin<span class="token punctuation">,</span> <span class="token keyword">int</span> stepsPerRev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>dirPin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>stepPin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>dirPin<span class="token punctuation">]</span><span class="token punctuation">.</span>stepperSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Stepper Control is not supported for pin"</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>dirPin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>stepPin<span class="token punctuation">]</span><span class="token punctuation">.</span>stepperSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Stepper Control is not supported for pin"</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>stepPin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_numSteppers <span class="token operator">&lt;</span> MAX_STEPPERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>STEPPER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>STEPPER_CONFIG<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>_numSteppers<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>FIRMATA_STEPPER_DRIVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>stepsPerRev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>dirPin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>stepPin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		_digitalPinMode<span class="token punctuation">[</span>dirPin<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_STEPPER<span class="token punctuation">;</span>
		_digitalPinMode<span class="token punctuation">[</span>stepPin<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_STEPPER<span class="token punctuation">;</span>
		_numSteppers<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogNotice</span><span class="token punctuation">(</span><span class="token string">"Arduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Reached max number of steppers"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendStepper4Wire</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin1<span class="token punctuation">,</span> <span class="token keyword">int</span> pin2<span class="token punctuation">,</span> <span class="token keyword">int</span> pin3<span class="token punctuation">,</span> <span class="token keyword">int</span> pin4<span class="token punctuation">,</span> <span class="token keyword">int</span> stepsPerRev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin3<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin4<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin1<span class="token punctuation">]</span><span class="token punctuation">.</span>stepperSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Stepper Control is not supported for pin"</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin1<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin2<span class="token punctuation">]</span><span class="token punctuation">.</span>stepperSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Stepper Control is not supported for pin"</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin3<span class="token punctuation">]</span><span class="token punctuation">.</span>stepperSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Stepper Control is not supported for pin"</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin3<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin4<span class="token punctuation">]</span><span class="token punctuation">.</span>stepperSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Stepper Control is not supported for pin"</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin4<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_numSteppers <span class="token operator">&lt;</span> MAX_STEPPERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>STEPPER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>STEPPER_CONFIG<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>_numSteppers<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>FIRMATA_STEPPER_FOUR_WIRE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>stepsPerRev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>pin1<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>pin2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>pin3<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>pin4<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>

		_digitalPinMode<span class="token punctuation">[</span>pin1<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_STEPPER<span class="token punctuation">;</span>
		_digitalPinMode<span class="token punctuation">[</span>pin2<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_STEPPER<span class="token punctuation">;</span>
		_digitalPinMode<span class="token punctuation">[</span>pin3<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_STEPPER<span class="token punctuation">;</span>
		_digitalPinMode<span class="token punctuation">[</span>pin4<span class="token punctuation">]</span> <span class="token operator">=</span> ARD_STEPPER<span class="token punctuation">;</span>
		_numSteppers<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogNotice</span><span class="token punctuation">(</span><span class="token string">"Arduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Reached max number of steppers"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendStepperMove</span><span class="token punctuation">(</span><span class="token keyword">int</span> stepperID<span class="token punctuation">,</span> <span class="token keyword">int</span> direction<span class="token punctuation">,</span> <span class="token keyword">int</span> numSteps<span class="token punctuation">,</span> <span class="token keyword">int</span> speed<span class="token punctuation">,</span> <span class="token keyword">float</span> acceleration<span class="token punctuation">,</span> <span class="token keyword">float</span> deceleration<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>stepperID <span class="token operator">&lt;=</span> _numSteppers <span class="token operator">&&</span> stepperID <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> steps<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>numSteps<span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0x0000007F</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>numSteps<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0x0000007F</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>numSteps<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0x0000007F</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token comment" spellcheck="true">// the stepper interface expects decimal expressed an an integer</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>acceleration <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&&</span> deceleration <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">int</span> accel <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>acceleration <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> decel <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>deceleration <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>STEPPER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>STEPPER_STEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>stepperID<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>steps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>steps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>steps<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>accel<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>decel<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>STEPPER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>STEPPER_STEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>stepperID<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>steps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>steps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>steps<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">/********************************************
*
*
*				I2C Functions
*
*
********************************************/</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendI2CConfig</span><span class="token punctuation">(</span><span class="token keyword">int</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>I2C_CONFIG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>delay <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>delay <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>

	_i2cConfigured <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendI2CWriteRequest</span><span class="token punctuation">(</span><span class="token keyword">char</span> slaveAddress<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> bytes<span class="token punctuation">,</span> <span class="token keyword">int</span> numOfBytes<span class="token punctuation">,</span> <span class="token keyword">int</span> reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>_i2cConfigured<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>I2C_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>slaveAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>FIRMATA_I2C_WRITE <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> numOfBytes<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"Arduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"I2C was not configured, did you send an I2C config request?"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendI2CWriteRequest</span><span class="token punctuation">(</span><span class="token keyword">char</span> slaveAddress<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> bytes<span class="token punctuation">,</span> <span class="token keyword">int</span> numOfBytes<span class="token punctuation">,</span> <span class="token keyword">int</span> reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_i2cConfigured<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>I2C_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>slaveAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>FIRMATA_I2C_WRITE <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> numOfBytes<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"Arduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"I2C was not configured, did you send an I2C config request?"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendI2CWriteRequest</span><span class="token punctuation">(</span><span class="token keyword">char</span> slaveAddress<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> bytes<span class="token punctuation">,</span> <span class="token keyword">int</span> numOfBytes<span class="token punctuation">,</span> <span class="token keyword">int</span> reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_i2cConfigured<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>I2C_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>slaveAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>FIRMATA_I2C_WRITE <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> numOfBytes<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"Arduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"I2C was not configured, did you send an I2C config request?"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendI2CWriteRequest</span><span class="token punctuation">(</span><span class="token keyword">char</span> slaveAddress<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> bytes<span class="token punctuation">,</span> <span class="token keyword">int</span> reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>_i2cConfigured<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>I2C_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>slaveAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>FIRMATA_I2C_WRITE <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> bytes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"Arduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"I2C was not configured, did you send an I2C config request?"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendI2CReadRequest</span><span class="token punctuation">(</span><span class="token keyword">char</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> numBytes<span class="token punctuation">,</span> <span class="token keyword">int</span> reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>_i2cConfigured<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>I2C_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>FIRMATA_I2C_READ <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>numBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"Arduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"I2C was not configured, did you send an I2C config request?"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendI2ContinuousReadRequest</span><span class="token punctuation">(</span><span class="token keyword">char</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> numBytes<span class="token punctuation">,</span> <span class="token keyword">int</span> reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_i2cConfigured<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>I2C_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>FIRMATA_I2C_CONTINUOUS_READ <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>numBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"Arduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"I2C was not configured, did you send an I2C config request?"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> ofArduino<span class="token operator">::</span><span class="token function">isI2CConfigured</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span>  _i2cConfigured<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// CONTINUOUS_READ</span>

<span class="token comment" spellcheck="true">/********************************************
*
*
*				One Wire Functions
*
*
********************************************/</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendOneWireConfig</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">bool</span> enableParasiticPower<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>onewireSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Onewire is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ONEWIRE_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ONEWIRE_CONFIG_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>enableParasiticPower <span class="token operator">?</span> <span class="token number">0x01</span> <span class="token operator">:</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendOneWireSearch</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendOneWireSearch</span><span class="token punctuation">(</span>ONEWIRE_SEARCH_REQUEST<span class="token punctuation">,</span> pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendOneWireAlarmsSearch</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendOneWireSearch</span><span class="token punctuation">(</span>ONEWIRE_SEARCH_ALARMS_REQUEST<span class="token punctuation">,</span> pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//needs to notify event handler</span>
<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendOneWireSearch</span><span class="token punctuation">(</span><span class="token keyword">char</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>onewireSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Onewire is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ONEWIRE_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendOneWireRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> devices<span class="token punctuation">,</span> <span class="token keyword">int</span> numBytesToRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> correlationId <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token function">ofRandomuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> b<span class="token punctuation">;</span>
	<span class="token function">sendOneWireRequest</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> ONEWIRE_READ_REQUEST_BIT<span class="token punctuation">,</span> devices<span class="token punctuation">,</span> numBytesToRead<span class="token punctuation">,</span> correlationId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendOneWireReset</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>
	<span class="token function">sendOneWireRequest</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> ONEWIRE_RESET_REQUEST_BIT<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendOneWireWrite</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> devices<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendOneWireRequest</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> ONEWIRE_WRITE_REQUEST_BIT<span class="token punctuation">,</span> devices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendOneWireDelay</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>
	<span class="token function">sendOneWireRequest</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> ONEWIRE_DELAY_REQUEST_BIT<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> delay<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendOneWireWriteAndRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> devices<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> numBytesToRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> correlationId <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token function">ofRandomuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendOneWireRequest</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> ONEWIRE_WRITE_REQUEST_BIT <span class="token operator">|</span> ONEWIRE_READ_REQUEST_BIT<span class="token punctuation">,</span> devices<span class="token punctuation">,</span> numBytesToRead<span class="token punctuation">,</span> correlationId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//// see http://firmata.org/wiki/Proposals#OneWire_Proposal</span>
<span class="token keyword">void</span>  ofArduino<span class="token operator">::</span><span class="token function">sendOneWireRequest</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> subcommand<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> devices<span class="token punctuation">,</span> <span class="token keyword">int</span> numBytesToRead<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> correlationId<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> delay<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> dataToWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">.</span>onewireSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Onewire is not supported for pin "</span> <span class="token operator">&lt;&lt;</span> pin<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> bytes<span class="token punctuation">;</span>
	bytes<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>devices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> numBytesToRead <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> correlationId <span class="token operator">||</span> delay <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> dataToWrite<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		subcommand <span class="token operator">=</span> subcommand <span class="token operator">|</span> ONEWIRE_WITHDATA_REQUEST_BITS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>devices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> devices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> devices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>numBytesToRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		bytes<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> numBytesToRead <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
		bytes<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>numBytesToRead <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>correlationId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		bytes<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> correlationId <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
		bytes<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>correlationId <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		bytes<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> delay <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
		bytes<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>delay <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
		bytes<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>delay <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
		bytes<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>delay <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>dataToWrite<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dataToWrite<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			bytes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>dataToWrite<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ONEWIRE_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>subcommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> shift <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> previous <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment" spellcheck="true">//i dont think this is safe</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bytes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>shift <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&</span> <span class="token number">0x7f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			shift<span class="token operator">++</span><span class="token punctuation">;</span>
			previous <span class="token operator">=</span> bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">sendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> shift<span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token operator">|</span> previous<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>shift <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">sendByte</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				shift <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				shift<span class="token operator">++</span><span class="token punctuation">;</span>
				previous <span class="token operator">=</span> bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> shift<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>shift <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>previous<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/********************************************
*
*
*				Encoder Functions
*
*
********************************************/</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">attachEncoder</span><span class="token punctuation">(</span><span class="token keyword">int</span> pinA<span class="token punctuation">,</span> <span class="token keyword">int</span> pinB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pinA<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPin</span><span class="token punctuation">(</span>pinB<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pinA<span class="token punctuation">]</span><span class="token punctuation">.</span>encoderSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Encoder Control is not supported for pin "</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pinA<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinCapabilities<span class="token punctuation">[</span>pinB<span class="token punctuation">]</span><span class="token punctuation">.</span>encoderSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Encoder Control is not supported for pin "</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pinB<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_encoderID <span class="token operator">&lt;</span> MAX_ENCODERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_ATTACH<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>_encoderID<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>pinA<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>pinB<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		_encoderID<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">getEncoderPosition</span><span class="token punctuation">(</span><span class="token keyword">int</span> encoderID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>encoderID <span class="token operator">&lt;=</span> _encoderID <span class="token operator">&&</span> encoderID <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_REPORT_POSITION<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>encoderID<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">getAllEncoderPositions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_REPORT_POSITIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">resetEncoderPosition</span><span class="token punctuation">(</span><span class="token keyword">int</span> encoderID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>encoderID <span class="token operator">&lt;=</span> _encoderID <span class="token operator">&&</span> encoderID <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_RESET_POSITION<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>encoderID<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">enableEncoderReporting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_REPORT_AUTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">disableEncoderReporting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_REPORT_AUTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">detachEncoder</span><span class="token punctuation">(</span><span class="token keyword">int</span> encoderID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>encoderID <span class="token operator">&lt;=</span> _encoderID <span class="token operator">&&</span> encoderID <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>ENCODER_DETACH<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>encoderID<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		_encoderID<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//if the buffer gets out of sync we have to purge everything to get back on track</span>
<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">purge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>_port<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/********************************************
*
*
*				Serial Functions
*
*
********************************************/</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">sendSerialConfig</span><span class="token punctuation">(</span>Firmata_Serial_Ports portID<span class="token punctuation">,</span> <span class="token keyword">int</span> baud<span class="token punctuation">,</span> <span class="token keyword">int</span> rxPin<span class="token punctuation">,</span> <span class="token keyword">int</span> txPin<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>portID <span class="token operator">></span> <span class="token number">7</span> <span class="token operator">&&</span> rxPin <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&&</span> txPin <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Both RX and TX pins must be defined when using Software Serial."</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_CONFIG <span class="token operator">|</span> portID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>baud <span class="token operator">&</span> <span class="token number">0x007F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>baud <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0x007F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>baud <span class="token operator">>></span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">&</span> <span class="token number">0x007F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>portID <span class="token operator">></span> <span class="token number">7</span> <span class="token operator">&&</span> rxPin <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&&</span> txPin <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>rxPin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sendByte</span><span class="token punctuation">(</span>txPin<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>portID <span class="token operator">></span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Both RX and TX pins must be defined when using Software Serial."</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">serialWrite</span><span class="token punctuation">(</span>Firmata_Serial_Ports portID<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> bytes<span class="token punctuation">,</span> <span class="token keyword">int</span> numOfBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_WRITE <span class="token operator">|</span> portID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numOfBytes<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">serialRead</span><span class="token punctuation">(</span>Firmata_Serial_Ports portID<span class="token punctuation">,</span> <span class="token keyword">int</span> maxBytesToRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_READ <span class="token operator">|</span> portID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>FIRMATA_SERIAL_READ_CONTINUOUS<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>maxBytesToRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sendValueAsTwo7bitBytes</span><span class="token punctuation">(</span>maxBytesToRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">serialStop</span><span class="token punctuation">(</span>Firmata_Serial_Ports portID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_READ <span class="token operator">|</span> portID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>FIRMATA_SERIAL_STOP_READING<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">serialClose</span><span class="token punctuation">(</span>Firmata_Serial_Ports portID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_CLOSE <span class="token operator">|</span> portID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">serialFlush</span><span class="token punctuation">(</span>Firmata_Serial_Ports portID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_FLUSH <span class="token operator">|</span> portID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> ofArduino<span class="token operator">::</span><span class="token function">serialListen</span><span class="token punctuation">(</span>Firmata_Serial_Ports portID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment" spellcheck="true">// listen only applies to software serial ports</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>portID <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>START_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_MESSAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>SERIAL_LISTEN <span class="token operator">|</span> portID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sendByte</span><span class="token punctuation">(</span>END_SYSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token comment" spellcheck="true">//this is mostly safe except for the teensy 2.0, it has 12 analog outs starting at 22 going down to 11</span>
<span class="token comment" spellcheck="true">//the problem arises if they mean digital pin 11 or analog pin 11 which are not the same</span>
<span class="token comment" spellcheck="true">//digital pin 11 is analog pin 10 and analog pin 11 is digital pin 22</span>
<span class="token keyword">bool</span> ofArduino<span class="token operator">::</span><span class="token function">isAnalogPin</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPin</span><span class="token punctuation">(</span><span class="token function">convertAnalogPinToDigital</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pin <span class="token operator">&lt;</span> _firstAnalogPin<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// this probably means they are using the Analog pin #</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>analogPinMap<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//the pin doesnt exist in the analog pin mapping</span>
				<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Analog is not supported for pin "</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token comment" spellcheck="true">//they are using the digital pin #</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>pinCapabilities<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Analog is not supported for pin "</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//this should only be false if the pin is negative or greater than the number of pins on the board</span>
<span class="token comment" spellcheck="true">//just incase we check against the pin capability map if for some reason a pin doesn't exist</span>
<span class="token comment" spellcheck="true">//pin 0 & 1 are outliers because they dont exist in the capability query but technically exist</span>
<span class="token comment" spellcheck="true">//we cant really use pin 0 & 1 though as it messes up the serial communication</span>
<span class="token keyword">bool</span> ofArduino<span class="token operator">::</span><span class="token function">isPin</span><span class="token punctuation">(</span><span class="token keyword">int</span> pin<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pin <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> pin <span class="token operator">></span> _totalDigitalPins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Pin "</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" does not exist on the current board"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pinCapabilities<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Pin "</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" does not exist on the current board"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//this returns the pin if its already not within the analog pin map</span>
<span class="token comment" spellcheck="true">//we need this to check between digital and analog pin mappings</span>
<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">convertAnalogPinToDigital</span><span class="token punctuation">(</span>size_t pin<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pin <span class="token operator">&lt;</span> analogPinMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>analogPinMap<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> analogPinMap<span class="token punctuation">[</span>pin<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Pin "</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is not an Analog Pin"</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> pin<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//this returns the pin if its already within the analog pin map</span>
<span class="token comment" spellcheck="true">//we need this to check between digital and analog pin mappings</span>
<span class="token keyword">int</span> ofArduino<span class="token operator">::</span><span class="token function">convertDigitalPinToAnalog</span><span class="token punctuation">(</span>size_t pin<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pin <span class="token operator">></span> analogPinMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> aPin <span class="token operator">:</span> analogPinMap<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>aPin<span class="token punctuation">.</span>second <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> aPin<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofArduino"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Pin "</span> <span class="token operator">+</span> <span class="token function">ofToString</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is not an Analog Pin"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> pin<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//this pin is already in the range of analog pins</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//these functions can't really account for user error </span>
</code></pre></div></div></div></div></div></div></div></div><script defer src="/_nuxt/payloads/1584626286009/openframeworks/communication/ofArduino_cpp/payload.js"></script><script src="/_nuxt/3213b67383225fc2f59b.js" defer></script><script src="/_nuxt/d1291586b31fa28ca9d5.js" defer></script><script src="/_nuxt/5fe5bba000836bc4a25f.js" defer></script><script src="/_nuxt/f8d94d1c92ade1d8a6da.js" defer></script><script src="/_nuxt/9a7e20c23e9625feab77.js" defer></script>
  </body>
</html>
