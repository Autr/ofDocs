<!doctype html>
<html data-n-head-ssr>
  <head>
    <meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" data-hid="keyword" name="keyword" content=""><meta data-n-head="ssr" property="og:description" content="" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="" vmid="og:image"><link rel="preload" href="/_nuxt/76844c096ee4b2a8e8b3.js" as="script"><link rel="preload" href="/_nuxt/561e36663ec83bdcd2ac.js" as="script"><link rel="preload" href="/_nuxt/fe12c0cb7395fa1032f4.css" as="style"><link rel="preload" href="/_nuxt/26c5a70906ce7aaac460.js" as="script"><link rel="preload" href="/_nuxt/75259d9b56378e7dbe47.css" as="style"><link rel="preload" href="/_nuxt/af3debaf278e0e1fd9de.js" as="script"><link rel="preload" href="/_nuxt/74971516fa343f955f83.css" as="style"><link rel="preload" href="/_nuxt/0128aba013e56fe5f14b.js" as="script"><link rel="stylesheet" href="/_nuxt/fe12c0cb7395fa1032f4.css"><link rel="stylesheet" href="/_nuxt/75259d9b56378e7dbe47.css"><link rel="stylesheet" href="/_nuxt/74971516fa343f955f83.css">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div id="app" class="unknown"><div id="menu"><h1 class="of"><div class="inner"><span><a href="/" class="nuxt-link-active"><div class="txt"><span class="docs f7 questrial">ofDocs </span><span class="version">0.11.0</span></div></a></span></div></h1><div id="search"><div class="inner"><div class="field text"><div class="field-inner"><svg viewbox="0 0 36 36" x="0px" y="0px" enable-background="new 0 0 36 36" xml:space="preserve"><path d="M35.525,31.228l-8.88-8.882c1.444-2.238,2.298-4.895,2.298-7.752c0-7.909-6.438-14.343-14.346-14.343						c-7.911,0-14.343,6.434-14.343,14.343c0,7.911,6.433,14.344,14.343,14.344c2.856,0,5.513-0.849,7.752-2.294l8.88,8.88						c0.295,0.297,0.782,0.297,1.076,0l3.22-3.221C35.824,32.008,35.824,31.523,35.525,31.228z M4.81,14.593						c0-5.396,4.391-9.788,9.788-9.788c5.398,0,9.787,4.392,9.787,9.788c0,5.398-4.389,9.789-9.787,9.789						C9.2,24.382,4.81,19.991,4.81,14.593z"></path></svg><!----><div class="text-wrapper"><input id="search_field" name="search_field" placeholder="Search (Alt+F)" autocomplete="off" tabindex="0"></div><!----><!----></div></div></div><div id="results" class="mt1"></div></div><div id="lists" class="menu-inner mt1"><div class="inner"><div class="item"><a href="/documentation/" title="/documentation/"><!----><span>documentation</span></a><!----></div><div class="item"><a href="/examples/" title="/examples/"><!----><span>examples</span></a><!----></div><div class="item"><a href="/openframeworks/" title="/openframeworks/" class="nuxt-link-active"><!----><span>openFrameworks</span></a><div class="list"><div class="item"><a href="/openframeworks/3d/" title="/openframeworks/3d/"><!----><span>3d</span></a><!----></div><div class="item"><a href="/openframeworks/app/" title="/openframeworks/app/"><!----><span>app</span></a><!----></div><div class="item"><a href="/openframeworks/communication/" title="/openframeworks/communication/" class="nuxt-link-active"><!----><span>communication</span></a><div class="list"><div class="item"><a href="/openframeworks/communication/ofArduino_cpp" title="/openframeworks/communication/ofArduino.cpp"><!----><span>ofArduino.cpp</span></a><!----></div><div class="item"><a href="/openframeworks/communication/ofArduino_h" title="/openframeworks/communication/ofArduino.h"><!----><span>ofArduino.h</span></a><!----></div><div class="item"><a href="/openframeworks/communication/ofSerial_cpp" title="/openframeworks/communication/ofSerial.cpp" class="nuxt-link-exact-active nuxt-link-active"><!----><span>ofSerial.cpp</span></a><div class="list"></div></div><div class="item"><a href="/openframeworks/communication/ofSerial_h" title="/openframeworks/communication/ofSerial.h"><!----><span>ofSerial.h</span></a><!----></div></div></div><div class="item"><a href="/openframeworks/events/" title="/openframeworks/events/"><!----><span>events</span></a><!----></div><div class="item"><a href="/openframeworks/gl/" title="/openframeworks/gl/"><!----><span>gl</span></a><!----></div><div class="item"><a href="/openframeworks/graphics/" title="/openframeworks/graphics/"><!----><span>graphics</span></a><!----></div><div class="item"><a href="/openframeworks/math/" title="/openframeworks/math/"><!----><span>math</span></a><!----></div><div class="item"><a href="/openframeworks/sound/" title="/openframeworks/sound/"><!----><span>sound</span></a><!----></div><div class="item"><a href="/openframeworks/types/" title="/openframeworks/types/"><!----><span>types</span></a><!----></div><div class="item"><a href="/openframeworks/utils/" title="/openframeworks/utils/"><!----><span>utils</span></a><!----></div><div class="item"><a href="/openframeworks/video/" title="/openframeworks/video/"><!----><span>video</span></a><!----></div></div></div><div class="item"><a href="/addons/" title="/addons/"><!----><span>addons</span></a><!----></div><div class="item"><a href="/guides/" title="/guides/"><!----><span>guides</span></a><!----></div></div></div></div><div id="document"><div id="renderer" class="main"><div absolute="/Users/Gilbert/Code/openFrameworks/libs/openFrameworks/communication/ofSerial.cpp" route="/openframeworks/communication/ofSerial.cpp" dir="../libs/openFrameworks/communication" ext="cpp" type="source" id="228" parent="225" siblings="" translations="[object Object]" class="doc-header"><div class="doc-header-inner"><div class="inner"><div class="mt2 mb2"><span class="breadcrumbs"><span class="crumb"><a href="/" class="pink nuxt-link-active">ofDocs</a><span class="chevron right"></span></span><span class="crumb"><a href="/openframeworks/" class="pink nuxt-link-active">openframeworks </a><!----><span class="chevron right"></span></span><span class="crumb"><a href="/openframeworks/communication/" class="pink nuxt-link-active">communication </a><!----><span class="chevron right"></span></span><span class="crumb"><!----><span class="link">ofSerial.cpp </span><!----></span></span></div></div></div></div><div id="code-page" class="markdown"><div id="side-menu"><!----><div id="see-also" filename="communication" absolute="/Users/Gilbert/Code/openFrameworks/libs/openFrameworks/communication" dir="../libs/openFrameworks" route="/openframeworks/communication/" ext="" type="folder" children="226,227,228,229" icon="language" parent="195" breadcrumbs="195" class="see-also"><h4>See also</h4><div class="also"><a href="/documentation/communication/"><span class="origin">documentation</span><span class="name">communication</span></a></div><div class="also"><a href="/examples/communication/"><span class="origin">examples</span><span class="name">communication</span></a></div></div></div><div id="code-render" id="code-inner"><div class="inner"><pre><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofSerial.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofUtils.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofLog.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX ) || defined( TARGET_LINUX )</span>
	<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span>
	<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;getopt.h></span></span>
	<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h></span></span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>


<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ctype.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_LINUX</span>
	<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/serial.h></span></span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>


<span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_WIN32</span>

<span class="token comment" spellcheck="true">// needed for serial bus enumeration:</span>
<span class="token comment" spellcheck="true">// 4d36e978-e325-11ce-bfc1-08002be10318}</span>
<span class="token function">DEFINE_GUID</span> <span class="token punctuation">(</span>GUID_SERENUM_BUS_ENUMERATOR<span class="token punctuation">,</span> <span class="token number">0x4D36E978</span><span class="token punctuation">,</span> <span class="token number">0xE325</span><span class="token punctuation">,</span>
<span class="token number">0x11CE</span><span class="token punctuation">,</span> <span class="token number">0xBF</span><span class="token punctuation">,</span> <span class="token number">0xC1</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x2B</span><span class="token punctuation">,</span> <span class="token number">0xE1</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> ofSerial<span class="token operator">::</span><span class="token function">enumerateWin32Ports</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>bPortsEnumerated <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	HDEVINFO hDevInfo <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	SP_DEVINFO_DATA DeviceInterfaceData<span class="token punctuation">;</span>
	DWORD dataType<span class="token punctuation">,</span> actualSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">// Reset Port List</span>
	nPorts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment" spellcheck="true">// Search device set</span>
	hDevInfo <span class="token operator">=</span> <span class="token function">SetupDiGetClassDevs</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> _GUID <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&</span>GUID_SERENUM_BUS_ENUMERATOR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DIGCF_PRESENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>hDevInfo<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> dataBuf<span class="token punctuation">[</span>MAX_PATH <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ZeroMemory</span><span class="token punctuation">(</span><span class="token operator">&</span>DeviceInterfaceData<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DeviceInterfaceData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			DeviceInterfaceData<span class="token punctuation">.</span>cbSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DeviceInterfaceData<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SetupDiEnumDeviceInfo</span><span class="token punctuation">(</span>hDevInfo<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&</span>DeviceInterfaceData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token comment" spellcheck="true">// SetupDiEnumDeviceInfo failed</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SetupDiGetDeviceRegistryPropertyA</span><span class="token punctuation">(</span>hDevInfo<span class="token punctuation">,</span>
											 <span class="token operator">&</span>DeviceInterfaceData<span class="token punctuation">,</span>
											 SPDRP_FRIENDLYNAME<span class="token punctuation">,</span>
											 <span class="token operator">&</span>dataType<span class="token punctuation">,</span>
											 dataBuf<span class="token punctuation">,</span>
											 <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dataBuf<span class="token punctuation">)</span><span class="token punctuation">,</span>
											 <span class="token operator">&</span>actualSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

			 <span class="token function">sprintf</span><span class="token punctuation">(</span>portNamesFriendly<span class="token punctuation">[</span>nPorts<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> dataBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			 portNamesShort<span class="token punctuation">[</span>nPorts<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

			 <span class="token comment" spellcheck="true">// turn blahblahblah(COM4) into COM4</span>

			 <span class="token keyword">char</span> <span class="token operator">*</span> begin <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
			 <span class="token keyword">char</span> <span class="token operator">*</span> end <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
			 begin <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dataBuf<span class="token punctuation">,</span> <span class="token string">"COM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			 <span class="token keyword">if</span><span class="token punctuation">(</span>begin<span class="token punctuation">)</span><span class="token punctuation">{</span>
				 end <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				 <span class="token keyword">if</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">{</span>
					 <span class="token operator">*</span>end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// get rid of the )...</span>
					 <span class="token function">strcpy</span><span class="token punctuation">(</span>portNamesShort<span class="token punctuation">[</span>nPorts<span class="token punctuation">]</span><span class="token punctuation">,</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
				 <span class="token punctuation">}</span>
				 <span class="token keyword">if</span><span class="token punctuation">(</span>nPorts<span class="token operator">++</span> <span class="token operator">></span> MAX_SERIAL_PORTS<span class="token punctuation">)</span>
					 <span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">SetupDiDestroyDeviceInfoList</span><span class="token punctuation">(</span>hDevInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

	bPortsEnumerated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">endif</span>  </span><span class="token comment" spellcheck="true">// TARGET_WIN32</span>



<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
ofSerial<span class="token operator">::</span><span class="token function">ofSerial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_WIN32</span>

		nPorts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		bPortsEnumerated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

		portNamesShort <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token punctuation">[</span>MAX_SERIAL_PORTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
		portNamesFriendly <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token punctuation">[</span>MAX_SERIAL_PORTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_SERIAL_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			portNamesShort<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			portNamesFriendly<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">else</span></span>

	fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	bHaveEnumeratedDevices <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	bInited <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
ofSerial<span class="token operator">::</span><span class="token operator">~</span><span class="token function">ofSerial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_WIN32</span>

		nPorts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		bPortsEnumerated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_SERIAL_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> portNamesShort<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> portNamesFriendly<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> portNamesShort<span class="token punctuation">;</span>
		<span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> portNamesFriendly<span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	bInited <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX )</span>
<span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">isDeviceArduino</span><span class="token punctuation">(</span> ofSerialDeviceInfo <span class="token operator">&</span> A <span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment" spellcheck="true">//TODO - this should be ofStringInString</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span><span class="token function">getDeviceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"usbserial"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span>
			<span class="token operator">||</span> <span class="token function">strstr</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span><span class="token function">getDeviceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"usbmodem"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">void</span> ofSerial<span class="token operator">::</span><span class="token function">buildDeviceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	deviceType <span class="token operator">=</span> <span class="token string">"serial"</span><span class="token punctuation">;</span>
	devices<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	vector <span class="token operator">&lt;</span>string<span class="token operator">></span> prefixMatch<span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_OSX</span>

		prefixMatch<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">"cu."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		prefixMatch<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">"tty."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_LINUX</span>

		prefixMatch<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">"ttyACM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		prefixMatch<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">"ttyS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		prefixMatch<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">"ttyUSB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		prefixMatch<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">"rfc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX ) || defined( TARGET_LINUX )</span>
		ofDirectory <span class="token function">dir</span><span class="token punctuation">(</span><span class="token string">"/dev"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> deviceCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&</span> entry<span class="token operator">:</span> dir<span class="token punctuation">)</span><span class="token punctuation">{</span>
			std<span class="token operator">::</span>string deviceName <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment" spellcheck="true">//we go through the prefixes</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&</span> prefix<span class="token operator">:</span> prefixMatch<span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token comment" spellcheck="true">//if the device name is longer than the prefix</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> prefix<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token comment" spellcheck="true">//do they match ?</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> prefix<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> prefix<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
						devices<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">ofSerialDeviceInfo</span><span class="token punctuation">(</span><span class="token string">"/dev/"</span><span class="token operator">+</span>deviceName<span class="token punctuation">,</span> deviceName<span class="token punctuation">,</span> deviceCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						deviceCount<span class="token operator">++</span><span class="token punctuation">;</span>
						<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_WIN32</span>

		<span class="token function">enumerateWin32Ports</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ofLogNotice</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"found "</span> <span class="token operator">&lt;&lt;</span> nPorts <span class="token operator">&lt;&lt;</span> <span class="token string">" devices"</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nPorts<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token comment" spellcheck="true">//NOTE: we give the short port name for both as that is what the user should pass and the short name is more friendly</span>
			devices<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">ofSerialDeviceInfo</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>portNamesShort<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>portNamesFriendly<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX )</span>
		<span class="token comment" spellcheck="true">//here we sort the device to have the aruino ones first.</span>
		<span class="token function">partition</span><span class="token punctuation">(</span>devices<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> devices<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isDeviceArduino<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment" spellcheck="true">//we are reordering the device ids. too!</span>
		<span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&</span> device<span class="token operator">:</span> devices<span class="token punctuation">)</span><span class="token punctuation">{</span>
			device<span class="token punctuation">.</span>deviceID <span class="token operator">=</span> k<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	bHaveEnumeratedDevices <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">void</span> ofSerial<span class="token operator">::</span><span class="token function">listDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">buildDeviceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&</span> device<span class="token operator">:</span> devices<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogNotice</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> device<span class="token punctuation">.</span><span class="token function">getDeviceID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"] = "</span><span class="token operator">&lt;&lt;</span> device<span class="token punctuation">.</span><span class="token function">getDeviceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
vector <span class="token operator">&lt;</span>ofSerialDeviceInfo<span class="token operator">></span> ofSerial<span class="token operator">::</span><span class="token function">getDeviceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">buildDeviceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> devices<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">void</span> ofSerial<span class="token operator">::</span><span class="token function">enumerateDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">listDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">void</span> ofSerial<span class="token operator">::</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_WIN32</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>bInited<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">SetCommTimeouts</span><span class="token punctuation">(</span>hComm<span class="token punctuation">,</span> <span class="token operator">&</span>oldTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hComm<span class="token punctuation">)</span><span class="token punctuation">;</span>
			hComm <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span>
			bInited <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">else</span></span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>bInited<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TCSANOW<span class="token punctuation">,</span> <span class="token operator">&</span>oldoptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token operator">::</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			bInited <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment" spellcheck="true">// [CHECK] -- anything else need to be reset?</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofSerial<span class="token operator">::</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// the first one, at 9600 is a good choice...</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofSerial<span class="token operator">::</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">int</span> deviceNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> baud<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">buildDeviceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>deviceNumber <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>devices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">setup</span><span class="token punctuation">(</span>devices<span class="token punctuation">[</span>deviceNumber<span class="token punctuation">]</span><span class="token punctuation">.</span>devicePath<span class="token punctuation">,</span> baud<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"couldn't find device "</span> <span class="token operator">&lt;&lt;</span> deviceNumber <span class="token operator">&lt;&lt;</span> <span class="token string">", only "</span> <span class="token operator">&lt;&lt;</span> devices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" devices found"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofSerial<span class="token operator">::</span><span class="token function">setup</span><span class="token punctuation">(</span>string portName<span class="token punctuation">,</span> <span class="token keyword">int</span> baud<span class="token punctuation">)</span><span class="token punctuation">{</span>
	bInited <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX ) || defined( TARGET_LINUX )</span>

		<span class="token comment" spellcheck="true">//lets account for the name being passed in instead of the device path</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>portName<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">5</span> <span class="token operator">&&</span> portName<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"/dev/"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			portName <span class="token operator">=</span> <span class="token string">"/dev/"</span> <span class="token operator">+</span> portName<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">ofLogNotice</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"opening "</span> <span class="token operator">&lt;&lt;</span> portName <span class="token operator">&lt;&lt;</span> <span class="token string">" @ "</span> <span class="token operator">&lt;&lt;</span> baud <span class="token operator">&lt;&lt;</span> <span class="token string">" bps"</span><span class="token punctuation">;</span>
		fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>portName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_NOCTTY <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"unable to open "</span> <span class="token operator">&lt;&lt;</span> portName<span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">struct</span> termios options<span class="token punctuation">;</span>
		<span class="token function">tcgetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&</span>oldoptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
		options <span class="token operator">=</span> oldoptions<span class="token punctuation">;</span>
		<span class="token keyword">switch</span><span class="token punctuation">(</span>baud<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">300</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B300<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B300<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">1200</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B1200<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B1200<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">2400</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B2400<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B2400<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">4800</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B4800<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B4800<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">9600</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B9600<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B9600<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">14400</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B14400<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B14400<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">19200</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B19200<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B19200<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">28800</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B28800<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B28800<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">38400</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B38400<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B38400<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">57600</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B57600<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B57600<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">115200</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B115200<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B115200<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">230400</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B230400<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B230400<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">case</span> <span class="token number">12000000</span><span class="token operator">:</span> 
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> <span class="token number">12000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> <span class="token number">12000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		   <span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B9600<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token operator">&</span>options<span class="token punctuation">,</span> B9600<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"setup(): cannot set "</span> <span class="token operator">&lt;&lt;</span> baud <span class="token operator">&lt;&lt;</span> <span class="token string">" bps, setting to 9600"</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		options<span class="token punctuation">.</span>c_cflag <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>CLOCAL <span class="token operator">|</span> CREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
		options<span class="token punctuation">.</span>c_cflag <span class="token operator">&</span><span class="token operator">=</span> <span class="token operator">~</span>PARENB<span class="token punctuation">;</span>
		options<span class="token punctuation">.</span>c_cflag <span class="token operator">&</span><span class="token operator">=</span> <span class="token operator">~</span>CSTOPB<span class="token punctuation">;</span>
		options<span class="token punctuation">.</span>c_cflag <span class="token operator">&</span><span class="token operator">=</span> <span class="token operator">~</span>CSIZE<span class="token punctuation">;</span>
		options<span class="token punctuation">.</span>c_iflag <span class="token operator">&</span><span class="token operator">=</span> <span class="token punctuation">(</span>tcflag_t<span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">(</span>INLCR <span class="token operator">|</span> IGNCR <span class="token operator">|</span> ICRNL <span class="token operator">|</span> IGNBRK<span class="token punctuation">)</span><span class="token punctuation">;</span>
		options<span class="token punctuation">.</span>c_oflag <span class="token operator">&</span><span class="token operator">=</span> <span class="token punctuation">(</span>tcflag_t<span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">(</span>OPOST<span class="token punctuation">)</span><span class="token punctuation">;</span>
		options<span class="token punctuation">.</span>c_cflag <span class="token operator">|</span><span class="token operator">=</span> CS8<span class="token punctuation">;</span>
		<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_LINUX )</span>
			options<span class="token punctuation">.</span>c_cflag <span class="token operator">|</span><span class="token operator">=</span> CRTSCTS<span class="token punctuation">;</span>
			options<span class="token punctuation">.</span>c_lflag <span class="token operator">&</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>ICANON <span class="token operator">|</span> ECHO <span class="token operator">|</span> ISIG<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token macro property">#<span class="token directive keyword">endif</span></span>
		<span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TCSANOW<span class="token punctuation">,</span> <span class="token operator">&</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_LINUX</span>
			<span class="token keyword">struct</span> serial_struct kernel_serial_settings<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TIOCGSERIAL<span class="token punctuation">,</span> <span class="token operator">&</span>kernel_serial_settings<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				kernel_serial_settings<span class="token punctuation">.</span>flags <span class="token operator">|</span><span class="token operator">=</span> ASYNC_LOW_LATENCY<span class="token punctuation">;</span>
				<span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TIOCSSERIAL<span class="token punctuation">,</span> <span class="token operator">&</span>kernel_serial_settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token macro property">#<span class="token directive keyword">endif</span></span>
		bInited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token function">ofLogNotice</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"opened "</span> <span class="token operator">&lt;&lt;</span> portName <span class="token operator">&lt;&lt;</span> <span class="token string">" sucessfully @ "</span> <span class="token operator">&lt;&lt;</span> baud <span class="token operator">&lt;&lt;</span> <span class="token string">" bps"</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">elif</span> defined( TARGET_WIN32 )</span>

		<span class="token keyword">char</span> pn<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>portName<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> num<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>portName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"COM%d"</span><span class="token punctuation">,</span> <span class="token operator">&</span>num<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token comment" spellcheck="true">// Microsoft KB115831 a.k.a if COM > COM9 you have to use a different</span>
			<span class="token comment" spellcheck="true">// syntax</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>pn<span class="token punctuation">,</span> <span class="token string">"\\\\.\\COM%d"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">strncpy</span><span class="token punctuation">(</span>pn<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>portName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>portName<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment" spellcheck="true">// open the serial port:</span>
		<span class="token comment" spellcheck="true">// "COM4", etc...</span>

		hComm <span class="token operator">=</span> <span class="token function">CreateFileA</span><span class="token punctuation">(</span>pn<span class="token punctuation">,</span> GENERIC_READ<span class="token operator">|</span>GENERIC_WRITE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
							OPEN_EXISTING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>hComm <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"setup(): unable to open "</span> <span class="token operator">&lt;&lt;</span> portName<span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>


		<span class="token comment" spellcheck="true">// now try the settings:</span>
		COMMCONFIG cfg<span class="token punctuation">;</span>
		DWORD cfgSize<span class="token punctuation">;</span>
		WCHAR buf<span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		cfgSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GetCommConfig</span><span class="token punctuation">(</span>hComm<span class="token punctuation">,</span> <span class="token operator">&</span>cfg<span class="token punctuation">,</span> <span class="token operator">&</span>cfgSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> bps <span class="token operator">=</span> baud<span class="token punctuation">;</span>
		<span class="token function">swprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> L<span class="token string">"baud=%d parity=N data=8 stop=1"</span><span class="token punctuation">,</span> bps<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">BuildCommDCBW</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&</span>cfg<span class="token punctuation">.</span>dcb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"setup(): unable to build comm dcb, ("</span> <span class="token operator">&lt;&lt;</span> buf <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment" spellcheck="true">// Set baudrate and bits etc.</span>
		<span class="token comment" spellcheck="true">// Note that BuildCommDCB() clears XON/XOFF and hardware control by default</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SetCommState</span><span class="token punctuation">(</span>hComm<span class="token punctuation">,</span> <span class="token operator">&</span>cfg<span class="token punctuation">.</span>dcb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"setup(): couldn't set comm state: "</span> <span class="token operator">&lt;&lt;</span> cfg<span class="token punctuation">.</span>dcb<span class="token punctuation">.</span>BaudRate <span class="token operator">&lt;&lt;</span> <span class="token string">" bps, xio "</span> <span class="token operator">&lt;&lt;</span> cfg<span class="token punctuation">.</span>dcb<span class="token punctuation">.</span>fInX <span class="token operator">&lt;&lt;</span> <span class="token string">"/"</span> <span class="token operator">&lt;&lt;</span> cfg<span class="token punctuation">.</span>dcb<span class="token punctuation">.</span>fOutX<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment" spellcheck="true">//ofLogNotice("ofSerial") &lt;&lt; "bps=" &lt;&lt; cfg.dcb.BaudRate &lt;&lt; ", xio=" &lt;&lt; cfg.dcb.fInX &lt;&lt; "/" &lt;&lt; cfg.dcb.fOutX;</span>

		<span class="token comment" spellcheck="true">// Set communication timeouts (NT)</span>
		COMMTIMEOUTS tOut<span class="token punctuation">;</span>
		<span class="token function">GetCommTimeouts</span><span class="token punctuation">(</span>hComm<span class="token punctuation">,</span> <span class="token operator">&</span>oldTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
		tOut <span class="token operator">=</span> oldTimeout<span class="token punctuation">;</span>
		<span class="token comment" spellcheck="true">// Make timeout so that:</span>
		<span class="token comment" spellcheck="true">// - return immediately with buffered characters</span>
		tOut<span class="token punctuation">.</span>ReadIntervalTimeout <span class="token operator">=</span> MAXDWORD<span class="token punctuation">;</span>
		tOut<span class="token punctuation">.</span>ReadTotalTimeoutMultiplier <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		tOut<span class="token punctuation">.</span>ReadTotalTimeoutConstant <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">SetCommTimeouts</span><span class="token punctuation">(</span>hComm<span class="token punctuation">,</span> <span class="token operator">&</span>tOut<span class="token punctuation">)</span><span class="token punctuation">;</span>

		bInited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">else</span></span>

		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"not implemented in this platform"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">long</span> ofSerial<span class="token operator">::</span><span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> buffer<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bInited<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"writeBytes(): serial not inited"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX ) || defined( TARGET_LINUX )</span>
		size_t written<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		fd_set wfds<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> timeval tv<span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>written <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">auto</span> n <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer <span class="token operator">+</span> written<span class="token punctuation">,</span> length <span class="token operator">-</span> written<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&&</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN <span class="token operator">||</span> errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">)</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token comment" spellcheck="true">//printf("Write, n = %d\n", n);</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				written <span class="token operator">+</span><span class="token operator">=</span> n<span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
				tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&</span>wfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">FD_SET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&</span>wfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
				n <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>fd<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&</span>wfds<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&</span>tv<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&&</span> errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> written<span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">elif</span> defined(TARGET_WIN32)</span>

		DWORD written<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>hComm<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token operator">&</span>written<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			 <span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"writeBytes(): couldn't write to port"</span><span class="token punctuation">;</span>
			 <span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span>  <span class="token string">"wrote "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> written <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>written<span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">else</span></span>

		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">long</span> ofSerial<span class="token operator">::</span><span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> buffer<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofSerial<span class="token operator">::</span><span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token keyword">char</span> singleByte<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">(</span>singleByte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">long</span> ofSerial<span class="token operator">::</span><span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token keyword">const</span> ofBuffer <span class="token operator">&</span> buffer<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">writeBytes</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">long</span> ofSerial<span class="token operator">::</span><span class="token function">readBytes</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> buffer<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bInited<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"readBytes(): serial not inited"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX ) || defined( TARGET_LINUX )</span>

		<span class="token keyword">auto</span> nRead <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>nRead <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span> errno <span class="token operator">==</span> EAGAIN <span class="token punctuation">)</span>
				<span class="token keyword">return</span> OF_SERIAL_NO_DATA<span class="token punctuation">;</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"readBytes(): couldn't read from port: "</span> <span class="token operator">&lt;&lt;</span> errno <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> nRead<span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">elif</span> defined( TARGET_WIN32 )</span>

		DWORD nRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>hComm<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token operator">&</span>nRead<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"readBytes(): couldn't read from port"</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>nRead<span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">else</span></span>

		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"not defined in this platform"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">long</span> ofSerial<span class="token operator">::</span><span class="token function">readBytes</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> buffer<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">readBytes</span><span class="token punctuation">(</span><span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">long</span> ofSerial<span class="token operator">::</span><span class="token function">readBytes</span><span class="token punctuation">(</span>ofBuffer <span class="token operator">&</span> buffer<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">{</span>
	buffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">readBytes</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofSerial<span class="token operator">::</span><span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> singleByte<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bInited<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"writeByte(): serial not inited"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token operator">&</span>singleByte<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">int</span> ofSerial<span class="token operator">::</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bInited<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"readByte(): serial not inited"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> tmpByte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX ) || defined( TARGET_LINUX )</span>

		<span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&</span>tmpByte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>nRead <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span> errno <span class="token operator">==</span> EAGAIN <span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">return</span> OF_SERIAL_NO_DATA<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"readByte(): couldn't read from port: "</span> <span class="token operator">&lt;&lt;</span> errno <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>nRead <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> OF_SERIAL_NO_DATA<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">elif</span> defined( TARGET_WIN32 )</span>

		DWORD nRead<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>hComm<span class="token punctuation">,</span> <span class="token operator">&</span>tmpByte<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&</span>nRead<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"readByte(): couldn't read from port"</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	
		<span class="token keyword">if</span><span class="token punctuation">(</span>nRead <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> OF_SERIAL_NO_DATA<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">else</span></span>

		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"not defined in this platform"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token keyword">return</span> tmpByte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//----------------------------------------------------------------</span>
<span class="token keyword">void</span> ofSerial<span class="token operator">::</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">bool</span> flushIn<span class="token punctuation">,</span> <span class="token keyword">bool</span> flushOut<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bInited<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"flush(): serial not inited"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX ) || defined( TARGET_LINUX )</span>
		<span class="token keyword">int</span> flushType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>flushIn <span class="token operator">&&</span> flushOut<span class="token punctuation">)</span> flushType <span class="token operator">=</span> TCIOFLUSH<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flushIn<span class="token punctuation">)</span> flushType <span class="token operator">=</span> TCIFLUSH<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flushOut<span class="token punctuation">)</span> flushType <span class="token operator">=</span> TCOFLUSH<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

		<span class="token function">tcflush</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> flushType<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property">#<span class="token directive keyword">elif</span> defined( TARGET_WIN32 )</span>

		<span class="token keyword">int</span> flushType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>flushIn <span class="token operator">&&</span> flushOut<span class="token punctuation">)</span> flushType <span class="token operator">=</span> PURGE_TXCLEAR <span class="token operator">|</span> PURGE_RXCLEAR<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flushIn<span class="token punctuation">)</span> flushType <span class="token operator">=</span> PURGE_RXCLEAR<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flushOut<span class="token punctuation">)</span> flushType <span class="token operator">=</span> PURGE_TXCLEAR<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

		<span class="token function">PurgeComm</span><span class="token punctuation">(</span>hComm<span class="token punctuation">,</span> flushType<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofSerial<span class="token operator">::</span><span class="token function">drain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bInited<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"drain(): serial not inited"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX ) || defined( TARGET_LINUX )</span>

		<span class="token function">tcdrain</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//-------------------------------------------------------------</span>
<span class="token keyword">int</span> ofSerial<span class="token operator">::</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bInited<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofSerial"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"available(): serial not inited"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> OF_SERIAL_ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> numBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">if</span> defined( TARGET_OSX ) || defined( TARGET_LINUX )</span>

		<span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> FIONREAD<span class="token punctuation">,</span> <span class="token operator">&</span>numBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_WIN32</span>

		COMSTAT stat<span class="token punctuation">;</span>
		DWORD err<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>hComm<span class="token operator">!=</span>INVALID_HANDLE_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ClearCommError</span><span class="token punctuation">(</span>hComm<span class="token punctuation">,</span> <span class="token operator">&</span>err<span class="token punctuation">,</span> <span class="token operator">&</span>stat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				numBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				numBytes <span class="token operator">=</span> stat<span class="token punctuation">.</span>cbInQue<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			numBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		 <span class="token punctuation">}</span>

	<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token keyword">return</span> numBytes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> ofSerial<span class="token operator">::</span><span class="token function">isInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> bInited<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div></div></div></div></div></div><script defer src="/_nuxt/payloads/1583511283766/openframeworks/communication/ofSerial_cpp/payload.js"></script><script src="/_nuxt/76844c096ee4b2a8e8b3.js" defer></script><script src="/_nuxt/0128aba013e56fe5f14b.js" defer></script><script src="/_nuxt/561e36663ec83bdcd2ac.js" defer></script><script src="/_nuxt/26c5a70906ce7aaac460.js" defer></script><script src="/_nuxt/af3debaf278e0e1fd9de.js" defer></script>
  </body>
</html>
