<!doctype html>
<html data-n-head-ssr>
  <head>
    <title>ofOpenALSoundPlayer.cpp | openframeworks | ofDocs</title><meta data-n-head="ssr" data-hid="description" name="description" content="openFrameworks documentation and examples browser"><meta data-n-head="ssr" data-hid="keyword" name="keyword" content=""><meta data-n-head="ssr" property="og:description" content="openFrameworks documentation and examples browser" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="ofOpenALSoundPlayer.cpp | openframeworks | ofDocs" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="/files/images/ofw-logo.png" vmid="og:image"><link rel="preload" href="/_nuxt/5f71eaca0bd2f1a0f939.js" as="script"><link rel="preload" href="/_nuxt/906a3ca0fb13ed3c6651.js" as="script"><link rel="preload" href="/_nuxt/fe12c0cb7395fa1032f4.css" as="style"><link rel="preload" href="/_nuxt/b673915e8a08acf593e8.js" as="script"><link rel="preload" href="/_nuxt/46e8fcacdadb233d9fb6.css" as="style"><link rel="preload" href="/_nuxt/bf355f21967a23c26c07.js" as="script"><link rel="preload" href="/_nuxt/35a90d914f539af1362f.js" as="script"><link rel="stylesheet" href="/_nuxt/fe12c0cb7395fa1032f4.css"><link rel="stylesheet" href="/_nuxt/46e8fcacdadb233d9fb6.css">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div id="app"><div id="menu"><div class="menu-inner"><div id="settings"></div><h1 class="of"><div class="inner"><span><a href="/" class="nuxt-link-active"><svg version="1.1" viewbox="0 0 110 58" width="110px" height="58px" enable-background="0 0 110 58" xml:space="preserve" class="logo"><g><path d="M58,29 C58,13 45,0 29,0 C13,0 0,13 0,29 C0,45 13,58 29,58 C45,58 58,45 58,29 Z"></path><rect x="59" y="0" width="25" height="58"></rect><rect x="85" y="26" width="15" height="15"></rect><path d="M85,0 L110,0 L85,25 L85,0 Z"></path></g></svg><div class="txt"><span class="docs f7 questrial">Docs </span><span class="version">0.11.0</span></div></a></span></div></h1><div id="search"><div class="inner"><div class="field text"><div class="field-inner"><svg viewbox="0 0 36 36" enable-background="new 0 0 36 36" xml:space="preserve"><path d="M35.525,31.228l-8.88-8.882c1.444-2.238,2.298-4.895,2.298-7.752c0-7.909-6.438-14.343-14.346-14.343							c-7.911,0-14.343,6.434-14.343,14.343c0,7.911,6.433,14.344,14.343,14.344c2.856,0,5.513-0.849,7.752-2.294l8.88,8.88							c0.295,0.297,0.782,0.297,1.076,0l3.22-3.221C35.824,32.008,35.824,31.523,35.525,31.228z M4.81,14.593							c0-5.396,4.391-9.788,9.788-9.788c5.398,0,9.787,4.392,9.787,9.788c0,5.398-4.389,9.789-9.787,9.789							C9.2,24.382,4.81,19.991,4.81,14.593z"></path></svg><!----><div class="text-wrapper"><input id="search_field" name="search_field" placeholder="Search (Alt+F)" autocomplete="off" tabindex="0"></div><!----><!----></div></div></div><!----></div><div id="lists" class="menu-inner mt1 mb2"><div class="inner"></div></div></div><div class="menu-bottom"><div class="inner"><button class="button"><!----><span><span class="ico">nights_stay</span></span></button></div></div></div><div id="document"><div id="renderer" class="main source"><div absolute="/Users/Gilbert/Code/openFrameworks/libs/openFrameworks/sound/ofOpenALSoundPlayer.cpp" route="/openframeworks/sound/ofOpenALSoundPlayer.cpp" dir="../libs/openFrameworks/sound" ext="cpp" type="source" id="272" parent="269" siblings="" translations="[object Object]" class="doc-header"><div class="doc-header-inner"><div class="inner"><span class="breadcrumbs"><span class="crumb"><a href="/" class="pink nuxt-link-active">ofDocs</a><span class="chevron right"></span></span><span class="crumb"><a href="/openframeworks/" class="pink nuxt-link-active">openframeworks </a><!----><span class="chevron right"></span></span><span class="crumb"><a href="/openframeworks/sound/" class="pink nuxt-link-active">sound </a><!----><span class="chevron right"></span></span><span class="crumb"><!----><span class="link selector"><span class="name">ofOpenALSoundPlayer.cpp</span><span class="chevron bottom"></span><select><option value="/openframeworks/sound/ofFmodSoundPlayer_cpp">ofFmodSoundPlayer.cpp</option><option value="/openframeworks/sound/ofFmodSoundPlayer_h">ofFmodSoundPlayer.h</option><option value="/openframeworks/sound/ofOpenALSoundPlayer_cpp">ofOpenALSoundPlayer.cpp</option><option value="/openframeworks/sound/ofOpenALSoundPlayer_h">ofOpenALSoundPlayer.h</option><option value="/openframeworks/sound/ofRtAudioSoundStream_cpp">ofRtAudioSoundStream.cpp</option><option value="/openframeworks/sound/ofRtAudioSoundStream_h">ofRtAudioSoundStream.h</option><option value="/openframeworks/sound/ofSoundBaseTypes_cpp">ofSoundBaseTypes.cpp</option><option value="/openframeworks/sound/ofSoundBaseTypes_h">ofSoundBaseTypes.h</option><option value="/openframeworks/sound/ofSoundBuffer_cpp">ofSoundBuffer.cpp</option><option value="/openframeworks/sound/ofSoundBuffer_h">ofSoundBuffer.h</option><option value="/openframeworks/sound/ofSoundPlayer_cpp">ofSoundPlayer.cpp</option><option value="/openframeworks/sound/ofSoundPlayer_h">ofSoundPlayer.h</option><option value="/openframeworks/sound/ofSoundStream_cpp">ofSoundStream.cpp</option><option value="/openframeworks/sound/ofSoundStream_h">ofSoundStream.h</option><option value="/openframeworks/sound/ofSoundUtils_h">ofSoundUtils.h</option></select></span><!----></span></span></div></div></div><div id="code-page" static="true"><div id="side-menu"><div id="code-sources"><h4 class="f3 dropdown-toggle">Sources</h4><div class="srcsiblings dropdown-area"><a href="/openframeworks/sound/ofFmodSoundPlayer_cpp" class="block"><span class="src">src </span><span class="name">ofFmodSoundPlayer.cpp </span></a><a href="/openframeworks/sound/ofFmodSoundPlayer_h" class="block"><span class="src">src </span><span class="name">ofFmodSoundPlayer.h </span></a><a href="/openframeworks/sound/ofOpenALSoundPlayer_cpp" class="block nuxt-link-exact-active nuxt-link-active current"><span class="src">src </span><span class="name">ofOpenALSoundPlayer.cpp </span></a><a href="/openframeworks/sound/ofOpenALSoundPlayer_h" class="block"><span class="src">src </span><span class="name">ofOpenALSoundPlayer.h </span></a><a href="/openframeworks/sound/ofRtAudioSoundStream_cpp" class="block"><span class="src">src </span><span class="name">ofRtAudioSoundStream.cpp </span></a><a href="/openframeworks/sound/ofRtAudioSoundStream_h" class="block"><span class="src">src </span><span class="name">ofRtAudioSoundStream.h </span></a><a href="/openframeworks/sound/ofSoundBaseTypes_cpp" class="block"><span class="src">src </span><span class="name">ofSoundBaseTypes.cpp </span></a><a href="/openframeworks/sound/ofSoundBaseTypes_h" class="block"><span class="src">src </span><span class="name">ofSoundBaseTypes.h </span></a><a href="/openframeworks/sound/ofSoundBuffer_cpp" class="block"><span class="src">src </span><span class="name">ofSoundBuffer.cpp </span></a><a href="/openframeworks/sound/ofSoundBuffer_h" class="block"><span class="src">src </span><span class="name">ofSoundBuffer.h </span></a><a href="/openframeworks/sound/ofSoundPlayer_cpp" class="block"><span class="src">src </span><span class="name">ofSoundPlayer.cpp </span></a><a href="/openframeworks/sound/ofSoundPlayer_h" class="block"><span class="src">src </span><span class="name">ofSoundPlayer.h </span></a><a href="/openframeworks/sound/ofSoundStream_cpp" class="block"><span class="src">src </span><span class="name">ofSoundStream.cpp </span></a><a href="/openframeworks/sound/ofSoundStream_h" class="block"><span class="src">src </span><span class="name">ofSoundStream.h </span></a><a href="/openframeworks/sound/ofSoundUtils_h" class="block"><span class="src">src </span><span class="name">ofSoundUtils.h </span></a></div></div><div id="comments" class="dropdown-area"><h4 class="f3 dropdown-toggle">Comments</h4><div class="dropdown-area"></div></div><div filename="sound" absolute="/Users/Gilbert/Code/openFrameworks/libs/openFrameworks/sound" dir="../libs/openFrameworks" route="/openframeworks/sound/" ext="" type="folder" id="269" children="270,271,272,273,274,275,276,277,278,279,280,281,282,283,284" icon="volume_up" parent="164" breadcrumbs="164" class="see-also"><h4 class="f3">See also</h4><div class="also"><a href="/documentation/sound/"><span class="origin">documentation</span><span class="name">sound</span></a></div><div class="also"><a href="/examples/sound/soundPlayerFFTExample/"><span class="origin">examples</span><span class="name">soundPlayerFFTExample</span></a></div><div class="also"><a href="/examples/sound/soundPlayerExample/"><span class="origin">examples</span><span class="name">soundPlayerExample</span></a></div><div class="also"><a href="/examples/sound/soundBufferExample/"><span class="origin">examples</span><span class="name">soundBufferExample</span></a></div><div class="also"><a href="/examples/sound/"><span class="origin">examples</span><span class="name">sound</span></a></div><div class="also"><a href="/examples/ios/soundPlayerExample/"><span class="origin">examples</span><span class="name">soundPlayerExample</span></a></div></div></div><div id="code-render"><div class="inner"><pre><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofOpenALSoundPlayer.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_SOUND_PLAYER_OPENAL</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofConstants.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"glm/gtc/constants.hpp"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"glm/common.hpp"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofLog.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofEvents.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sndfile.h></span></span>

<span class="token macro property">#<span class="token directive keyword">if</span> defined (TARGET_OF_IOS) || defined (TARGET_OSX)</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;OpenAL/al.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;OpenAL/alc.h></span></span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;AL/al.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;AL/alc.h></span></span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpg123.h></span></span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">static</span> ALCdevice <span class="token operator">*</span> alDevice <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ALCcontext <span class="token operator">*</span> alContext <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> ofOpenALSoundPlayer<span class="token operator">::</span>window<span class="token punctuation">;</span>
<span class="token keyword">float</span> ofOpenALSoundPlayer<span class="token operator">::</span>windowSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>


kiss_fftr_cfg ofOpenALSoundPlayer<span class="token operator">::</span>systemFftCfg<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> ofOpenALSoundPlayer<span class="token operator">::</span>systemWindowedSignal<span class="token punctuation">;</span>
vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> ofOpenALSoundPlayer<span class="token operator">::</span>systemBins<span class="token punctuation">;</span>
vector<span class="token operator">&lt;</span>kiss_fft_cpx<span class="token operator">></span> ofOpenALSoundPlayer<span class="token operator">::</span>systemCx_out<span class="token punctuation">;</span>

<span class="token keyword">static</span> set<span class="token operator">&lt;</span>ofOpenALSoundPlayer<span class="token operator">*</span><span class="token operator">></span> <span class="token operator">&</span> <span class="token function">players</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">static</span> set<span class="token operator">&lt;</span>ofOpenALSoundPlayer<span class="token operator">*</span><span class="token operator">></span> <span class="token operator">*</span> players <span class="token operator">=</span> <span class="token keyword">new</span> set<span class="token operator">&lt;</span>ofOpenALSoundPlayer<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">*</span>players<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ofOpenALSoundUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">alcProcessContext</span><span class="token punctuation">(</span>alContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
<span class="token comment" spellcheck="true">// from http://devmaster.net/posts/2893/openal-lesson-6-advanced-loading-and-error-handles</span>
<span class="token keyword">static</span> string <span class="token function">getALErrorString</span><span class="token punctuation">(</span>ALenum error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> AL_NO_ERROR<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"AL_NO_ERROR"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> AL_INVALID_NAME<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"AL_INVALID_NAME"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> AL_INVALID_ENUM<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"AL_INVALID_ENUM"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> AL_INVALID_VALUE<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"AL_INVALID_VALUE"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> AL_INVALID_OPERATION<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"AL_INVALID_OPERATION"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> AL_OUT_OF_MEMORY<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"AL_OUT_OF_MEMORY"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token string">"UNKWOWN_ERROR"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> string <span class="token function">getALCErrorString</span><span class="token punctuation">(</span>ALCenum  error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ALC_NO_ERROR<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"ALC_NO_ERROR"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ALC_INVALID_DEVICE<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"ALC_INVALID_DEVICE"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ALC_INVALID_CONTEXT<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"ALC_INVALID_CONTEXT"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ALC_INVALID_ENUM<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"ALC_INVALID_ENUM"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ALC_INVALID_VALUE<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"ALC_INVALID_VALUE"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ALC_OUT_OF_MEMORY<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"ALC_OUT_OF_MEMORY"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token string">"UNKWOWN_ERROR"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
<span class="token keyword">static</span> string <span class="token function">getMpg123EncodingString</span><span class="token punctuation">(</span><span class="token keyword">int</span> encoding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> MPG123_ENC_16<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_16"</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> MPG123_API_VERSION>=36</span>
		<span class="token keyword">case</span> MPG123_ENC_24<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_24"</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
		<span class="token keyword">case</span> MPG123_ENC_32<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_32"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_8<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_8"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_ALAW_8<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_ALAW_8"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_FLOAT<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_FLOAT"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_FLOAT_32<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_FLOAT_32"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_FLOAT_64<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_FLOAT_64"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_SIGNED<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_SIGNED"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_SIGNED_16<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_SIGNED_16"</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> MPG123_API_VERSION>=36</span>
		<span class="token keyword">case</span> MPG123_ENC_SIGNED_24<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_SIGNED_24"</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
		<span class="token keyword">case</span> MPG123_ENC_SIGNED_32<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_SIGNED_32"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_SIGNED_8<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_SIGNED_8"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_ULAW_8<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_ULAW_8"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_UNSIGNED_16<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_UNSIGNED_16"</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> MPG123_API_VERSION>=36</span>
		<span class="token keyword">case</span> MPG123_ENC_UNSIGNED_24<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_UNSIGNED_24"</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
		<span class="token keyword">case</span> MPG123_ENC_UNSIGNED_32<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_UNSIGNED_32"</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> MPG123_ENC_UNSIGNED_8<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_UNSIGNED_8"</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"MPG123_ENC_ANY"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> BUFFER_STREAM_SIZE 4096</span>

<span class="token comment" spellcheck="true">// now, the individual sound player:</span>
<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">ofOpenALSoundPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	bLoop 			<span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	bLoadedOk 		<span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	pan 			<span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// range for oF is -1 to 1,</span>
	volume 			<span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
	internalFreq 	<span class="token operator">=</span> <span class="token number">44100</span><span class="token punctuation">;</span>
	speed 			<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	bPaused 		<span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	isStreaming		<span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	channels		<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	duration		<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	fftCfg			<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	streamf			<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
	mp3streamf		<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token function">players</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
ofOpenALSoundPlayer<span class="token operator">::</span><span class="token operator">~</span><span class="token function">ofOpenALSoundPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">unload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">kiss_fftr_free</span><span class="token punctuation">(</span>fftCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">players</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">players</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//---------------------------------------</span>
<span class="token comment" spellcheck="true">// this should only be called once</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>alDevice <span class="token punctuation">)</span><span class="token punctuation">{</span>
		alDevice <span class="token operator">=</span> <span class="token function">alcOpenDevice</span><span class="token punctuation">(</span> <span class="token keyword">nullptr</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>alDevice <span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"initialize(): couldn't open OpenAL default device"</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"initialize(): opening "</span><span class="token operator">&lt;&lt;</span> <span class="token function">alcGetString</span><span class="token punctuation">(</span> alDevice<span class="token punctuation">,</span> ALC_DEVICE_SPECIFIER <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment" spellcheck="true">// Create OpenAL context and make it current. If fails, close the OpenAL device that was just opened.</span>
		alContext <span class="token operator">=</span> <span class="token function">alcCreateContext</span><span class="token punctuation">(</span> alDevice<span class="token punctuation">,</span> <span class="token keyword">nullptr</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>alContext <span class="token punctuation">)</span><span class="token punctuation">{</span>
			ALCenum err <span class="token operator">=</span> <span class="token function">alcGetError</span><span class="token punctuation">(</span> alDevice <span class="token punctuation">)</span><span class="token punctuation">;</span> 
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"initialize(): couldn't not create OpenAL context : "</span><span class="token operator">&lt;&lt;</span> <span class="token function">getALCErrorString</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">alcMakeContextCurrent</span><span class="token punctuation">(</span> alContext <span class="token punctuation">)</span><span class="token operator">==</span>ALC_FALSE <span class="token punctuation">)</span><span class="token punctuation">{</span>
			ALCenum err <span class="token operator">=</span> <span class="token function">alcGetError</span><span class="token punctuation">(</span> alDevice <span class="token punctuation">)</span><span class="token punctuation">;</span> 
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"initialize(): couldn't not make current the create OpenAL context : "</span><span class="token operator">&lt;&lt;</span> <span class="token function">getALCErrorString</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token function">alListener3f</span><span class="token punctuation">(</span> AL_POSITION<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
		<span class="token function">mpg123_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token punctuation">}</span>
	<span class="token function">ofLogVerbose</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"initialize(): Done"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//---------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">createWindow</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span>size<span class="token punctuation">)</span><span class="token punctuation">{</span>
		windowSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		window<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment" spellcheck="true">// hanning window</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			window<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token number">54</span> <span class="token operator">-</span> <span class="token punctuation">.</span><span class="token number">46</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token punctuation">(</span>glm<span class="token operator">::</span>two_pi<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			windowSum <span class="token operator">+</span><span class="token operator">=</span> window<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//---------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment" spellcheck="true">// Destroy the OpenAL context (if any) before closing the device</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> alDevice <span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> alContext <span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
			<span class="token function">mpg123_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
			<span class="token function">alcMakeContextCurrent</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">alcDestroyContext</span><span class="token punctuation">(</span>alContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
			alContext <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">alcCloseDevice</span><span class="token punctuation">(</span> alDevice <span class="token punctuation">)</span><span class="token operator">==</span>ALC_FALSE <span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogNotice</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"initialize(): error closing OpenAL device."</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		alDevice <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">sfReadFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>filesystem<span class="token operator">::</span>path<span class="token operator">&</span> path<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">></span> <span class="token operator">&</span> buffer<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> <span class="token operator">&</span> fftAuxBuffer<span class="token punctuation">)</span><span class="token punctuation">{</span>
	SF_INFO sfInfo<span class="token punctuation">;</span>
	SNDFILE<span class="token operator">*</span> f <span class="token operator">=</span> <span class="token function">sf_open</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SFM_READ<span class="token punctuation">,</span><span class="token operator">&</span>sfInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"sfReadFile(): couldn't read \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>sfInfo<span class="token punctuation">.</span>frames<span class="token operator">*</span>sfInfo<span class="token punctuation">.</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
	fftAuxBuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>sfInfo<span class="token punctuation">.</span>frames<span class="token operator">*</span>sfInfo<span class="token punctuation">.</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> subformat <span class="token operator">=</span> sfInfo<span class="token punctuation">.</span>format <span class="token operator">&</span> SF_FORMAT_SUBMASK <span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>subformat <span class="token operator">==</span> SF_FORMAT_FLOAT <span class="token operator">||</span> subformat <span class="token operator">==</span> SF_FORMAT_DOUBLE<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">double</span>	scale <span class="token punctuation">;</span>
		<span class="token function">sf_command</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> SFC_CALC_SIGNAL_MAX<span class="token punctuation">,</span> <span class="token operator">&</span>scale<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>scale<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&lt;</span> <span class="token number">1e-10</span><span class="token punctuation">)</span>
			scale <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			scale <span class="token operator">=</span> <span class="token number">32700.0</span> <span class="token operator">/</span> scale <span class="token punctuation">;</span>

		sf_count_t samples_read <span class="token operator">=</span> <span class="token function">sf_read_float</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token operator">&</span>fftAuxBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fftAuxBuffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>samples_read<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>fftAuxBuffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogWarning</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"sfReadFile(): read "</span> <span class="token operator">&lt;&lt;</span> samples_read <span class="token operator">&lt;&lt;</span> <span class="token string">" float samples, expected "</span>
			<span class="token operator">&lt;&lt;</span> fftAuxBuffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" for \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">int</span><span class="token punctuation">(</span>fftAuxBuffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			fftAuxBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span><span class="token operator">=</span> scale <span class="token punctuation">;</span>
			buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">32565.0</span> <span class="token operator">*</span> fftAuxBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		sf_count_t frames_read <span class="token operator">=</span> <span class="token function">sf_readf_short</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span><span class="token operator">&</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sfInfo<span class="token punctuation">.</span>frames<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>frames_read<span class="token operator">&lt;</span>sfInfo<span class="token punctuation">.</span>frames<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"sfReadFile(): read "</span> <span class="token operator">&lt;&lt;</span> frames_read <span class="token operator">&lt;&lt;</span> <span class="token string">" frames from buffer, expected "</span>
			<span class="token operator">&lt;&lt;</span> sfInfo<span class="token punctuation">.</span>frames <span class="token operator">&lt;&lt;</span> <span class="token string">" for \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">sf_seek</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SEEK_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
		frames_read <span class="token operator">=</span> <span class="token function">sf_readf_float</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span><span class="token operator">&</span>fftAuxBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sfInfo<span class="token punctuation">.</span>frames<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>frames_read<span class="token operator">&lt;</span>sfInfo<span class="token punctuation">.</span>frames<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"sfReadFile(): read "</span> <span class="token operator">&lt;&lt;</span> frames_read <span class="token operator">&lt;&lt;</span> <span class="token string">" frames from fft buffer, expected "</span>
			<span class="token operator">&lt;&lt;</span> sfInfo<span class="token punctuation">.</span>frames <span class="token operator">&lt;&lt;</span> <span class="token string">" for \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">sf_close</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

	channels <span class="token operator">=</span> sfInfo<span class="token punctuation">.</span>channels<span class="token punctuation">;</span>
	duration <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>sfInfo<span class="token punctuation">.</span>frames<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>sfInfo<span class="token punctuation">.</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
	samplerate <span class="token operator">=</span> sfInfo<span class="token punctuation">.</span>samplerate<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">mpg123ReadFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>filesystem<span class="token operator">::</span>path<span class="token operator">&</span> path<span class="token punctuation">,</span>vector<span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">></span> <span class="token operator">&</span> buffer<span class="token punctuation">,</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> <span class="token operator">&</span> fftAuxBuffer<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> MPG123_OK<span class="token punctuation">;</span>
	mpg123_handle <span class="token operator">*</span> f <span class="token operator">=</span> <span class="token function">mpg123_new</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span><span class="token operator">&</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mpg123_open</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span>path<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span>MPG123_OK<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"mpg123ReadFile(): couldn't read \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	mpg123_enc_enum encoding<span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token keyword">int</span> rate<span class="token punctuation">;</span>
	<span class="token function">mpg123_getformat</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span><span class="token operator">&</span>rate<span class="token punctuation">,</span><span class="token operator">&</span>channels<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>encoding<span class="token operator">!=</span>MPG123_ENC_SIGNED_16<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"mpg123ReadFile(): "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getMpg123EncodingString</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span>
			<span class="token operator">&lt;&lt;</span> <span class="token string">" encoding for \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" unsupported, expecting MPG123_ENC_SIGNED_16"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	samplerate <span class="token operator">=</span> rate<span class="token punctuation">;</span>

	size_t done<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	size_t buffer_size <span class="token operator">=</span> <span class="token function">mpg123_outblock</span><span class="token punctuation">(</span> f <span class="token punctuation">)</span><span class="token punctuation">;</span>
	buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>buffer_size<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">mpg123_read</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&</span>buffer<span class="token punctuation">[</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>buffer_size<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>buffer_size<span class="token punctuation">,</span><span class="token operator">&</span>done<span class="token punctuation">)</span><span class="token operator">!=</span>MPG123_DONE<span class="token punctuation">)</span><span class="token punctuation">{</span>
		buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>buffer_size<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">(</span>buffer_size<span class="token operator">/</span><span class="token number">2</span><span class="token operator">-</span>done<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">mpg123_close</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">mpg123_delete</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

	fftAuxBuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		fftAuxBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">32565</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	duration <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">sfStream</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>filesystem<span class="token operator">::</span>path<span class="token operator">&</span> path<span class="token punctuation">,</span>vector<span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">></span> <span class="token operator">&</span> buffer<span class="token punctuation">,</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> <span class="token operator">&</span> fftAuxBuffer<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>streamf<span class="token punctuation">)</span><span class="token punctuation">{</span>
		SF_INFO sfInfo<span class="token punctuation">;</span>
		streamf <span class="token operator">=</span> <span class="token function">sf_open</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SFM_READ<span class="token punctuation">,</span><span class="token operator">&</span>sfInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>streamf<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"sfStream(): couldn't read \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		stream_subformat <span class="token operator">=</span> sfInfo<span class="token punctuation">.</span>format <span class="token operator">&</span> SF_FORMAT_SUBMASK <span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>stream_subformat <span class="token operator">==</span> SF_FORMAT_FLOAT <span class="token operator">||</span> stream_subformat <span class="token operator">==</span> SF_FORMAT_DOUBLE<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">sf_command</span> <span class="token punctuation">(</span>streamf<span class="token punctuation">,</span> SFC_CALC_SIGNAL_MAX<span class="token punctuation">,</span> <span class="token operator">&</span>stream_scale<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>stream_scale<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>stream_scale <span class="token operator">&lt;</span> <span class="token number">1e-10</span><span class="token punctuation">)</span>
				stream_scale <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token punctuation">;</span>
			<span class="token keyword">else</span>
				stream_scale <span class="token operator">=</span> <span class="token number">32700.0</span> <span class="token operator">/</span> stream_scale <span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		channels <span class="token operator">=</span> sfInfo<span class="token punctuation">.</span>channels<span class="token punctuation">;</span>
		duration <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>sfInfo<span class="token punctuation">.</span>frames<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>sfInfo<span class="token punctuation">.</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
		samplerate <span class="token operator">=</span> sfInfo<span class="token punctuation">.</span>samplerate<span class="token punctuation">;</span>
		stream_samples_read <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> curr_buffer_size <span class="token operator">=</span> BUFFER_STREAM_SIZE<span class="token operator">*</span>channels<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>speed<span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span> curr_buffer_size <span class="token operator">*</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">round</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
	buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>curr_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	fftAuxBuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>stream_subformat <span class="token operator">==</span> SF_FORMAT_FLOAT <span class="token operator">||</span> stream_subformat <span class="token operator">==</span> SF_FORMAT_DOUBLE<span class="token punctuation">)</span><span class="token punctuation">{</span>
		sf_count_t samples_read <span class="token operator">=</span> <span class="token function">sf_read_float</span> <span class="token punctuation">(</span>streamf<span class="token punctuation">,</span> <span class="token operator">&</span>fftAuxBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fftAuxBuffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stream_samples_read <span class="token operator">+</span><span class="token operator">=</span> samples_read<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>samples_read<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>fftAuxBuffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			fftAuxBuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>samples_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
			buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>samples_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bLoop<span class="token punctuation">)</span> <span class="token function">stopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			stream_samples_read <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			stream_end <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">int</span><span class="token punctuation">(</span>fftAuxBuffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			fftAuxBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span><span class="token operator">=</span> stream_scale <span class="token punctuation">;</span>
			buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">32565.0</span> <span class="token operator">*</span> fftAuxBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		sf_count_t frames_read <span class="token operator">=</span> <span class="token function">sf_readf_short</span><span class="token punctuation">(</span>streamf<span class="token punctuation">,</span><span class="token operator">&</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>curr_buffer_size<span class="token operator">/</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
		stream_samples_read <span class="token operator">+</span><span class="token operator">=</span> frames_read<span class="token operator">*</span>channels<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>frames_read<span class="token operator">&lt;</span>curr_buffer_size<span class="token operator">/</span>channels<span class="token punctuation">)</span><span class="token punctuation">{</span>
			fftAuxBuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>frames_read<span class="token operator">*</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
			buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>frames_read<span class="token operator">*</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bLoop<span class="token punctuation">)</span> <span class="token function">stopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			stream_samples_read <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			stream_end <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			fftAuxBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">float</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">32565.0f</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">mpg123Stream</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>filesystem<span class="token operator">::</span>path<span class="token operator">&</span> path<span class="token punctuation">,</span>vector<span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">></span> <span class="token operator">&</span> buffer<span class="token punctuation">,</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> <span class="token operator">&</span> fftAuxBuffer<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>mp3streamf<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">int</span> err <span class="token operator">=</span> MPG123_OK<span class="token punctuation">;</span>
		mp3streamf <span class="token operator">=</span> <span class="token function">mpg123_new</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span><span class="token operator">&</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mpg123_open</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">,</span>path<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span>MPG123_OK<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">mpg123_close</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">mpg123_delete</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"mpg123Stream(): couldn't read \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">long</span> <span class="token keyword">int</span> rate<span class="token punctuation">;</span>
		<span class="token function">mpg123_getformat</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">,</span><span class="token operator">&</span>rate<span class="token punctuation">,</span><span class="token operator">&</span>channels<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&</span>stream_encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>stream_encoding<span class="token operator">!=</span>MPG123_ENC_SIGNED_16<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"mpg123Stream(): "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getMpg123EncodingString</span><span class="token punctuation">(</span>stream_encoding<span class="token punctuation">)</span>
			<span class="token operator">&lt;&lt;</span> <span class="token string">" encoding for \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" unsupported, expecting MPG123_ENC_SIGNED_16"</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		samplerate <span class="token operator">=</span> rate<span class="token punctuation">;</span>
		mp3_buffer_size <span class="token operator">=</span> <span class="token function">mpg123_outblock</span><span class="token punctuation">(</span> mp3streamf <span class="token punctuation">)</span><span class="token punctuation">;</span>


		<span class="token function">mpg123_seek</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SEEK_END<span class="token punctuation">)</span><span class="token punctuation">;</span>
		off_t samples <span class="token operator">=</span> <span class="token function">mpg123_tell</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		duration <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>samples<span class="token operator">/</span>channels<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">mpg123_seek</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SEEK_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> curr_buffer_size <span class="token operator">=</span> mp3_buffer_size<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>speed<span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span> curr_buffer_size <span class="token operator">*</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">round</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
	buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>curr_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	fftAuxBuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	size_t done<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mpg123_read</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>curr_buffer_size<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">&</span>done<span class="token punctuation">)</span><span class="token operator">==</span>MPG123_DONE<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>done<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		fftAuxBuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>done<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bLoop<span class="token punctuation">)</span> <span class="token function">stopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stream_end <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		fftAuxBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">32565</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>filesystem<span class="token operator">::</span>path<span class="token operator">&</span> fileName<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">></span> <span class="token operator">&</span> buffer<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ofFilePath<span class="token operator">::</span><span class="token function">getFileExt</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">"mp3"</span> <span class="token operator">||</span> ofFilePath<span class="token operator">::</span><span class="token function">getFileExt</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">"MP3"</span> <span class="token operator">||</span> mp3streamf<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mpg123Stream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>fftAuxBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sfStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>fftAuxBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	fftBuffers<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> numFrames <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>channels<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		fftBuffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>numFrames<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>numFrames<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			fftBuffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> fftAuxBuffer<span class="token punctuation">[</span>j<span class="token operator">*</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>filesystem<span class="token operator">::</span>path<span class="token operator">&</span> fileName<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">></span> <span class="token operator">&</span> buffer<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ofFilePath<span class="token operator">::</span><span class="token function">getFileExt</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token string">"mp3"</span> <span class="token operator">&&</span> ofFilePath<span class="token operator">::</span><span class="token function">getFileExt</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token string">"MP3"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sfReadFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>fftAuxBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mpg123ReadFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>fftAuxBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sfReadFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>fftAuxBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	fftBuffers<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> numFrames <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>channels<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		fftBuffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>numFrames<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>numFrames<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			fftBuffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> fftAuxBuffer<span class="token punctuation">[</span>j<span class="token operator">*</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>filesystem<span class="token operator">::</span>path<span class="token operator">&</span> _fileName<span class="token punctuation">,</span> <span class="token keyword">bool</span> is_stream<span class="token punctuation">)</span><span class="token punctuation">{</span>

	std<span class="token operator">::</span>filesystem<span class="token operator">::</span>path fileName <span class="token operator">=</span> <span class="token function">ofToDataPath</span><span class="token punctuation">(</span>_fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

	bMultiPlay <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	isStreaming <span class="token operator">=</span> is_stream<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> AL_NO_ERROR<span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">// [1] init sound systems, if necessary</span>
	<span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">// [2] try to unload any previously loaded sounds</span>
	<span class="token comment" spellcheck="true">// & prevent user-created memory leaks</span>
	<span class="token comment" spellcheck="true">// if they call "loadSound" repeatedly, for example</span>

	<span class="token function">unload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ALenum format<span class="token operator">=</span>AL_FORMAT_MONO16<span class="token punctuation">;</span>
	bLoadedOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isStreaming<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">stream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> numFrames <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming<span class="token punctuation">)</span><span class="token punctuation">{</span>
		buffers<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>channels<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		buffers<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">alGenBuffers</span><span class="token punctuation">(</span>buffers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&</span>buffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>channels<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		sources<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Clear error.</span>
		<span class="token function">alGenSources</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		err <span class="token operator">=</span> <span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> AL_NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"loadSound(): couldn't generate source for \""</span> <span class="token operator">&lt;&lt;</span> fileName <span class="token operator">&lt;&lt;</span> <span class="token string">"\": "</span>
			<span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> err <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getALErrorString</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>buffers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Clear error.</span>
			<span class="token function">alBufferData</span><span class="token punctuation">(</span>buffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>format<span class="token punctuation">,</span><span class="token operator">&</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
			err <span class="token operator">=</span> <span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> AL_NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer:"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"loadSound(): couldn't create buffer for \""</span> <span class="token operator">&lt;&lt;</span> fileName <span class="token operator">&lt;&lt;</span> <span class="token string">"\": "</span>
				<span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> err <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getALErrorString</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming<span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">stream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">alSourceQueueBuffers</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>buffers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&</span>buffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token function">alSourcei</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> AL_BUFFER<span class="token punctuation">,</span>   buffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">alSourcef</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> AL_PITCH<span class="token punctuation">,</span>    <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">alSourcef</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> AL_GAIN<span class="token punctuation">,</span>     <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">alSourcef</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> AL_ROLLOFF_FACTOR<span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">alSourcei</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> AL_SOURCE_RELATIVE<span class="token punctuation">,</span> AL_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">></span> <span class="token operator">></span> multibuffer<span class="token punctuation">;</span>
		multibuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
		sources<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">alGenSources</span><span class="token punctuation">(</span>channels<span class="token punctuation">,</span> <span class="token operator">&</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> s<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>s<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>channels<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					multibuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>numFrames<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
						multibuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> buffer<span class="token punctuation">[</span>j<span class="token operator">*</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Clear error.</span>
					<span class="token function">alBufferData</span><span class="token punctuation">(</span>buffers<span class="token punctuation">[</span>s<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>format<span class="token punctuation">,</span><span class="token operator">&</span>multibuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
					err <span class="token operator">=</span> <span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span> err <span class="token operator">!=</span> AL_NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">{</span>
						<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"loadSound(): couldn't create stereo buffers for \""</span> <span class="token operator">&lt;&lt;</span> fileName <span class="token operator">&lt;&lt;</span> <span class="token string">"\": "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> err <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getALErrorString</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token function">alSourceQueueBuffers</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&</span>buffers<span class="token punctuation">[</span>s<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">stream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>channels<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				multibuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>numFrames<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					multibuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> buffer<span class="token punctuation">[</span>j<span class="token operator">*</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Clear error.</span>
				<span class="token function">alBufferData</span><span class="token punctuation">(</span>buffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>format<span class="token punctuation">,</span><span class="token operator">&</span>multibuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> AL_NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"loadSound(): couldn't create stereo buffers for \""</span> <span class="token operator">&lt;&lt;</span> fileName <span class="token operator">&lt;&lt;</span> <span class="token string">"\": "</span>
					<span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> err <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getALErrorString</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token function">alSourcei</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> AL_BUFFER<span class="token punctuation">,</span>   buffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span>   <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>


		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>channels<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			err <span class="token operator">=</span> <span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> AL_NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"loadSound(): couldn't create stereo sources for \""</span> <span class="token operator">&lt;&lt;</span> fileName <span class="token operator">&lt;&lt;</span> <span class="token string">"\": "</span>
				<span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> err <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getALErrorString</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment" spellcheck="true">// only stereo panning</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">float</span> pos<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
				<span class="token function">alSourcefv</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_POSITION<span class="token punctuation">,</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
				<span class="token keyword">float</span> pos<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
				<span class="token function">alSourcefv</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_POSITION<span class="token punctuation">,</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">alSourcef</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> AL_ROLLOFF_FACTOR<span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">alSourcei</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> AL_SOURCE_RELATIVE<span class="token punctuation">,</span> AL_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	bLoadedOk <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> bLoadedOk<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">isLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> bLoadedOk<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">threadedFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">></span> <span class="token operator">></span> multibuffer<span class="token punctuation">;</span>
	multibuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">isThreadRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">int</span> processed<span class="token punctuation">;</span>
			<span class="token function">alGetSourcei</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token operator">*</span>channels<span class="token punctuation">]</span><span class="token punctuation">,</span> AL_BUFFERS_PROCESSED<span class="token punctuation">,</span> <span class="token operator">&</span>processed<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">while</span><span class="token punctuation">(</span>processed<span class="token operator">--</span><span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token function">stream</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">int</span> numFrames <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>channels<span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>channels<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
						multibuffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">&lt;</span>numFrames<span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
							multibuffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> buffer<span class="token punctuation">[</span>k<span class="token operator">*</span>channels<span class="token operator">+</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						ALuint albuffer<span class="token punctuation">;</span>
						<span class="token function">alSourceUnqueueBuffers</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token operator">*</span>channels<span class="token operator">+</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&</span>albuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token function">alBufferData</span><span class="token punctuation">(</span>albuffer<span class="token punctuation">,</span>AL_FORMAT_MONO16<span class="token punctuation">,</span><span class="token operator">&</span>multibuffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">/</span>channels<span class="token punctuation">,</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token function">alSourceQueueBuffers</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token operator">*</span>channels<span class="token operator">+</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&</span>albuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
					ALuint albuffer<span class="token punctuation">;</span>
					<span class="token function">alSourceUnqueueBuffers</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&</span>albuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">alBufferData</span><span class="token punctuation">(</span>albuffer<span class="token punctuation">,</span>AL_FORMAT_MONO16<span class="token punctuation">,</span><span class="token operator">&</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">/</span>channels<span class="token punctuation">,</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">alSourceQueueBuffers</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&</span>albuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>stream_end<span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			ALint state<span class="token punctuation">;</span>
			<span class="token function">alGetSourcei</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token operator">*</span>channels<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_SOURCE_STATE<span class="token punctuation">,</span><span class="token operator">&</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">bool</span> stream_running<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
				stream_running <span class="token operator">=</span> streamf <span class="token operator">||</span> mp3streamf<span class="token punctuation">;</span>
			<span class="token macro property">#<span class="token directive keyword">else</span></span>
				stream_running <span class="token operator">=</span> streamf<span class="token punctuation">;</span>
			<span class="token macro property">#<span class="token directive keyword">endif</span></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> AL_PLAYING <span class="token operator">&&</span> stream_running <span class="token operator">&&</span> <span class="token operator">!</span>stream_end<span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">alSourcePlayv</span><span class="token punctuation">(</span>channels<span class="token punctuation">,</span><span class="token operator">&</span>sources<span class="token punctuation">[</span>i<span class="token operator">*</span>channels<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			stream_end <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span>ofEventArgs <span class="token operator">&</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">;</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
		ALint state<span class="token punctuation">;</span>
		<span class="token function">alGetSourcei</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token operator">*</span>channels<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_SOURCE_STATE<span class="token punctuation">,</span><span class="token operator">&</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> AL_PLAYING<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">alDeleteSources</span><span class="token punctuation">(</span>channels<span class="token punctuation">,</span><span class="token operator">&</span>sources<span class="token punctuation">[</span>i<span class="token operator">*</span>channels<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>channels<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				sources<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
			i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">unload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ofRemoveListener</span><span class="token punctuation">(</span><span class="token function">ofEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token operator">&</span>ofOpenALSoundPlayer<span class="token operator">::</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">// Only lock the thread where necessary.</span>
	<span class="token punctuation">{</span>
		std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment" spellcheck="true">// Delete sources before buffers.</span>
		<span class="token function">alDeleteSources</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">alDeleteBuffers</span><span class="token punctuation">(</span>buffers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&</span>buffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		sources<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		buffers<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment" spellcheck="true">// Free resources and close file descriptors.</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">mpg123_close</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">mpg123_delete</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	mp3streamf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>streamf<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">sf_close</span><span class="token punctuation">(</span>streamf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	streamf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	bLoadedOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">isPlaying</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">isThreadRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ALint state<span class="token punctuation">;</span>
	<span class="token keyword">bool</span> playing<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">alGetSourcei</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_SOURCE_STATE<span class="token punctuation">,</span><span class="token operator">&</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
		playing <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> AL_PLAYING<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> playing<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">bool</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	ALint state<span class="token punctuation">;</span>
	<span class="token keyword">bool</span> paused<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">alGetSourcei</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_SOURCE_STATE<span class="token punctuation">,</span><span class="token operator">&</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
		paused <span class="token operator">&</span><span class="token operator">=</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> AL_PAUSED<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> paused<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">float</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> speed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">float</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">getPan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> pan<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">float</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">getVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> volume<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">setVolume</span><span class="token punctuation">(</span><span class="token keyword">float</span> vol<span class="token punctuation">)</span><span class="token punctuation">{</span>
	volume <span class="token operator">=</span> vol<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>channels<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">alSourcef</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> AL_GAIN<span class="token punctuation">,</span> vol<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">setPan</span><span class="token punctuation">(</span>pan<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token keyword">float</span> pct<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">setPositionMS</span><span class="token punctuation">(</span>duration<span class="token operator">*</span>pct<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">setPositionMS</span><span class="token punctuation">(</span><span class="token keyword">int</span> ms<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">mpg123_seek</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">,</span><span class="token keyword">float</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">.</span>f<span class="token operator">*</span>samplerate<span class="token punctuation">,</span>SEEK_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>streamf<span class="token punctuation">)</span><span class="token punctuation">{</span>
        stream_samples_read <span class="token operator">=</span> <span class="token function">sf_seek</span><span class="token punctuation">(</span>streamf<span class="token punctuation">,</span><span class="token keyword">float</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">.</span>f<span class="token operator">*</span>samplerate<span class="token punctuation">,</span>SEEK_SET<span class="token punctuation">)</span> <span class="token operator">*</span> channels<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>channels<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">alSourcef</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_SEC_OFFSET<span class="token punctuation">,</span><span class="token keyword">float</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">float</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>duration<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token keyword">return</span> <span class="token function">getPositionMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">.</span>f<span class="token operator">*</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">int</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">getPositionMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> pos<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> OF_USING_MPG123</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">)</span><span class="token punctuation">{</span>
		pos <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token function">mpg123_tell</span><span class="token punctuation">(</span>mp3streamf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>streamf<span class="token punctuation">)</span><span class="token punctuation">{</span>
		pos <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>stream_samples_read<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>channels<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>samplerate<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">alGetSourcef</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>AL_SEC_OFFSET<span class="token punctuation">,</span><span class="token operator">&</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> pos <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">setPan</span><span class="token punctuation">(</span><span class="token keyword">float</span> p<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">clamp</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">.</span>f<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pan <span class="token operator">=</span> p<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>channels<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">float</span> pos<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>p<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token function">alSourcefv</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>AL_POSITION<span class="token punctuation">,</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// calculates left/right volumes from pan-value (constant panning law)</span>
        <span class="token comment" spellcheck="true">// see: Curtis Roads: Computer Music Tutorial p 460</span>
		<span class="token comment" spellcheck="true">// thanks to jasch</span>
        <span class="token keyword">float</span> angle <span class="token operator">=</span> p <span class="token operator">*</span> <span class="token number">0.7853981633974483f</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// in radians from -45. to +45.</span>
        <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> sinAngle <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> leftVol  <span class="token operator">=</span> <span class="token punctuation">(</span>cosAngle <span class="token operator">-</span> sinAngle<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.7071067811865475</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// multiplied by sqrt(2)/2</span>
        <span class="token keyword">float</span> rightVol <span class="token operator">=</span> <span class="token punctuation">(</span>cosAngle <span class="token operator">+</span> sinAngle<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.7071067811865475</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// multiplied by sqrt(2)/2</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>channels<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">alSourcef</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_GAIN<span class="token punctuation">,</span>leftVol<span class="token operator">*</span>volume<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
				<span class="token function">alSourcef</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_GAIN<span class="token punctuation">,</span>rightVol<span class="token operator">*</span>volume<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">setPaused</span><span class="token punctuation">(</span><span class="token keyword">bool</span> bP<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>bP<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">alSourcePausev</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">stopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">alSourcePlayv</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&</span>sources<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">startThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	bPaused <span class="token operator">=</span> bP<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">setSpeed</span><span class="token punctuation">(</span><span class="token keyword">float</span> spd<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>channels<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">alSourcef</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_PITCH<span class="token punctuation">,</span>spd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	speed <span class="token operator">=</span> spd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">setLoop</span><span class="token punctuation">(</span><span class="token keyword">bool</span> bLp<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>bMultiPlay<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// no looping on multiplay</span>
	bLoop <span class="token operator">=</span> bLp<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">alSourcei</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_LOOPING<span class="token punctuation">,</span>bLp<span class="token operator">?</span>AL_TRUE<span class="token operator">:</span>AL_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">setMultiPlay</span><span class="token punctuation">(</span><span class="token keyword">bool</span> bMp<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming <span class="token operator">&&</span> bMp<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofLogWarning</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"setMultiPlay(): sorry, no support for multiplay streams"</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	bMultiPlay <span class="token operator">=</span> bMp<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// be careful with this...</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>bMultiPlay<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofAddListener</span><span class="token punctuation">(</span><span class="token function">ofEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token operator">&</span>ofOpenALSoundPlayer<span class="token operator">::</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">ofRemoveListener</span><span class="token punctuation">(</span><span class="token function">ofEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token operator">&</span>ofOpenALSoundPlayer<span class="token operator">::</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">// if the sound is set to multiplay, then create new sources,</span>
	<span class="token comment" spellcheck="true">// do not multiplay on loop or we won't be able to stop it</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bMultiPlay <span class="token operator">&&</span> <span class="token operator">!</span>bLoop<span class="token punctuation">)</span><span class="token punctuation">{</span>
		sources<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Clear error.</span>
		<span class="token function">alGenSources</span><span class="token punctuation">(</span>channels<span class="token punctuation">,</span> <span class="token operator">&</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		err <span class="token operator">=</span> <span class="token function">alGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> AL_NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"play(): couldn't create multiplay stereo sources: "</span>
			<span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> err <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getALErrorString</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>channels<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">alSourcei</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> AL_BUFFER<span class="token punctuation">,</span>   buffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span>   <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment" spellcheck="true">// only stereo panning</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">float</span> pos<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
				<span class="token function">alSourcefv</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_POSITION<span class="token punctuation">,</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
				<span class="token keyword">float</span> pos<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
				<span class="token function">alSourcefv</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_POSITION<span class="token punctuation">,</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		    <span class="token function">alSourcef</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> AL_ROLLOFF_FACTOR<span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token function">alSourcei</span> <span class="token punctuation">(</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> AL_SOURCE_RELATIVE<span class="token punctuation">,</span> AL_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		err <span class="token operator">=</span> <span class="token function">glGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> AL_NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">ofLogError</span><span class="token punctuation">(</span><span class="token string">"ofOpenALSoundPlayer"</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"play(): couldn't assign multiplay buffers: "</span>
			<span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> err <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getALErrorString</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">alSourcePlayv</span><span class="token punctuation">(</span>channels<span class="token punctuation">,</span><span class="token operator">&</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>bMultiPlay<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">ofAddListener</span><span class="token punctuation">(</span><span class="token function">ofEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token operator">&</span>ofOpenALSoundPlayer<span class="token operator">::</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stream_end <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token function">startThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">alSourceStopv</span><span class="token punctuation">(</span>channels<span class="token punctuation">,</span><span class="token operator">&</span>sources<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>channels<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>isStreaming<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">stopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">initFFT</span><span class="token punctuation">(</span><span class="token keyword">int</span> bands<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>bins<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span>bands<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> signalSize <span class="token operator">=</span> <span class="token punctuation">(</span>bands<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>fftCfg<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">kiss_fftr_free</span><span class="token punctuation">(</span>fftCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	fftCfg <span class="token operator">=</span> <span class="token function">kiss_fftr_alloc</span><span class="token punctuation">(</span>signalSize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cx_out<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>bands<span class="token punctuation">)</span><span class="token punctuation">;</span>
	bins<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>bands<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">createWindow</span><span class="token punctuation">(</span>signalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">initSystemFFT</span><span class="token punctuation">(</span><span class="token keyword">int</span> bands<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>systemBins<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span>bands<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> signalSize <span class="token operator">=</span> <span class="token punctuation">(</span>bands<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>systemFftCfg<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">kiss_fftr_free</span><span class="token punctuation">(</span>systemFftCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	systemFftCfg <span class="token operator">=</span> <span class="token function">kiss_fftr_alloc</span><span class="token punctuation">(</span>signalSize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	systemCx_out<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>bands<span class="token punctuation">)</span><span class="token punctuation">;</span>
	systemBins<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>bands<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">createWindow</span><span class="token punctuation">(</span>signalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token operator">*</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">getCurrentBufferSum</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>windowedSignal<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span>size<span class="token punctuation">)</span><span class="token punctuation">{</span>
		windowedSignal<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	windowedSignal<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>windowedSignal<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>channels<span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isStreaming<span class="token punctuation">)</span><span class="token punctuation">{</span>
			ALint state<span class="token punctuation">;</span>
			<span class="token function">alGetSourcei</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>k<span class="token operator">*</span>channels<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_SOURCE_STATE<span class="token punctuation">,</span><span class="token operator">&</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span> state <span class="token operator">!=</span> AL_PLAYING <span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> pos<span class="token punctuation">;</span>
		<span class="token function">alGetSourcei</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>k<span class="token operator">*</span>channels<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_SAMPLE_OFFSET<span class="token punctuation">,</span><span class="token operator">&</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment" spellcheck="true">//if(pos+size>=(int)fftBuffers[0].size()) continue;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>channels<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">float</span> gain<span class="token punctuation">;</span>
			<span class="token function">alGetSourcef</span><span class="token punctuation">(</span>sources<span class="token punctuation">[</span>k<span class="token operator">*</span>channels<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>AL_GAIN<span class="token punctuation">,</span><span class="token operator">&</span>gain<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>size<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>pos<span class="token operator">+</span>j<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>fftBuffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					windowedSignal<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">=</span>fftBuffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>pos<span class="token operator">+</span>j<span class="token punctuation">]</span><span class="token operator">*</span>gain<span class="token punctuation">;</span>
				<span class="token keyword">else</span>
					windowedSignal<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&</span>windowedSignal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
<span class="token keyword">float</span> <span class="token operator">*</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">getSpectrum</span><span class="token punctuation">(</span><span class="token keyword">int</span> bands<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">initFFT</span><span class="token punctuation">(</span>bands<span class="token punctuation">)</span><span class="token punctuation">;</span>
	bins<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>bins<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sources<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">&</span>bins<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> signalSize <span class="token operator">=</span> <span class="token punctuation">(</span>bands<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token function">getCurrentBufferSum</span><span class="token punctuation">(</span>signalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">float</span> normalizer <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">.</span> <span class="token operator">/</span> windowSum<span class="token punctuation">;</span>
	<span class="token function">runWindow</span><span class="token punctuation">(</span>windowedSignal<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">kiss_fftr</span><span class="token punctuation">(</span>fftCfg<span class="token punctuation">,</span> <span class="token operator">&</span>windowedSignal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&</span>cx_out<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bands<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		bins<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">sqrtf</span><span class="token punctuation">(</span>cx_out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">*</span> cx_out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">+</span> cx_out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>i <span class="token operator">*</span> cx_out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> normalizer<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&</span>bins<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
<span class="token keyword">float</span> <span class="token operator">*</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">getSystemSpectrum</span><span class="token punctuation">(</span><span class="token keyword">int</span> bands<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">initSystemFFT</span><span class="token punctuation">(</span>bands<span class="token punctuation">)</span><span class="token punctuation">;</span>
	systemBins<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>systemBins<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">players</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">&</span>systemBins<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> signalSize <span class="token operator">=</span> <span class="token punctuation">(</span>bands<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>systemWindowedSignal<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span>signalSize<span class="token punctuation">)</span><span class="token punctuation">{</span>
		systemWindowedSignal<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>signalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	systemWindowedSignal<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>systemWindowedSignal<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	set<span class="token operator">&lt;</span>ofOpenALSoundPlayer<span class="token operator">*</span><span class="token operator">></span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>it<span class="token operator">=</span><span class="token function">players</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token operator">!=</span><span class="token function">players</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">isPlaying</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> <span class="token operator">*</span> buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getCurrentBufferSum</span><span class="token punctuation">(</span>signalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>signalSize<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			systemWindowedSignal<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">=</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">float</span> normalizer <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">.</span> <span class="token operator">/</span> windowSum<span class="token punctuation">;</span>
	<span class="token function">runWindow</span><span class="token punctuation">(</span>systemWindowedSignal<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">kiss_fftr</span><span class="token punctuation">(</span>systemFftCfg<span class="token punctuation">,</span> <span class="token operator">&</span>systemWindowedSignal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&</span>systemCx_out<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bands<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		systemBins<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">sqrtf</span><span class="token punctuation">(</span>systemCx_out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">*</span> systemCx_out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">+</span> systemCx_out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>i <span class="token operator">*</span> systemCx_out<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> normalizer<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&</span>systemBins<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ----------------------------------------------------------------------------</span>
<span class="token keyword">void</span> ofOpenALSoundPlayer<span class="token operator">::</span><span class="token function">runWindow</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span> <span class="token operator">&</span> signal<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>signal<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		signal<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span><span class="token operator">=</span> window<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre></div></div></div></div></div></div></div></div><script defer src="/_nuxt/payloads/1586012716389/openframeworks/sound/ofOpenALSoundPlayer_cpp/payload.js"></script><script src="/_nuxt/5f71eaca0bd2f1a0f939.js" defer></script><script src="/_nuxt/35a90d914f539af1362f.js" defer></script><script src="/_nuxt/906a3ca0fb13ed3c6651.js" defer></script><script src="/_nuxt/b673915e8a08acf593e8.js" defer></script><script src="/_nuxt/bf355f21967a23c26c07.js" defer></script>
  </body>
</html>
