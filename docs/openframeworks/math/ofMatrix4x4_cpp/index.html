<!doctype html>
<html data-n-head-ssr>
  <head>
    <title>ofMatrix4x4.cpp | openframeworks | ofDocs</title><meta data-n-head="ssr" data-hid="description" name="description" content="openFrameworks documentation and examples browser"><meta data-n-head="ssr" data-hid="keyword" name="keyword" content=""><meta data-n-head="ssr" property="og:description" content="openFrameworks documentation and examples browser" vmid="og:description"><meta data-n-head="ssr" property="og:title" content="ofMatrix4x4.cpp | openframeworks | ofDocs" vmid="og:title"><meta data-n-head="ssr" property="og:image" content="/files/images/ofw-logo.png" vmid="og:image"><link rel="preload" href="/_nuxt/3213b67383225fc2f59b.js" as="script"><link rel="preload" href="/_nuxt/5fe5bba000836bc4a25f.js" as="script"><link rel="preload" href="/_nuxt/fe12c0cb7395fa1032f4.css" as="style"><link rel="preload" href="/_nuxt/f8d94d1c92ade1d8a6da.js" as="script"><link rel="preload" href="/_nuxt/a24b354526a25539cceb.css" as="style"><link rel="preload" href="/_nuxt/9a7e20c23e9625feab77.js" as="script"><link rel="preload" href="/_nuxt/21c4d0f9583096394838.css" as="style"><link rel="preload" href="/_nuxt/d1291586b31fa28ca9d5.js" as="script"><link rel="stylesheet" href="/_nuxt/fe12c0cb7395fa1032f4.css"><link rel="stylesheet" href="/_nuxt/a24b354526a25539cceb.css"><link rel="stylesheet" href="/_nuxt/21c4d0f9583096394838.css">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div id="app" class="unknown"><div id="menu"><h1 class="of"><div class="inner"><span><a href="/" class="nuxt-link-active"><div class="txt"><span class="docs f7 questrial">ofDocs </span><span class="version">0.11.0</span></div></a></span></div></h1><div id="search"><div class="inner"><div class="field text"><div class="field-inner"><svg viewbox="0 0 36 36" x="0px" y="0px" enable-background="new 0 0 36 36" xml:space="preserve"><path d="M35.525,31.228l-8.88-8.882c1.444-2.238,2.298-4.895,2.298-7.752c0-7.909-6.438-14.343-14.346-14.343						c-7.911,0-14.343,6.434-14.343,14.343c0,7.911,6.433,14.344,14.343,14.344c2.856,0,5.513-0.849,7.752-2.294l8.88,8.88						c0.295,0.297,0.782,0.297,1.076,0l3.22-3.221C35.824,32.008,35.824,31.523,35.525,31.228z M4.81,14.593						c0-5.396,4.391-9.788,9.788-9.788c5.398,0,9.787,4.392,9.787,9.788c0,5.398-4.389,9.789-9.787,9.789						C9.2,24.382,4.81,19.991,4.81,14.593z"></path></svg><!----><div class="text-wrapper"><input id="search_field" name="search_field" placeholder="Search (Alt+F)" autocomplete="off" tabindex="0"></div><!----><!----></div></div></div><div id="results" class="mt1"></div></div><div id="lists" class="menu-inner mt1"><div class="inner"><div class="item documentation"><a href="/documentation/" title="/documentation/"><i class="ico" style="display:none"></i><span>documentation</span><span style="display:none">documentation</span></a><!----></div><div class="item examples"><a href="/examples/" title="/examples/"><i class="ico" style="display:none"></i><span>examples</span><span style="display:none">examples</span></a><!----></div><div class="item openframeworks"><a href="/openframeworks/" title="/openframeworks/" class="nuxt-link-active"><i class="ico" style="display:none"></i><span>openFrameworks</span><span style="display:none">openframeworks</span></a><div class="list"><div class="item 3d"><a href="/openframeworks/3d/" title="/openframeworks/3d/"><i class="ico" style="display:none"></i><span style="display:none"></span><span>3d</span></a><!----></div><div class="item app"><a href="/openframeworks/app/" title="/openframeworks/app/"><i class="ico" style="display:none">web</i><span style="display:none"></span><span>app</span></a><!----></div><div class="item communication"><a href="/openframeworks/communication/" title="/openframeworks/communication/"><i class="ico" style="display:none">language</i><span style="display:none"></span><span>communication</span></a><!----></div><div class="item events"><a href="/openframeworks/events/" title="/openframeworks/events/"><i class="ico" style="display:none">question_answer</i><span style="display:none"></span><span>events</span></a><!----></div><div class="item gl"><a href="/openframeworks/gl/" title="/openframeworks/gl/"><i class="ico" style="display:none"></i><span style="display:none"></span><span>gl</span></a><!----></div><div class="item graphics"><a href="/openframeworks/graphics/" title="/openframeworks/graphics/"><i class="ico" style="display:none">category</i><span style="display:none"></span><span>graphics</span></a><!----></div><div class="item math"><a href="/openframeworks/math/" title="/openframeworks/math/" class="nuxt-link-active"><i class="ico" style="display:none">border_clear</i><span style="display:none"></span><span>math</span></a><div class="list"><div class="item ofMath.cpp"><a href="/openframeworks/math/ofMath_cpp" title="/openframeworks/math/ofMath.cpp"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofMath.cpp</span></a><!----></div><div class="item ofMath.h"><a href="/openframeworks/math/ofMath_h" title="/openframeworks/math/ofMath.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofMath.h</span></a><!----></div><div class="item ofMathConstants.h"><a href="/openframeworks/math/ofMathConstants_h" title="/openframeworks/math/ofMathConstants.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofMathConstants.h</span></a><!----></div><div class="item ofMatrix3x3.cpp"><a href="/openframeworks/math/ofMatrix3x3_cpp" title="/openframeworks/math/ofMatrix3x3.cpp"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofMatrix3x3.cpp</span></a><!----></div><div class="item ofMatrix3x3.h"><a href="/openframeworks/math/ofMatrix3x3_h" title="/openframeworks/math/ofMatrix3x3.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofMatrix3x3.h</span></a><!----></div><div class="item ofMatrix4x4.cpp"><a href="/openframeworks/math/ofMatrix4x4_cpp" title="/openframeworks/math/ofMatrix4x4.cpp" class="nuxt-link-exact-active nuxt-link-active"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofMatrix4x4.cpp</span></a><div class="list"></div></div><div class="item ofMatrix4x4.h"><a href="/openframeworks/math/ofMatrix4x4_h" title="/openframeworks/math/ofMatrix4x4.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofMatrix4x4.h</span></a><!----></div><div class="item ofQuaternion.cpp"><a href="/openframeworks/math/ofQuaternion_cpp" title="/openframeworks/math/ofQuaternion.cpp"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofQuaternion.cpp</span></a><!----></div><div class="item ofQuaternion.h"><a href="/openframeworks/math/ofQuaternion_h" title="/openframeworks/math/ofQuaternion.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofQuaternion.h</span></a><!----></div><div class="item ofVec2f.cpp"><a href="/openframeworks/math/ofVec2f_cpp" title="/openframeworks/math/ofVec2f.cpp"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofVec2f.cpp</span></a><!----></div><div class="item ofVec2f.h"><a href="/openframeworks/math/ofVec2f_h" title="/openframeworks/math/ofVec2f.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofVec2f.h</span></a><!----></div><div class="item ofVec3f.h"><a href="/openframeworks/math/ofVec3f_h" title="/openframeworks/math/ofVec3f.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofVec3f.h</span></a><!----></div><div class="item ofVec4f.cpp"><a href="/openframeworks/math/ofVec4f_cpp" title="/openframeworks/math/ofVec4f.cpp"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofVec4f.cpp</span></a><!----></div><div class="item ofVec4f.h"><a href="/openframeworks/math/ofVec4f_h" title="/openframeworks/math/ofVec4f.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofVec4f.h</span></a><!----></div><div class="item ofVectorMath.h"><a href="/openframeworks/math/ofVectorMath_h" title="/openframeworks/math/ofVectorMath.h"><i class="ico" style="display:none"></i><span style="display:none"></span><span>ofVectorMath.h</span></a><!----></div></div></div><div class="item sound"><a href="/openframeworks/sound/" title="/openframeworks/sound/"><i class="ico" style="display:none">volume_up</i><span style="display:none"></span><span>sound</span></a><!----></div><div class="item types"><a href="/openframeworks/types/" title="/openframeworks/types/"><i class="ico" style="display:none">ring_volume</i><span style="display:none"></span><span>types</span></a><!----></div><div class="item utils"><a href="/openframeworks/utils/" title="/openframeworks/utils/"><i class="ico" style="display:none">build</i><span style="display:none"></span><span>utils</span></a><!----></div><div class="item video"><a href="/openframeworks/video/" title="/openframeworks/video/"><i class="ico" style="display:none">videocam</i><span style="display:none"></span><span>video</span></a><!----></div></div></div><div class="item addons"><a href="/addons/" title="/addons/"><i class="ico" style="display:none">extension</i><span>addons</span><span style="display:none">addons</span></a><!----></div><div class="item guides"><a href="/guides/" title="/guides/"><i class="ico" style="display:none"></i><span>guides</span><span style="display:none">guides</span></a><!----></div></div></div></div><div id="document"><div id="renderer" class="main"><div absolute="/Users/gilbertsinnott/Code/openFrameworks/libs/openFrameworks/math/ofMatrix4x4.cpp" route="/openframeworks/math/ofMatrix4x4.cpp" dir="../libs/openFrameworks/math" ext="cpp" type="source" id="290" parent="284" siblings="" translations="[object Object]" class="doc-header"><div class="doc-header-inner"><div class="inner"><div class="mt2 mb2"><span class="breadcrumbs"><span class="crumb"><a href="/" class="pink nuxt-link-active">ofDocs</a><span class="chevron right"></span></span><span class="crumb"><a href="/openframeworks/" class="pink nuxt-link-active">openframeworks </a><!----><span class="chevron right"></span></span><span class="crumb"><a href="/openframeworks/math/" class="pink nuxt-link-active">math </a><!----><span class="chevron right"></span></span><span class="crumb"><!----><span class="link selector"><span>ofMatrix4x4.cpp </span><span class="chevron bottom"></span><select><option value="/openframeworks/math/ofMath_cpp">ofMath.cpp</option><option value="/openframeworks/math/ofMath_h">ofMath.h</option><option value="/openframeworks/math/ofMathConstants_h">ofMathConstants.h</option><option value="/openframeworks/math/ofMatrix3x3_cpp">ofMatrix3x3.cpp</option><option value="/openframeworks/math/ofMatrix3x3_h">ofMatrix3x3.h</option><option value="/openframeworks/math/ofMatrix4x4_cpp">ofMatrix4x4.cpp</option><option value="/openframeworks/math/ofMatrix4x4_h">ofMatrix4x4.h</option><option value="/openframeworks/math/ofQuaternion_cpp">ofQuaternion.cpp</option><option value="/openframeworks/math/ofQuaternion_h">ofQuaternion.h</option><option value="/openframeworks/math/ofVec2f_cpp">ofVec2f.cpp</option><option value="/openframeworks/math/ofVec2f_h">ofVec2f.h</option><option value="/openframeworks/math/ofVec3f_h">ofVec3f.h</option><option value="/openframeworks/math/ofVec4f_cpp">ofVec4f.cpp</option><option value="/openframeworks/math/ofVec4f_h">ofVec4f.h</option><option value="/openframeworks/math/ofVectorMath_h">ofVectorMath.h</option></select></span><!----></span></span></div></div></div></div><div id="code-page" static="true" class="markdown"><div id="side-menu"><!----><div id="see-also" filename="math" absolute="/Users/gilbertsinnott/Code/openFrameworks/libs/openFrameworks/math" dir="../libs/openFrameworks" route="/openframeworks/math/" ext="" type="folder" children="285,286,287,288,289,290,291,292,293,294,295,296,297,298,299" icon="border_clear" parent="195" breadcrumbs="195" class="see-also"><h4>See also</h4><div class="also"><a href="/documentation/math/"><span class="origin">documentation</span><span class="name">math</span></a></div><div class="also"><a href="/examples/math/"><span class="origin">examples</span><span class="name">math</span></a></div></div></div><div id="code-render"><div class="inner"><pre><code>



<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofMatrix4x4.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ofConstants.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;limits></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iomanip></span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> (_MSC_VER)</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> min</span>
<span class="token comment" spellcheck="true">// see: http://stackoverflow.com/questions/1904635/warning-c4003-and-errors-c2589-and-c2059-on-x-stdnumericlimitsintmax</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token function">equivalent</span><span class="token punctuation">(</span><span class="token keyword">double</span> lhs<span class="token punctuation">,</span><span class="token keyword">double</span> rhs<span class="token punctuation">,</span><span class="token keyword">double</span> epsilon<span class="token operator">=</span><span class="token number">1e-6</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token keyword">double</span> delta <span class="token operator">=</span> rhs<span class="token operator">-</span>lhs<span class="token punctuation">;</span> <span class="token keyword">return</span> delta<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token operator">?</span>delta<span class="token operator">>=</span><span class="token operator">-</span>epsilon<span class="token operator">:</span>delta<span class="token operator">&lt;=</span>epsilon<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">inline</span> T <span class="token function">square</span><span class="token punctuation">(</span>T v<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> v<span class="token operator">*</span>v<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">define</span> SET_ROW(row, v1, v2, v3, v4 )    \
_mat[(row)][0] = (v1); \
_mat[(row)][1] = (v2); \
_mat[(row)][2] = (v3); \
_mat[(row)][3] = (v4);</span>

<span class="token macro property">#<span class="token directive keyword">define</span> INNER_PRODUCT(a,b,r,c) \
((a)._mat[r][0] * (b)._mat[0][c]) \
+((a)._mat[r][1] * (b)._mat[1][c]) \
+((a)._mat[r][2] * (b)._mat[2][c]) \
+((a)._mat[r][3] * (b)._mat[3][c])</span>

ofMatrix4x4<span class="token operator">::</span><span class="token function">ofMatrix4x4</span><span class="token punctuation">(</span> <span class="token keyword">float</span> a00<span class="token punctuation">,</span> <span class="token keyword">float</span> a01<span class="token punctuation">,</span> <span class="token keyword">float</span> a02<span class="token punctuation">,</span> <span class="token keyword">float</span> a03<span class="token punctuation">,</span>
											 <span class="token keyword">float</span> a10<span class="token punctuation">,</span> <span class="token keyword">float</span> a11<span class="token punctuation">,</span> <span class="token keyword">float</span> a12<span class="token punctuation">,</span> <span class="token keyword">float</span> a13<span class="token punctuation">,</span>
											 <span class="token keyword">float</span> a20<span class="token punctuation">,</span> <span class="token keyword">float</span> a21<span class="token punctuation">,</span> <span class="token keyword">float</span> a22<span class="token punctuation">,</span> <span class="token keyword">float</span> a23<span class="token punctuation">,</span>
											 <span class="token keyword">float</span> a30<span class="token punctuation">,</span> <span class="token keyword">float</span> a31<span class="token punctuation">,</span> <span class="token keyword">float</span> a32<span class="token punctuation">,</span> <span class="token keyword">float</span> a33<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> a00<span class="token punctuation">,</span> a01<span class="token punctuation">,</span> a02<span class="token punctuation">,</span> a03 <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> a10<span class="token punctuation">,</span> a11<span class="token punctuation">,</span> a12<span class="token punctuation">,</span> a13 <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> a20<span class="token punctuation">,</span> a21<span class="token punctuation">,</span> a22<span class="token punctuation">,</span> a23 <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> a30<span class="token punctuation">,</span> a31<span class="token punctuation">,</span> a32<span class="token punctuation">,</span> a33 <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">set</span><span class="token punctuation">(</span> <span class="token keyword">float</span> a00<span class="token punctuation">,</span> <span class="token keyword">float</span> a01<span class="token punctuation">,</span> <span class="token keyword">float</span> a02<span class="token punctuation">,</span> <span class="token keyword">float</span> a03<span class="token punctuation">,</span>
								<span class="token keyword">float</span> a10<span class="token punctuation">,</span> <span class="token keyword">float</span> a11<span class="token punctuation">,</span> <span class="token keyword">float</span> a12<span class="token punctuation">,</span> <span class="token keyword">float</span> a13<span class="token punctuation">,</span>
								<span class="token keyword">float</span> a20<span class="token punctuation">,</span> <span class="token keyword">float</span> a21<span class="token punctuation">,</span> <span class="token keyword">float</span> a22<span class="token punctuation">,</span> <span class="token keyword">float</span> a23<span class="token punctuation">,</span>
								<span class="token keyword">float</span> a30<span class="token punctuation">,</span> <span class="token keyword">float</span> a31<span class="token punctuation">,</span> <span class="token keyword">float</span> a32<span class="token punctuation">,</span> <span class="token keyword">float</span> a33<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> a00<span class="token punctuation">,</span> a01<span class="token punctuation">,</span> a02<span class="token punctuation">,</span> a03 <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> a10<span class="token punctuation">,</span> a11<span class="token punctuation">,</span> a12<span class="token punctuation">,</span> a13 <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> a20<span class="token punctuation">,</span> a21<span class="token punctuation">,</span> a22<span class="token punctuation">,</span> a23 <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> a30<span class="token punctuation">,</span> a31<span class="token punctuation">,</span> a32<span class="token punctuation">,</span> a33 <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">define</span> QX  q._v[0]</span>
<span class="token macro property">#<span class="token directive keyword">define</span> QY  q._v[1]</span>
<span class="token macro property">#<span class="token directive keyword">define</span> QZ  q._v[2]</span>
<span class="token macro property">#<span class="token directive keyword">define</span> QW  q._v[3]</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">setRotate</span><span class="token punctuation">(</span><span class="token keyword">const</span> ofQuaternion<span class="token operator">&</span> q<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> length2 <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">length2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fabs</span><span class="token punctuation">(</span>length2<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> std<span class="token operator">::</span>numeric_limits<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span><span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">double</span> rlength2<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// normalize quat if required.</span>
        <span class="token comment" spellcheck="true">// We can avoid the expensive sqrt in this case since all 'coefficients' below are products of two q components.</span>
        <span class="token comment" spellcheck="true">// That is a square of a square root, so it is possible to avoid that</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>length2 <span class="token operator">!=</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            rlength2 <span class="token operator">=</span> <span class="token number">2.0</span><span class="token operator">/</span>length2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            rlength2 <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Source: Gamasutra, Rotating Objects Using Quaternions</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token comment" spellcheck="true">//http://www.gamasutra.com/features/19980703/quaternions_01.htm</span>

        <span class="token keyword">double</span> wx<span class="token punctuation">,</span> wy<span class="token punctuation">,</span> wz<span class="token punctuation">,</span> xx<span class="token punctuation">,</span> yy<span class="token punctuation">,</span> yz<span class="token punctuation">,</span> xy<span class="token punctuation">,</span> xz<span class="token punctuation">,</span> zz<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> z2<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// calculate coefficients</span>
        x2 <span class="token operator">=</span> rlength2<span class="token operator">*</span>QX<span class="token punctuation">;</span>
        y2 <span class="token operator">=</span> rlength2<span class="token operator">*</span>QY<span class="token punctuation">;</span>
        z2 <span class="token operator">=</span> rlength2<span class="token operator">*</span>QZ<span class="token punctuation">;</span>

        xx <span class="token operator">=</span> QX <span class="token operator">*</span> x2<span class="token punctuation">;</span>
        xy <span class="token operator">=</span> QX <span class="token operator">*</span> y2<span class="token punctuation">;</span>
        xz <span class="token operator">=</span> QX <span class="token operator">*</span> z2<span class="token punctuation">;</span>

        yy <span class="token operator">=</span> QY <span class="token operator">*</span> y2<span class="token punctuation">;</span>
        yz <span class="token operator">=</span> QY <span class="token operator">*</span> z2<span class="token punctuation">;</span>
        zz <span class="token operator">=</span> QZ <span class="token operator">*</span> z2<span class="token punctuation">;</span>

        wx <span class="token operator">=</span> QW <span class="token operator">*</span> x2<span class="token punctuation">;</span>
        wy <span class="token operator">=</span> QW <span class="token operator">*</span> y2<span class="token punctuation">;</span>
        wz <span class="token operator">=</span> QW <span class="token operator">*</span> z2<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Note.  Gamasutra gets the matrix assignments inverted, resulting</span>
        <span class="token comment" spellcheck="true">// in left-handed rotations, which is contrary to OpenGL and OSG's</span>
        <span class="token comment" spellcheck="true">// methodology.  The matrix assignment has been altered in the next</span>
        <span class="token comment" spellcheck="true">// few lines of code to do the right thing.</span>
        <span class="token comment" spellcheck="true">// Don Burns - Oct 13, 2001</span>
        _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token punctuation">(</span>yy <span class="token operator">+</span> zz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> xy <span class="token operator">-</span> wz<span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> xz <span class="token operator">+</span> wy<span class="token punctuation">;</span>


        _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> xy <span class="token operator">+</span> wz<span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token punctuation">(</span>xx <span class="token operator">+</span> zz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> yz <span class="token operator">-</span> wx<span class="token punctuation">;</span>

        _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> xz <span class="token operator">-</span> wy<span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> yz <span class="token operator">+</span> wx<span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token punctuation">(</span>xx <span class="token operator">+</span> yy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
    _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//ofQuaternion ofMatrix4x4::getRotate() const {</span>
<span class="token comment" spellcheck="true">//	ofVec4f q;</span>
<span class="token comment" spellcheck="true">//	float trace = _mat[0][0] + _mat[1][1] + _mat[2][2]; // I removed + 1.0f; see discussion with Ethan</span>
<span class="token comment" spellcheck="true">//	if( trace > 0 ) {// I changed M_EPSILON to 0</span>
<span class="token comment" spellcheck="true">//		float s = 0.5f / sqrtf(trace+ 1.0f);</span>
<span class="token comment" spellcheck="true">//		q.w = 0.25f / s;</span>
<span class="token comment" spellcheck="true">//		q.x = ( _mat[2][1] - _mat[1][2] ) * s;</span>
<span class="token comment" spellcheck="true">//		q.y = ( _mat[0][2] - _mat[2][0] ) * s;</span>
<span class="token comment" spellcheck="true">//		q.z = ( _mat[1][0] - _mat[0][1] ) * s;</span>
<span class="token comment" spellcheck="true">//	} else {</span>
<span class="token comment" spellcheck="true">//		if ( _mat[0][0] > _mat[1][1] && _mat[0][0] > _mat[2][2] ) {</span>
<span class="token comment" spellcheck="true">//			float s = 2.0f * sqrtf( 1.0f + _mat[0][0] - _mat[1][1] - _mat[2][2]);</span>
<span class="token comment" spellcheck="true">//			q.w = (_mat[2][1] - _mat[1][2] ) / s;</span>
<span class="token comment" spellcheck="true">//			q.x = 0.25f * s;</span>
<span class="token comment" spellcheck="true">//			q.y = (_mat[0][1] + _mat[1][0] ) / s;</span>
<span class="token comment" spellcheck="true">//			q.z = (_mat[0][2] + _mat[2][0] ) / s;</span>
<span class="token comment" spellcheck="true">//		} else if (_mat[1][1] > _mat[2][2]) {</span>
<span class="token comment" spellcheck="true">//			float s = 2.0f * sqrtf( 1.0f + _mat[1][1] - _mat[0][0] - _mat[2][2]);</span>
<span class="token comment" spellcheck="true">//			q.w = (_mat[0][2] - _mat[2][0] ) / s;</span>
<span class="token comment" spellcheck="true">//			q.x = (_mat[0][1] + _mat[1][0] ) / s;</span>
<span class="token comment" spellcheck="true">//			q.y = 0.25f * s;</span>
<span class="token comment" spellcheck="true">//			q.z = (_mat[1][2] + _mat[2][1] ) / s;</span>
<span class="token comment" spellcheck="true">//		} else {</span>
<span class="token comment" spellcheck="true">//			float s = 2.0f * sqrtf( 1.0f + _mat[2][2] - _mat[0][0] - _mat[1][1] );</span>
<span class="token comment" spellcheck="true">//			q.w = (_mat[1][0] - _mat[0][1] ) / s;</span>
<span class="token comment" spellcheck="true">//			q.x = (_mat[0][2] + _mat[2][0] ) / s;</span>
<span class="token comment" spellcheck="true">//			q.y = (_mat[1][2] + _mat[2][1] ) / s;</span>
<span class="token comment" spellcheck="true">//			q.z = 0.25f * s;</span>
<span class="token comment" spellcheck="true">//		}</span>
<span class="token comment" spellcheck="true">//	}</span>
<span class="token comment" spellcheck="true">//	return ofQuaternion(q.x, q.y, q.z, q.w);</span>
<span class="token comment" spellcheck="true">//}</span>

<span class="token comment" spellcheck="true">//#define COMPILE_getRotate_David_Spillings_Mk1</span>
<span class="token comment" spellcheck="true">//#define COMPILE_getRotate_David_Spillings_Mk2</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COMPILE_getRotate_Original</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> COMPILE_getRotate_David_Spillings_Mk1</span>
<span class="token comment" spellcheck="true">// David Spillings implementation Mk 1</span>
ofQuaternion ofMatrix4x4<span class="token operator">::</span><span class="token function">getRotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
	ofQuaternion q<span class="token punctuation">;</span>

    <span class="token keyword">float</span> s<span class="token punctuation">;</span>
    <span class="token keyword">float</span> tq<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>    i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Use tq to store the largest trace</span>
    tq<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    tq<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    tq<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    tq<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Find the maximum (could also use stacked if's later)</span>
    j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> j <span class="token operator">=</span> <span class="token punctuation">(</span>tq<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">></span>tq<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span> i <span class="token operator">:</span> j<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// check the diagonal</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>j<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* perform instant calculation */</span>
        QW <span class="token operator">=</span> tq<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QX <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QY <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QZ <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>j<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        QW <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QX <span class="token operator">=</span> tq<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QY <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QZ <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>j<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        QW <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QX <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QY <span class="token operator">=</span> tq<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QZ <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token comment" spellcheck="true">/* if (j==3) */</span>
    <span class="token punctuation">{</span>
        QW <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QX <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QY <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QZ <span class="token operator">=</span> tq<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    s <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">0.25</span><span class="token operator">/</span>tq<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QW <span class="token operator">*</span><span class="token operator">=</span> s<span class="token punctuation">;</span>
    QX <span class="token operator">*</span><span class="token operator">=</span> s<span class="token punctuation">;</span>
    QY <span class="token operator">*</span><span class="token operator">=</span> s<span class="token punctuation">;</span>
    QZ <span class="token operator">*</span><span class="token operator">=</span> s<span class="token punctuation">;</span>

    <span class="token keyword">return</span> q<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>


<span class="token macro property">#<span class="token directive keyword">ifdef</span> COMPILE_getRotate_David_Spillings_Mk2</span>
<span class="token comment" spellcheck="true">// David Spillings implementation Mk 2</span>
ofQuaternion ofMatrix4x4<span class="token operator">::</span><span class="token function">getRotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    ofQuaternion q<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// From http://www.euclideanspace.com/maths/geometry/rotations/conversions/matrixToQuaternion/index.htm</span>
    QW <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span> osg<span class="token operator">::</span><span class="token function">maximum</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">+</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    QX <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span> osg<span class="token operator">::</span><span class="token function">maximum</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">+</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    QY <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span> osg<span class="token operator">::</span><span class="token function">maximum</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    QZ <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span> osg<span class="token operator">::</span><span class="token function">maximum</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
    <span class="token comment" spellcheck="true">// Robert Osfield, June 7th 2007, arggg this new implementation produces many many errors, so have to revert to sign(..) orignal below.</span>
    QX <span class="token operator">=</span> QX <span class="token operator">*</span> osg<span class="token operator">::</span><span class="token function">signOrZero</span><span class="token punctuation">(</span>  _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    QY <span class="token operator">=</span> QY <span class="token operator">*</span> osg<span class="token operator">::</span><span class="token function">signOrZero</span><span class="token punctuation">(</span>  _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    QZ <span class="token operator">=</span> QZ <span class="token operator">*</span> osg<span class="token operator">::</span><span class="token function">signOrZero</span><span class="token punctuation">(</span>  _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
    QX <span class="token operator">=</span> QX <span class="token operator">*</span> osg<span class="token operator">::</span><span class="token function">sign</span><span class="token punctuation">(</span>  _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    QY <span class="token operator">=</span> QY <span class="token operator">*</span> osg<span class="token operator">::</span><span class="token function">sign</span><span class="token punctuation">(</span>  _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    QZ <span class="token operator">=</span> QZ <span class="token operator">*</span> osg<span class="token operator">::</span><span class="token function">sign</span><span class="token punctuation">(</span>  _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token keyword">return</span> q<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> COMPILE_getRotate_Original</span>
<span class="token comment" spellcheck="true">// Original implementation</span>
ofQuaternion ofMatrix4x4<span class="token operator">::</span><span class="token function">getRotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    ofQuaternion q<span class="token punctuation">;</span>

    ofMatrix4x4 mat <span class="token operator">=</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    ofVec3f vs <span class="token operator">=</span> mat<span class="token punctuation">.</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mat<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span>vs<span class="token punctuation">.</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span>vs<span class="token punctuation">.</span>y<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span>vs<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ofVec4f<span class="token operator">*</span> m <span class="token operator">=</span> mat<span class="token punctuation">.</span>_mat<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Source: Gamasutra, Rotating Objects Using Quaternions</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token comment" spellcheck="true">//http://www.gamasutra.com/features/programming/19980703/quaternions_01.htm</span>

    <span class="token keyword">float</span>  tr<span class="token punctuation">,</span> s<span class="token punctuation">;</span>
    <span class="token keyword">float</span> tq<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>    i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span>

    <span class="token keyword">int</span> nxt<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    tr <span class="token operator">=</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// check the diagonal</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tr <span class="token operator">></span> <span class="token number">0.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token function">sqrt</span> <span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        QW <span class="token operator">=</span> s <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
        s <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">/</span> s<span class="token punctuation">;</span>
        QX <span class="token operator">=</span> <span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">;</span>
        QY <span class="token operator">=</span> <span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">;</span>
        QZ <span class="token operator">=</span> <span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// diagonal is negative</span>
        i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">></span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">></span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        j <span class="token operator">=</span> nxt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        k <span class="token operator">=</span> nxt<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

        s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token function">sqrt</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">(</span>m<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> m<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        tq<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
            s <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">/</span> s<span class="token punctuation">;</span>

        tq<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>m<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">-</span> m<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">;</span>
        tq<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> m<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">;</span>
        tq<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">+</span> m<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">;</span>

        QX <span class="token operator">=</span> tq<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QY <span class="token operator">=</span> tq<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QZ <span class="token operator">=</span> tq<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        QW <span class="token operator">=</span> tq<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> q<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>


<span class="token comment" spellcheck="true">//int ofMatrix4x4::compare(const ofMatrix4x4& m) const</span>
<span class="token comment" spellcheck="true">//{</span>
<span class="token comment" spellcheck="true">//    const ofMatrix4x4::float* lhs = reinterpret_cast&lt;const ofMatrix4x4::float*>(_mat);</span>
<span class="token comment" spellcheck="true">//    const ofMatrix4x4::float* end_lhs = lhs+16;</span>
<span class="token comment" spellcheck="true">//    const ofMatrix4x4::float* rhs = reinterpret_cast&lt;const ofMatrix4x4::float*>(m._mat);</span>
<span class="token comment" spellcheck="true">//    for(;lhs!=end_lhs;++lhs,++rhs)</span>
<span class="token comment" spellcheck="true">//    {</span>
<span class="token comment" spellcheck="true">//        if (*lhs &lt; *rhs) return -1;</span>
<span class="token comment" spellcheck="true">//        if (*rhs &lt; *lhs) return 1;</span>
<span class="token comment" spellcheck="true">//    }</span>
<span class="token comment" spellcheck="true">//    return 0;</span>
<span class="token comment" spellcheck="true">//}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">setTranslation</span><span class="token punctuation">(</span> <span class="token keyword">float</span> tx<span class="token punctuation">,</span> <span class="token keyword">float</span> ty<span class="token punctuation">,</span> <span class="token keyword">float</span> tz <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> tx<span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ty<span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> tz<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">setTranslation</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> v <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeIdentityMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeScaleMatrix</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> v <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">makeScaleMatrix</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeScaleMatrix</span><span class="token punctuation">(</span> <span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token keyword">float</span> z <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>    x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeTranslationMatrix</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> v <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">makeTranslationMatrix</span><span class="token punctuation">(</span> v<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">getPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeTranslationMatrix</span><span class="token punctuation">(</span> <span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token keyword">float</span> z <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>    x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeRotationMatrix</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> from<span class="token punctuation">,</span> <span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> to <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">makeIdentityMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ofQuaternion quat<span class="token punctuation">;</span>
    quat<span class="token punctuation">.</span><span class="token function">makeRotate</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setRotate</span><span class="token punctuation">(</span>quat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeRotationMatrix</span><span class="token punctuation">(</span> <span class="token keyword">float</span> angle<span class="token punctuation">,</span> <span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> axis <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">makeIdentityMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ofQuaternion quat<span class="token punctuation">;</span>
    quat<span class="token punctuation">.</span><span class="token function">makeRotate</span><span class="token punctuation">(</span> angle<span class="token punctuation">,</span> axis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setRotate</span><span class="token punctuation">(</span>quat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeRotationMatrix</span><span class="token punctuation">(</span> <span class="token keyword">float</span> angle<span class="token punctuation">,</span> <span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token keyword">float</span> z <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">makeIdentityMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ofQuaternion quat<span class="token punctuation">;</span>
    quat<span class="token punctuation">.</span><span class="token function">makeRotate</span><span class="token punctuation">(</span> angle<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setRotate</span><span class="token punctuation">(</span>quat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeRotationMatrix</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofQuaternion<span class="token operator">&</span> quat <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">makeIdentityMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setRotate</span><span class="token punctuation">(</span>quat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeRotationMatrix</span><span class="token punctuation">(</span> <span class="token keyword">float</span> angle1<span class="token punctuation">,</span> <span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> axis1<span class="token punctuation">,</span>
									   <span class="token keyword">float</span> angle2<span class="token punctuation">,</span> <span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> axis2<span class="token punctuation">,</span>
									   <span class="token keyword">float</span> angle3<span class="token punctuation">,</span> <span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> axis3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">makeIdentityMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ofQuaternion quat<span class="token punctuation">;</span>
    quat<span class="token punctuation">.</span><span class="token function">makeRotate</span><span class="token punctuation">(</span>angle1<span class="token punctuation">,</span> axis1<span class="token punctuation">,</span>
                    angle2<span class="token punctuation">,</span> axis2<span class="token punctuation">,</span>
                    angle3<span class="token punctuation">,</span> axis3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setRotate</span><span class="token punctuation">(</span>quat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeFromMultiplicationOf</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofMatrix4x4<span class="token operator">&</span> lhs<span class="token punctuation">,</span> <span class="token keyword">const</span> ofMatrix4x4<span class="token operator">&</span> rhs <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&</span>lhs<span class="token operator">==</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">postMult</span><span class="token punctuation">(</span>rhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&</span>rhs<span class="token operator">==</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">preMult</span><span class="token punctuation">(</span>lhs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment" spellcheck="true">// PRECONDITION: We assume neither &lhs nor &rhs == this</span>
	<span class="token comment" spellcheck="true">// if it did, use preMult or postMult instead</span>
    _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">preMult</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofMatrix4x4<span class="token operator">&</span> other <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// brute force method requiring a copy</span>
    <span class="token comment" spellcheck="true">//ofMatrix4x4 tmp(other* *this);</span>
    <span class="token comment" spellcheck="true">// *this = tmp;</span>

    <span class="token comment" spellcheck="true">// more efficient method just use a float[4] for temporary storage.</span>
    <span class="token keyword">float</span> t<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> col<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> col<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>col<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span> other<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> col <span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span> other<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> col <span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span> other<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> col <span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span> other<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> col <span class="token punctuation">)</span><span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">postMult</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofMatrix4x4<span class="token operator">&</span> other <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// brute force method requiring a copy</span>
    <span class="token comment" spellcheck="true">//ofMatrix4x4 tmp(*this * other);</span>
    <span class="token comment" spellcheck="true">// *this = tmp;</span>

    <span class="token comment" spellcheck="true">// more efficient method just use a float[4] for temporary storage.</span>
    <span class="token keyword">float</span> t<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> row<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> row<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>row<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> other<span class="token punctuation">,</span> row<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> other<span class="token punctuation">,</span> row<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> other<span class="token punctuation">,</span> row<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">INNER_PRODUCT</span><span class="token punctuation">(</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> other<span class="token punctuation">,</span> row<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SET_ROW</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">undef</span> INNER_PRODUCT</span>

<span class="token comment" spellcheck="true">// orthoNormalize the 3x3 rotation matrix</span>
<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeOrthoNormalOf</span><span class="token punctuation">(</span><span class="token keyword">const</span> ofMatrix4x4<span class="token operator">&</span> rhs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">float</span> x_colMag <span class="token operator">=</span> <span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> y_colMag <span class="token operator">=</span> <span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> z_colMag <span class="token operator">=</span> <span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">equivalent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>x_colMag<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">&&</span> <span class="token operator">!</span><span class="token function">equivalent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>x_colMag<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		x_colMag <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>x_colMag<span class="token punctuation">)</span><span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> x_colMag<span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> x_colMag<span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> x_colMag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
		_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">equivalent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>y_colMag<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">&&</span> <span class="token operator">!</span><span class="token function">equivalent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>y_colMag<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		y_colMag <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>y_colMag<span class="token punctuation">)</span><span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> y_colMag<span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> y_colMag<span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> y_colMag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
		_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">equivalent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>z_colMag<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">&&</span> <span class="token operator">!</span><span class="token function">equivalent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>z_colMag<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		z_colMag <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>z_colMag<span class="token punctuation">)</span><span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> z_colMag<span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> z_colMag<span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> z_colMag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
		_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">/** 4x3 matrix invert, not right hand column is assumed to be 0,0,0,1. */</span>
<span class="token keyword">bool</span> <span class="token function">invert_4x3</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofMatrix4x4<span class="token operator">&</span> src<span class="token punctuation">,</span> ofMatrix4x4 <span class="token operator">&</span> dst<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/** full 4x4 matrix invert. */</span>
<span class="token keyword">bool</span> <span class="token function">invert_4x4</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofMatrix4x4<span class="token operator">&</span> rhs<span class="token punctuation">,</span> ofMatrix4x4 <span class="token operator">&</span> dst<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">bool</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeInvertOf</span><span class="token punctuation">(</span><span class="token keyword">const</span> ofMatrix4x4 <span class="token operator">&</span> rhs<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">bool</span> is_4x3 <span class="token operator">=</span> <span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0.0f</span> <span class="token operator">&&</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0.0f</span> <span class="token operator">&&</span>  rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0.0f</span> <span class="token operator">&&</span> rhs<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> is_4x3 <span class="token operator">?</span> <span class="token function">invert_4x3</span><span class="token punctuation">(</span>rhs<span class="token punctuation">,</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span>  <span class="token function">invert_4x4</span><span class="token punctuation">(</span>rhs<span class="token punctuation">,</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ofMatrix4x4 ofMatrix4x4<span class="token operator">::</span><span class="token function">getInverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    ofMatrix4x4 inverse<span class="token punctuation">;</span>
    inverse<span class="token punctuation">.</span><span class="token function">makeInvertOf</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> inverse<span class="token punctuation">;</span>
<span class="token punctuation">}</span>





<span class="token comment" spellcheck="true">/******************************************
 Matrix inversion technique:
 Given a matrix mat, we want to invert it.
 mat = [ r00 r01 r02 a
 r10 r11 r12 b
 r20 r21 r22 c
 tx  ty  tz  d ]
 We note that this matrix can be split into three matrices.
 mat = rot * trans * corr, where rot is rotation part, trans is translation part, and corr is the correction due to perspective (if any).
 rot = [ r00 r01 r02 0
 r10 r11 r12 0
 r20 r21 r22 0
 0   0   0   1 ]
 trans = [ 1  0  0  0
 0  1  0  0
 0  0  1  0
 tx ty tz 1 ]
 corr = [ 1 0 0 px
 0 1 0 py
 0 0 1 pz
 0 0 0 s ]
 where the elements of corr are obtained from linear combinations of the elements of rot, trans, and mat.
 So the inverse is mat' = (trans * corr)' * rot', where rot' must be computed the traditional way, which is easy since it is only a 3x3 matrix.
 This problem is simplified if [px py pz s] = [0 0 0 1], which will happen if mat was composed only of rotations, scales, and translations (which is common).  In this case, we can ignore corr entirely which saves on a lot of computations.
 ******************************************/</span>

<span class="token keyword">bool</span> <span class="token function">invert_4x3</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofMatrix4x4<span class="token operator">&</span> src<span class="token punctuation">,</span> ofMatrix4x4 <span class="token operator">&</span> dst <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&</span>src<span class="token operator">==</span><span class="token operator">&</span>dst<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		ofMatrix4x4 <span class="token function">tm</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">invert_4x3</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">float</span> r00<span class="token punctuation">,</span> r01<span class="token punctuation">,</span> r02<span class="token punctuation">,</span>
	r10<span class="token punctuation">,</span> r11<span class="token punctuation">,</span> r12<span class="token punctuation">,</span>
	r20<span class="token punctuation">,</span> r21<span class="token punctuation">,</span> r22<span class="token punctuation">;</span>
	<span class="token comment" spellcheck="true">// Copy rotation components directly into registers for speed</span>
    r00 <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> r01 <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> r02 <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    r10 <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> r11 <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> r12 <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    r20 <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> r21 <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> r22 <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">// Partially compute inverse of rot</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> r11<span class="token operator">*</span>r22 <span class="token operator">-</span> r12<span class="token operator">*</span>r21<span class="token punctuation">;</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> r02<span class="token operator">*</span>r21 <span class="token operator">-</span> r01<span class="token operator">*</span>r22<span class="token punctuation">;</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> r01<span class="token operator">*</span>r12 <span class="token operator">-</span> r02<span class="token operator">*</span>r11<span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">// Compute determinant of rot from 3 elements just computed</span>
    <span class="token keyword">float</span> one_over_det <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>r00<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> r10<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> r20<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r00 <span class="token operator">*</span><span class="token operator">=</span> one_over_det<span class="token punctuation">;</span> r10 <span class="token operator">*</span><span class="token operator">=</span> one_over_det<span class="token punctuation">;</span> r20 <span class="token operator">*</span><span class="token operator">=</span> one_over_det<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Saves on later computations</span>

	<span class="token comment" spellcheck="true">// Finish computing inverse of rot</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span><span class="token operator">=</span> one_over_det<span class="token punctuation">;</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span><span class="token operator">=</span> one_over_det<span class="token punctuation">;</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span><span class="token operator">=</span> one_over_det<span class="token punctuation">;</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> r12<span class="token operator">*</span>r20 <span class="token operator">-</span> r10<span class="token operator">*</span>r22<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Have already been divided by det</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> r00<span class="token operator">*</span>r22 <span class="token operator">-</span> r02<span class="token operator">*</span>r20<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// same</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> r02<span class="token operator">*</span>r10 <span class="token operator">-</span> r00<span class="token operator">*</span>r12<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// same</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> r10<span class="token operator">*</span>r21 <span class="token operator">-</span> r11<span class="token operator">*</span>r20<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Have already been divided by det</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> r01<span class="token operator">*</span>r20 <span class="token operator">-</span> r00<span class="token operator">*</span>r21<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// same</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> r00<span class="token operator">*</span>r11 <span class="token operator">-</span> r01<span class="token operator">*</span>r10<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// same</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">// We no longer need the rxx or det variables anymore, so we can reuse them for whatever we want.  But we will still rename them for the sake of clarity.</span>

<span class="token macro property">#<span class="token directive keyword">define</span> d r22</span>
    d  <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">square</span><span class="token punctuation">(</span>d<span class="token number">-1.0</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1.0e-6</span> <span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// Involves perspective, so we must</span>
    <span class="token punctuation">{</span>                       <span class="token comment" spellcheck="true">// compute the full inverse</span>

        ofMatrix4x4 TPinv<span class="token punctuation">;</span>
        dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> px r00</span>
<span class="token macro property">#<span class="token directive keyword">define</span> py r01</span>
<span class="token macro property">#<span class="token directive keyword">define</span> pz r02</span>
<span class="token macro property">#<span class="token directive keyword">define</span> one_over_s  one_over_det</span>
<span class="token macro property">#<span class="token directive keyword">define</span> a  r10</span>
<span class="token macro property">#<span class="token directive keyword">define</span> b  r11</span>
<span class="token macro property">#<span class="token directive keyword">define</span> c  r12</span>

        a  <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> b  <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> c  <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        px <span class="token operator">=</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>a <span class="token operator">+</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>b <span class="token operator">+</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>c<span class="token punctuation">;</span>
        py <span class="token operator">=</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>a <span class="token operator">+</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>b <span class="token operator">+</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>c<span class="token punctuation">;</span>
        pz <span class="token operator">=</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>a <span class="token operator">+</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>b <span class="token operator">+</span> dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>c<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">undef</span> a</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> b</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> c</span>
<span class="token macro property">#<span class="token directive keyword">define</span> tx r10</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ty r11</span>
<span class="token macro property">#<span class="token directive keyword">define</span> tz r12</span>

        tx <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ty <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> tz <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        one_over_s  <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>d <span class="token operator">-</span> <span class="token punctuation">(</span>tx<span class="token operator">*</span>px <span class="token operator">+</span> ty<span class="token operator">*</span>py <span class="token operator">+</span> tz<span class="token operator">*</span>pz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        tx <span class="token operator">*</span><span class="token operator">=</span> one_over_s<span class="token punctuation">;</span> ty <span class="token operator">*</span><span class="token operator">=</span> one_over_s<span class="token punctuation">;</span> tz <span class="token operator">*</span><span class="token operator">=</span> one_over_s<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Reduces number of calculations later on</span>

        <span class="token comment" spellcheck="true">// Compute inverse of trans*corr</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> tx<span class="token operator">*</span>px <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ty<span class="token operator">*</span>px<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> tz<span class="token operator">*</span>px<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>px <span class="token operator">*</span> one_over_s<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> tx<span class="token operator">*</span>py<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ty<span class="token operator">*</span>py <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> tz<span class="token operator">*</span>py<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>py <span class="token operator">*</span> one_over_s<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> tx<span class="token operator">*</span>pz<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ty<span class="token operator">*</span>pz<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> tz<span class="token operator">*</span>pz <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>pz <span class="token operator">*</span> one_over_s<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>tx<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>ty<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>tz<span class="token punctuation">;</span>
        TPinv<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> one_over_s<span class="token punctuation">;</span>

        dst<span class="token punctuation">.</span><span class="token function">preMult</span><span class="token punctuation">(</span>TPinv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Finish computing full inverse of mat</span>

<span class="token macro property">#<span class="token directive keyword">undef</span> px</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> py</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> pz</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> one_over_s</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> d</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token comment" spellcheck="true">// Rightmost column is [0; 0; 0; 1] so it can be ignored</span>
    <span class="token punctuation">{</span>
        tx <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ty <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> tz <span class="token operator">=</span> src<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Compute translation components of mat'</span>
        dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>tx<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> ty<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> tz<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>tx<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> ty<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> tz<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>tx<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> ty<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> tz<span class="token operator">*</span>dst<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">undef</span> tx</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> ty</span>
<span class="token macro property">#<span class="token directive keyword">undef</span> tz</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span>
<span class="token keyword">inline</span> T <span class="token function">SGL_ABS</span><span class="token punctuation">(</span>T a<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> a <span class="token operator">:</span> <span class="token operator">-</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> SGL_SWAP</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SGL_SWAP(a,b,temp) ((temp)=(a),(a)=(b),(b)=(temp))</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token keyword">bool</span> <span class="token function">invert_4x4</span><span class="token punctuation">(</span> <span class="token keyword">const</span> ofMatrix4x4<span class="token operator">&</span> src<span class="token punctuation">,</span> ofMatrix4x4<span class="token operator">&</span>dst <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&</span>src<span class="token operator">==</span><span class="token operator">&</span>dst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ofMatrix4x4 <span class="token function">tm</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">invert_4x4</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> indxc<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> indxr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ipiv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">,</span>l<span class="token punctuation">,</span>ll<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> icol <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> irow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> temp<span class="token punctuation">,</span> pivinv<span class="token punctuation">,</span> dum<span class="token punctuation">,</span> big<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// copy in place this may be unnecessary</span>
    dst <span class="token operator">=</span> src<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> ipiv<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		big<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ipiv<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>ipiv<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
					<span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SGL_ABS</span><span class="token punctuation">(</span><span class="token function">dst</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> big<span class="token punctuation">)</span>
						<span class="token punctuation">{</span>
							big <span class="token operator">=</span> <span class="token function">SGL_ABS</span><span class="token punctuation">(</span><span class="token function">dst</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							irow<span class="token operator">=</span>j<span class="token punctuation">;</span>
							icol<span class="token operator">=</span>k<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ipiv<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span>
						<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
		<span class="token operator">++</span><span class="token punctuation">(</span>ipiv<span class="token punctuation">[</span>icol<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>irow <span class="token operator">!=</span> icol<span class="token punctuation">)</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>l<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> l<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> l<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">SGL_SWAP</span><span class="token punctuation">(</span><span class="token function">dst</span><span class="token punctuation">(</span>irow<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">,</span>
										 <span class="token function">dst</span><span class="token punctuation">(</span>icol<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">,</span>
										 temp<span class="token punctuation">)</span><span class="token punctuation">;</span>

		indxr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>irow<span class="token punctuation">;</span>
		indxc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>icol<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dst</span><span class="token punctuation">(</span>icol<span class="token punctuation">,</span>icol<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

		pivinv <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token function">dst</span><span class="token punctuation">(</span>icol<span class="token punctuation">,</span>icol<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">dst</span><span class="token punctuation">(</span>icol<span class="token punctuation">,</span>icol<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>l<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> l<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> l<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">dst</span><span class="token punctuation">(</span>icol<span class="token punctuation">,</span>l<span class="token punctuation">)</span> <span class="token operator">*</span><span class="token operator">=</span> pivinv<span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>ll<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> ll<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> ll<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ll <span class="token operator">!=</span> icol<span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				dum<span class="token operator">=</span><span class="token function">dst</span><span class="token punctuation">(</span>ll<span class="token punctuation">,</span>icol<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">dst</span><span class="token punctuation">(</span>ll<span class="token punctuation">,</span>icol<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span>l<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> l<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> l<span class="token operator">++</span><span class="token punctuation">)</span><span class="token function">dst</span><span class="token punctuation">(</span>ll<span class="token punctuation">,</span>l<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">=</span> <span class="token function">dst</span><span class="token punctuation">(</span>icol<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token operator">*</span>dum<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> lx<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span> lx<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>lx<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>indxr<span class="token punctuation">[</span>lx<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> indxc<span class="token punctuation">[</span>lx<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">SGL_SWAP</span><span class="token punctuation">(</span><span class="token function">dst</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>indxr<span class="token punctuation">[</span>lx<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
										 <span class="token function">dst</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>indxc<span class="token punctuation">[</span>lx<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeOrthoMatrix</span><span class="token punctuation">(</span><span class="token keyword">double</span> left<span class="token punctuation">,</span> <span class="token keyword">double</span> right<span class="token punctuation">,</span>
									  <span class="token keyword">double</span> bottom<span class="token punctuation">,</span> <span class="token keyword">double</span> top<span class="token punctuation">,</span>
									  <span class="token keyword">double</span> zNear<span class="token punctuation">,</span> <span class="token keyword">double</span> zFar<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// note transpose of ofMatrix4x4 wr.t OpenGL documentation, since the OSG use post multiplication rather than pre.</span>
    <span class="token keyword">double</span> tx <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>right<span class="token operator">+</span>left<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> ty <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>top<span class="token operator">+</span>bottom<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>top<span class="token operator">-</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> tz <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>zFar<span class="token operator">+</span>zNear<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>zFar<span class="token operator">-</span>zNear<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token operator">/</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token number">0.0</span><span class="token punctuation">,</span>               <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>              <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">2.0</span><span class="token operator">/</span><span class="token punctuation">(</span>top<span class="token operator">-</span>bottom<span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>              <span class="token number">0.0</span><span class="token punctuation">,</span>               <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">2.0</span><span class="token operator">/</span><span class="token punctuation">(</span>zFar<span class="token operator">-</span>zNear<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>               tx<span class="token punctuation">,</span>                ty<span class="token punctuation">,</span>                 tz<span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">getOrtho</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token operator">&</span> left<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">&</span> right<span class="token punctuation">,</span>
									 <span class="token keyword">double</span><span class="token operator">&</span> bottom<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">&</span> top<span class="token punctuation">,</span>
									 <span class="token keyword">double</span><span class="token operator">&</span> zNear<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">&</span> zFar<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0.0</span> <span class="token operator">||</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0.0</span> <span class="token operator">||</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0.0</span> <span class="token operator">||</span> _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    zNear <span class="token operator">=</span> <span class="token punctuation">(</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    zFar <span class="token operator">=</span> <span class="token punctuation">(</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    left <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    right <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    bottom <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    top <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">-</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeFrustumMatrix</span><span class="token punctuation">(</span><span class="token keyword">double</span> left<span class="token punctuation">,</span> <span class="token keyword">double</span> right<span class="token punctuation">,</span>
										<span class="token keyword">double</span> bottom<span class="token punctuation">,</span> <span class="token keyword">double</span> top<span class="token punctuation">,</span>
										<span class="token keyword">double</span> zNear<span class="token punctuation">,</span> <span class="token keyword">double</span> zFar<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// note transpose of ofMatrix4x4 wr.t OpenGL documentation, since the OSG use post multiplication rather than pre.</span>
    <span class="token keyword">double</span> A <span class="token operator">=</span> <span class="token punctuation">(</span>right<span class="token operator">+</span>left<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> B <span class="token operator">=</span> <span class="token punctuation">(</span>top<span class="token operator">+</span>bottom<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>top<span class="token operator">-</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> C <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>zFar<span class="token operator">+</span>zNear<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>zFar<span class="token operator">-</span>zNear<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> D <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2.0</span><span class="token operator">*</span>zFar<span class="token operator">*</span>zNear<span class="token operator">/</span><span class="token punctuation">(</span>zFar<span class="token operator">-</span>zNear<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token operator">*</span>zNear<span class="token operator">/</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>                    <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token operator">*</span>zNear<span class="token operator">/</span><span class="token punctuation">(</span>top<span class="token operator">-</span>bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">0.0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>                      A<span class="token punctuation">,</span>                      B<span class="token punctuation">,</span>   C<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span> <span class="token punctuation">)</span>
    <span class="token function">SET_ROW</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>                    <span class="token number">0.0</span><span class="token punctuation">,</span>                    <span class="token number">0.0</span><span class="token punctuation">,</span>   D<span class="token punctuation">,</span>  <span class="token number">0.0</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">getFrustum</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token operator">&</span> left<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">&</span> right<span class="token punctuation">,</span>
                                       <span class="token keyword">double</span><span class="token operator">&</span> bottom<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">&</span> top<span class="token punctuation">,</span>
                                       <span class="token keyword">double</span><span class="token operator">&</span> zNear<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">&</span> zFar<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0.0</span> <span class="token operator">||</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0.0</span> <span class="token operator">||</span> _mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1.0</span> <span class="token operator">||</span> _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>


    zNear <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    zFar <span class="token operator">=</span> _mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    left <span class="token operator">=</span> zNear <span class="token operator">*</span> <span class="token punctuation">(</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    right <span class="token operator">=</span> zNear <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> _mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    top <span class="token operator">=</span> zNear <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">+</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    bottom <span class="token operator">=</span> zNear <span class="token operator">*</span> <span class="token punctuation">(</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> _mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makePerspectiveMatrix</span><span class="token punctuation">(</span><span class="token keyword">double</span> fovy<span class="token punctuation">,</span><span class="token keyword">double</span> aspectRatio<span class="token punctuation">,</span>
                                            <span class="token keyword">double</span> zNear<span class="token punctuation">,</span> <span class="token keyword">double</span> zFar<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// calculate the appropriate left, right etc.</span>
    <span class="token keyword">double</span> tan_fovy <span class="token operator">=</span> <span class="token function">tan</span><span class="token punctuation">(</span>fovy<span class="token operator">*</span><span class="token number">0.5</span><span class="token operator">*</span>DEG_TO_RAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> right  <span class="token operator">=</span>  tan_fovy <span class="token operator">*</span> aspectRatio <span class="token operator">*</span> zNear<span class="token punctuation">;</span>
    <span class="token keyword">double</span> left   <span class="token operator">=</span> <span class="token operator">-</span>right<span class="token punctuation">;</span>
    <span class="token keyword">double</span> top    <span class="token operator">=</span>  tan_fovy <span class="token operator">*</span> zNear<span class="token punctuation">;</span>
    <span class="token keyword">double</span> bottom <span class="token operator">=</span>  <span class="token operator">-</span>top<span class="token punctuation">;</span>
    <span class="token function">makeFrustumMatrix</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span>right<span class="token punctuation">,</span>bottom<span class="token punctuation">,</span>top<span class="token punctuation">,</span>zNear<span class="token punctuation">,</span>zFar<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">getPerspective</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token operator">&</span> fovy<span class="token punctuation">,</span><span class="token keyword">double</span><span class="token operator">&</span> aspectRatio<span class="token punctuation">,</span>
                                           <span class="token keyword">double</span><span class="token operator">&</span> zNear<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">&</span> zFar<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> right  <span class="token operator">=</span>  <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> left   <span class="token operator">=</span>  <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> top    <span class="token operator">=</span>  <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> bottom <span class="token operator">=</span>  <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getFrustum</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span>right<span class="token punctuation">,</span>bottom<span class="token punctuation">,</span>top<span class="token punctuation">,</span>zNear<span class="token punctuation">,</span>zFar<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        fovy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">atan</span><span class="token punctuation">(</span>top<span class="token operator">/</span>zNear<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">atan</span><span class="token punctuation">(</span>bottom<span class="token operator">/</span>zNear<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span>RAD_TO_DEG<span class="token punctuation">;</span>
        aspectRatio <span class="token operator">=</span> <span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>top<span class="token operator">-</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeLookAtViewMatrix</span><span class="token punctuation">(</span><span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> eye<span class="token punctuation">,</span><span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> center<span class="token punctuation">,</span><span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> up<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ofVec3f zaxis <span class="token operator">=</span> <span class="token punctuation">(</span>eye <span class="token operator">-</span> center<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNormalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ofVec3f xaxis <span class="token operator">=</span> up<span class="token punctuation">.</span><span class="token function">getCrossed</span><span class="token punctuation">(</span>zaxis<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNormalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ofVec3f yaxis <span class="token operator">=</span> zaxis<span class="token punctuation">.</span><span class="token function">getCrossed</span><span class="token punctuation">(</span>xaxis<span class="token punctuation">)</span><span class="token punctuation">;</span>

	_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>xaxis<span class="token punctuation">.</span>x<span class="token punctuation">,</span> yaxis<span class="token punctuation">.</span>x<span class="token punctuation">,</span> zaxis<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>xaxis<span class="token punctuation">.</span>y<span class="token punctuation">,</span> yaxis<span class="token punctuation">.</span>y<span class="token punctuation">,</span> zaxis<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>xaxis<span class="token punctuation">.</span>z<span class="token punctuation">,</span> yaxis<span class="token punctuation">.</span>z<span class="token punctuation">,</span> zaxis<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">-</span>xaxis<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>yaxis<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>zaxis<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>eye<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">makeLookAtMatrix</span><span class="token punctuation">(</span><span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> eye<span class="token punctuation">,</span><span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> center<span class="token punctuation">,</span><span class="token keyword">const</span> ofVec3f<span class="token operator">&</span> up<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ofVec3f zaxis <span class="token operator">=</span> <span class="token punctuation">(</span>eye <span class="token operator">-</span> center<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNormalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ofVec3f xaxis <span class="token operator">=</span> up<span class="token punctuation">.</span><span class="token function">getCrossed</span><span class="token punctuation">(</span>zaxis<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNormalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ofVec3f yaxis <span class="token operator">=</span> zaxis<span class="token punctuation">.</span><span class="token function">getCrossed</span><span class="token punctuation">(</span>xaxis<span class="token punctuation">)</span><span class="token punctuation">;</span>

	_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>xaxis<span class="token punctuation">.</span>x<span class="token punctuation">,</span> xaxis<span class="token punctuation">.</span>y<span class="token punctuation">,</span> xaxis<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>yaxis<span class="token punctuation">.</span>x<span class="token punctuation">,</span> yaxis<span class="token punctuation">.</span>y<span class="token punctuation">,</span> yaxis<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>zaxis<span class="token punctuation">.</span>x<span class="token punctuation">,</span> zaxis<span class="token punctuation">.</span>y<span class="token punctuation">,</span> zaxis<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>eye<span class="token punctuation">.</span>x<span class="token punctuation">,</span> eye<span class="token punctuation">.</span>y<span class="token punctuation">,</span> eye<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">getLookAt</span><span class="token punctuation">(</span>ofVec3f<span class="token operator">&</span> eye<span class="token punctuation">,</span>ofVec3f<span class="token operator">&</span> center<span class="token punctuation">,</span>ofVec3f<span class="token operator">&</span> up<span class="token punctuation">,</span><span class="token keyword">float</span> lookDistance<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    ofMatrix4x4 inv<span class="token punctuation">;</span>
    inv<span class="token punctuation">.</span><span class="token function">makeInvertOf</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eye <span class="token operator">=</span> <span class="token function">ofVec3f</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">*</span>inv<span class="token punctuation">;</span>
    up <span class="token operator">=</span> <span class="token function">transform3x3</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">ofVec3f</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    center <span class="token operator">=</span> <span class="token function">transform3x3</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">ofVec3f</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    center<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    center <span class="token operator">=</span> eye <span class="token operator">+</span> center<span class="token operator">*</span>lookDistance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token keyword">typedef</span> ofQuaternion HVect<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">double</span> _HMatrix<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
	ofVec4f t<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Translation Component;</span>
	ofQuaternion q<span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// Essential Rotation</span>
	ofQuaternion u<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//Stretch rotation</span>
	HVect k<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//Sign of determinant</span>
	<span class="token keyword">double</span> f<span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">// Sign of determinant</span>
<span class="token punctuation">}</span> _affineParts<span class="token punctuation">;</span>


<span class="token keyword">enum</span> QuatPart <span class="token punctuation">{</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> Z<span class="token punctuation">,</span> W<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> SQRTHALF (0.7071067811865475244)</span>
<span class="token keyword">static</span> ofQuaternion <span class="token function">qxtoz</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>SQRTHALF<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SQRTHALF<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ofQuaternion <span class="token function">qytoz</span><span class="token punctuation">(</span>SQRTHALF<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SQRTHALF<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ofQuaternion <span class="token function">qppmm</span><span class="token punctuation">(</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ofQuaternion <span class="token function">qpppp</span><span class="token punctuation">(</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ofQuaternion <span class="token function">qmpmm</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ofQuaternion <span class="token function">qpppm</span><span class="token punctuation">(</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ofQuaternion <span class="token function">q0001</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> ofQuaternion <span class="token function">q1000</span><span class="token punctuation">(</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/** Copy nxn matrix A to C using "gets" for assignment **/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> matrixCopy(C, gets, A, n) {int i, j; for (i=0;i&lt;n;i++) for (j=0;j&lt;n;j++)\
    C[i][j] gets (A[i][j]);}</span>

<span class="token comment" spellcheck="true">/** Copy transpose of nxn matrix A to C using "gets" for assignment **/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> mat_tpose(AT,gets,A,n) {int i,j; for(i=0;i&lt;n;i++) for(j=0;j&lt;n;j++)\
    AT[i][j] gets (A[j][i]);}</span>

<span class="token comment" spellcheck="true">/** Fill out 3x3 matrix to 4x4 **/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> mat_pad(A) (A[W][X]=A[X][W]=A[W][Y]=A[Y][W]=A[W][Z]=A[Z][W]=0,A[W][W]=1)</span>


<span class="token comment" spellcheck="true">/** Assign nxn matrix C the element-wise combination of A and B using "op" **/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> matBinop(C,gets,A,op,B,n) {int i,j; for(i=0;i&lt;n;i++) for(j=0;j&lt;n;j++)\
    C[i][j] gets (A[i][j]) op (B[i][j]);}</span>

<span class="token comment" spellcheck="true">/** Copy nxn matrix A to C using "gets" for assignment **/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> mat_copy(C,gets,A,n) {int i,j; for(i=0;i&lt;n;i++) for(j=0;j&lt;n;j++)\
    C[i][j] gets (A[i][j]);}</span>

<span class="token comment" spellcheck="true">/** Multiply the upper left 3x3 parts of A and B to get AB **/</span>
<span class="token keyword">void</span> <span class="token function">mat_mult</span><span class="token punctuation">(</span>_HMatrix A<span class="token punctuation">,</span> _HMatrix B<span class="token punctuation">,</span> _HMatrix AB<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
        AB<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>B<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>B<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>B<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">mat_norm</span><span class="token punctuation">(</span>_HMatrix M<span class="token punctuation">,</span> <span class="token keyword">int</span> tpose<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">double</span> sum<span class="token punctuation">,</span> max<span class="token punctuation">;</span>
    max <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tpose<span class="token punctuation">)</span> sum <span class="token operator">=</span> <span class="token function">fabs</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">fabs</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">fabs</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>       sum <span class="token operator">=</span> <span class="token function">fabs</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">fabs</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">fabs</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>max<span class="token operator">&lt;</span>sum<span class="token punctuation">)</span> max <span class="token operator">=</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> max<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">norm_inf</span><span class="token punctuation">(</span>_HMatrix M<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">mat_norm</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token keyword">double</span> <span class="token function">norm_one</span><span class="token punctuation">(</span>_HMatrix M<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">mat_norm</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> _HMatrix mat_id <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/** Return index of column of M containing maximum abs entry, or -1 if M=0 **/</span>
<span class="token keyword">int</span> <span class="token function">find_max_col</span><span class="token punctuation">(</span>_HMatrix M<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> abs<span class="token punctuation">,</span> max<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> col<span class="token punctuation">;</span>
    max <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span> col <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        abs <span class="token operator">=</span> M<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>abs<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span> abs <span class="token operator">=</span> <span class="token operator">-</span>abs<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>abs<span class="token operator">></span>max<span class="token punctuation">)</span> <span class="token punctuation">{</span>max <span class="token operator">=</span> abs<span class="token punctuation">;</span> col <span class="token operator">=</span> j<span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> col<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">vcross</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> <span class="token keyword">double</span> <span class="token operator">*</span>vb<span class="token punctuation">,</span> <span class="token keyword">double</span> <span class="token operator">*</span>v<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> va<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>vb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> va<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>vb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> va<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>vb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> va<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>vb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> va<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>vb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> va<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>vb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/** Return dot product of length 3 vectors va and vb **/</span>
<span class="token keyword">double</span> <span class="token function">vdot</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> <span class="token keyword">double</span> <span class="token operator">*</span>vb<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>va<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>vb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> va<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>vb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> va<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>vb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">/** Set MadjT to transpose of inverse of M times determinant of M **/</span>
<span class="token keyword">void</span> <span class="token function">adjoint_transpose</span><span class="token punctuation">(</span>_HMatrix M<span class="token punctuation">,</span> _HMatrix MadjT<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">vcross</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> M<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> MadjT<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vcross</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> M<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> MadjT<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vcross</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> M<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> MadjT<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/** Setup u for Household reflection to zero all v components but first **/</span>
<span class="token keyword">void</span> <span class="token function">make_reflector</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span>v<span class="token punctuation">,</span> <span class="token keyword">double</span> <span class="token operator">*</span>u<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> s <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">vdot</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> u<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    u<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">-</span>s <span class="token operator">:</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token operator">/</span><span class="token function">vdot</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> u<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>s<span class="token punctuation">;</span> u<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> u<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>s<span class="token punctuation">;</span> u<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> u<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/** Apply Householder reflection represented by u to column vectors of M **/</span>
<span class="token keyword">void</span> <span class="token function">reflect_cols</span><span class="token punctuation">(</span>_HMatrix M<span class="token punctuation">,</span> <span class="token keyword">double</span> <span class="token operator">*</span>u<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> s <span class="token operator">=</span> u<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>M<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> u<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>M<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> u<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span>M<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> M<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">=</span> u<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">*</span>s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/** Apply Householder reflection represented by u to row vectors of M **/</span>
<span class="token keyword">void</span> <span class="token function">reflect_rows</span><span class="token punctuation">(</span>_HMatrix M<span class="token punctuation">,</span> <span class="token keyword">double</span> <span class="token operator">*</span>u<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> s <span class="token operator">=</span> <span class="token function">vdot</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> M<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> M<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">=</span> u<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">*</span>s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/** Find orthogonal factor Q of rank 1 (or less) M **/</span>
<span class="token keyword">void</span> <span class="token function">do_rank1</span><span class="token punctuation">(</span>_HMatrix M<span class="token punctuation">,</span> _HMatrix Q<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> v1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">;</span>
    <span class="token keyword">int</span> col<span class="token punctuation">;</span>
    <span class="token function">mat_copy</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span><span class="token operator">=</span><span class="token punctuation">,</span>mat_id<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* If rank(M) is 1, we should find a non-zero column in M */</span>
    col <span class="token operator">=</span> <span class="token function">find_max_col</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>col<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* Rank is 0 */</span>
    v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">;</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">;</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">make_reflector</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">reflect_cols</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> v2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">make_reflector</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">reflect_rows</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span> Q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token function">reflect_cols</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">reflect_rows</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/** Find orthogonal factor Q of rank 2 (or less) M using adjoint transpose **/</span>
<span class="token keyword">void</span> <span class="token function">do_rank2</span><span class="token punctuation">(</span>_HMatrix M<span class="token punctuation">,</span> _HMatrix MadjT<span class="token punctuation">,</span> _HMatrix Q<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> v1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> w<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> c<span class="token punctuation">,</span> s<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
    <span class="token keyword">int</span> col<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* If rank(M) is 2, we should find a non-zero column in MadjT */</span>
    col <span class="token operator">=</span> <span class="token function">find_max_col</span><span class="token punctuation">(</span>MadjT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>col<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">do_rank1</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> Q<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">/* Rank&lt;2 */</span>
    v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> MadjT<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">;</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> MadjT<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">;</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> MadjT<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">make_reflector</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">reflect_cols</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vcross</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> M<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">make_reflector</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">reflect_rows</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    w <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> x <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> y <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> z <span class="token operator">=</span> M<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token operator">*</span>z<span class="token operator">></span>x<span class="token operator">*</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c <span class="token operator">=</span> z<span class="token operator">+</span>w<span class="token punctuation">;</span> s <span class="token operator">=</span> y<span class="token operator">-</span>x<span class="token punctuation">;</span> d <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>c<span class="token operator">*</span>c<span class="token operator">+</span>s<span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> c <span class="token operator">=</span> c<span class="token operator">/</span>d<span class="token punctuation">;</span> s <span class="token operator">=</span> s<span class="token operator">/</span>d<span class="token punctuation">;</span>
        Q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span> Q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>Q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        c <span class="token operator">=</span> z<span class="token operator">-</span>w<span class="token punctuation">;</span> s <span class="token operator">=</span> y<span class="token operator">+</span>x<span class="token punctuation">;</span> d <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>c<span class="token operator">*</span>c<span class="token operator">+</span>s<span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> c <span class="token operator">=</span> c<span class="token operator">/</span>d<span class="token punctuation">;</span> s <span class="token operator">=</span> s<span class="token operator">/</span>d<span class="token punctuation">;</span>
        Q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>Q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span> Q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Q<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span> Q<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token function">reflect_cols</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">reflect_rows</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/* Return product of quaternion q by scalar w. */</span>
ofQuaternion <span class="token function">Qt_Scale</span><span class="token punctuation">(</span>ofQuaternion q<span class="token punctuation">,</span> <span class="token keyword">double</span> w<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ofQuaternion qq<span class="token punctuation">;</span>
	qq<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>w<span class="token punctuation">;</span>
	qq<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>w<span class="token punctuation">;</span>
	qq<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>w<span class="token punctuation">;</span>
	qq<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>w<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>qq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/* Construct a unit quaternion from rotation matrix.  Assumes matrix is
* used to multiply column vector on the left: vnew = mat vold.  Works
* correctly for right-handed coordinate system and right-handed rotations.
* Translation and perspective components ignored. */</span>

ofQuaternion <span class="token function">quatFromMatrix</span><span class="token punctuation">(</span>_HMatrix mat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">/* This algorithm avoids near-zero divides by looking for a large component
	* - first w, then x, y, or z.  When the trace is greater than zero,
	* |w| is greater than 1/2, which is as small as a largest component can be.
	* Otherwise, the largest diagonal entry corresponds to the largest of |x|,
	* |y|, or |z|, one of which must be larger than |w|, and at least 1/2. */</span>
   ofQuaternion qu <span class="token operator">=</span> q0001<span class="token punctuation">;</span>
   <span class="token keyword">double</span> tr<span class="token punctuation">,</span> s<span class="token punctuation">;</span>

   tr <span class="token operator">=</span> mat<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">[</span>X<span class="token punctuation">]</span> <span class="token operator">+</span> mat<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token operator">+</span> mat<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>tr <span class="token operator">>=</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
	   s <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>tr <span class="token operator">+</span> mat<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	   qu<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">;</span>
	   s <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">/</span> s<span class="token punctuation">;</span>
	   qu<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>mat<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">[</span>Y<span class="token punctuation">]</span> <span class="token operator">-</span> mat<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">;</span>
	   qu<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>mat<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">[</span>Z<span class="token punctuation">]</span> <span class="token operator">-</span> mat<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">;</span>
	   qu<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>mat<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">[</span>X<span class="token punctuation">]</span> <span class="token operator">-</span> mat<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span>
   <span class="token punctuation">{</span>
	   <span class="token keyword">int</span> h <span class="token operator">=</span> X<span class="token punctuation">;</span>
	   <span class="token keyword">if</span> <span class="token punctuation">(</span>mat<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">[</span>Y<span class="token punctuation">]</span> <span class="token operator">></span> mat<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">)</span> h <span class="token operator">=</span> Y<span class="token punctuation">;</span>
	   <span class="token keyword">if</span> <span class="token punctuation">(</span>mat<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">[</span>Z<span class="token punctuation">]</span> <span class="token operator">></span> mat<span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">)</span> h <span class="token operator">=</span> Z<span class="token punctuation">;</span>
	   <span class="token keyword">switch</span> <span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">define</span> caseMacro(i,j,k,I,J,K) \
		   case I:\
				  s = sqrt( (mat[I][I] - (mat[J][J]+mat[K][K])) + mat[W][W] );\
		   qu.i() = s*0.5;\
		   s = 0.5 / s;\
		   qu.j() = (mat[I][J] + mat[J][I]) * s;\
		   qu.k() = (mat[K][I] + mat[I][K]) * s;\
		   qu.w() = (mat[K][J] - mat[J][K]) * s;\
		   break</span>
		   <span class="token function">caseMacro</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">,</span>X<span class="token punctuation">,</span>Y<span class="token punctuation">,</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span>
		   <span class="token function">caseMacro</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>z<span class="token punctuation">,</span>x<span class="token punctuation">,</span>Y<span class="token punctuation">,</span>Z<span class="token punctuation">,</span>X<span class="token punctuation">)</span><span class="token punctuation">;</span>
		   <span class="token function">caseMacro</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>Z<span class="token punctuation">,</span>X<span class="token punctuation">,</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
	   <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>mat<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">[</span>W<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">1.0</span><span class="token punctuation">)</span> qu <span class="token operator">=</span> <span class="token function">Qt_Scale</span><span class="token punctuation">(</span>qu<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>mat<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>qu<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">/******* Polar Decomposition *******/</span>
<span class="token comment" spellcheck="true">/* Polar Decomposition of 3x3 matrix in 4x4,
 * M = QS.  See Nicholas Higham and Robert S. Schreiber,
 * Fast Polar Decomposition of An Arbitrary Matrix,
 * Technical Report 88-942, October 1988,
 * Department of Computer Science, Cornell University.
 */</span>

<span class="token keyword">double</span> <span class="token function">polarDecomp</span><span class="token punctuation">(</span> _HMatrix M<span class="token punctuation">,</span> _HMatrix Q<span class="token punctuation">,</span> _HMatrix S<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

<span class="token macro property">#<span class="token directive keyword">define</span> TOL 1.0e-6</span>
	_HMatrix Mk<span class="token punctuation">,</span> MadjTk<span class="token punctuation">,</span> Ek<span class="token punctuation">;</span>
	<span class="token keyword">double</span> det<span class="token punctuation">,</span> M_one<span class="token punctuation">,</span> M_inf<span class="token punctuation">,</span> MadjT_one<span class="token punctuation">,</span> MadjT_inf<span class="token punctuation">,</span> E_one<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> g1<span class="token punctuation">,</span> g2<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>

	<span class="token function">mat_tpose</span><span class="token punctuation">(</span>Mk<span class="token punctuation">,</span><span class="token operator">=</span><span class="token punctuation">,</span>M<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	M_one <span class="token operator">=</span> <span class="token function">norm_one</span><span class="token punctuation">(</span>Mk<span class="token punctuation">)</span><span class="token punctuation">;</span>  M_inf <span class="token operator">=</span> <span class="token function">norm_inf</span><span class="token punctuation">(</span>Mk<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">do</span>
	<span class="token punctuation">{</span>
		<span class="token function">adjoint_transpose</span><span class="token punctuation">(</span>Mk<span class="token punctuation">,</span> MadjTk<span class="token punctuation">)</span><span class="token punctuation">;</span>
		det <span class="token operator">=</span> <span class="token function">vdot</span><span class="token punctuation">(</span>Mk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> MadjTk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>det<span class="token operator">==</span><span class="token number">0.0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">do_rank2</span><span class="token punctuation">(</span>Mk<span class="token punctuation">,</span> MadjTk<span class="token punctuation">,</span> Mk<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		MadjT_one <span class="token operator">=</span> <span class="token function">norm_one</span><span class="token punctuation">(</span>MadjTk<span class="token punctuation">)</span><span class="token punctuation">;</span>
		MadjT_inf <span class="token operator">=</span> <span class="token function">norm_inf</span><span class="token punctuation">(</span>MadjTk<span class="token punctuation">)</span><span class="token punctuation">;</span>

		gamma <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>MadjT_one<span class="token operator">*</span>MadjT_inf<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>M_one<span class="token operator">*</span>M_inf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">fabs</span><span class="token punctuation">(</span>det<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		g1 <span class="token operator">=</span> gamma<span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">;</span>
		g2 <span class="token operator">=</span> <span class="token number">0.5</span><span class="token operator">/</span><span class="token punctuation">(</span>gamma<span class="token operator">*</span>det<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">matrixCopy</span><span class="token punctuation">(</span>Ek<span class="token punctuation">,</span><span class="token operator">=</span><span class="token punctuation">,</span>Mk<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">matBinop</span><span class="token punctuation">(</span>Mk<span class="token punctuation">,</span><span class="token operator">=</span><span class="token punctuation">,</span>g1<span class="token operator">*</span>Mk<span class="token punctuation">,</span><span class="token operator">+</span><span class="token punctuation">,</span>g2<span class="token operator">*</span>MadjTk<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">mat_copy</span><span class="token punctuation">(</span>Ek<span class="token punctuation">,</span><span class="token operator">-</span><span class="token operator">=</span><span class="token punctuation">,</span>Mk<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		E_one <span class="token operator">=</span> <span class="token function">norm_one</span><span class="token punctuation">(</span>Ek<span class="token punctuation">)</span><span class="token punctuation">;</span>
		M_one <span class="token operator">=</span> <span class="token function">norm_one</span><span class="token punctuation">(</span>Mk<span class="token punctuation">)</span><span class="token punctuation">;</span>
		M_inf <span class="token operator">=</span> <span class="token function">norm_inf</span><span class="token punctuation">(</span>Mk<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>E_one<span class="token operator">></span><span class="token punctuation">(</span>M_one<span class="token operator">*</span>TOL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">mat_tpose</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span><span class="token operator">=</span><span class="token punctuation">,</span>Mk<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">mat_pad</span><span class="token punctuation">(</span>Q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">mat_mult</span><span class="token punctuation">(</span>Mk<span class="token punctuation">,</span> M<span class="token punctuation">,</span> S<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">mat_pad</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span>i<span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
			S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.5</span><span class="token operator">*</span><span class="token punctuation">(</span>S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span>S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>det<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/******* Spectral Decomposition *******/</span>
<span class="token comment" spellcheck="true">/* Compute the spectral decomposition of symmetric positive semi-definite S.
* Returns rotation in U and scale factors in result, so that if K is a diagonal
* matrix of the scale factors, then S = U K (U transpose). Uses Jacobi method.
* See Gene H. Golub and Charles F. Van Loan. Matrix Computations. Hopkins 1983.
*/</span>
HVect <span class="token function">spectDecomp</span><span class="token punctuation">(</span>_HMatrix S<span class="token punctuation">,</span> _HMatrix U<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   HVect kv<span class="token punctuation">;</span>
   <span class="token keyword">double</span> Diag<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>OffD<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* OffD is off-diag (by omitted index) */</span>
   <span class="token keyword">double</span> g<span class="token punctuation">,</span>h<span class="token punctuation">,</span>fabsh<span class="token punctuation">,</span>fabsOffDi<span class="token punctuation">,</span>t<span class="token punctuation">,</span>theta<span class="token punctuation">,</span>c<span class="token punctuation">,</span>s<span class="token punctuation">,</span>tau<span class="token punctuation">,</span>ta<span class="token punctuation">,</span>OffDq<span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">;</span>
   <span class="token keyword">static</span> <span class="token keyword">char</span> nxt<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>Y<span class="token punctuation">,</span>Z<span class="token punctuation">,</span>X<span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> sweep<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
   <span class="token function">mat_copy</span><span class="token punctuation">(</span>U<span class="token punctuation">,</span><span class="token operator">=</span><span class="token punctuation">,</span>mat_id<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   Diag<span class="token punctuation">[</span>X<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">;</span> Diag<span class="token punctuation">[</span>Y<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">;</span> Diag<span class="token punctuation">[</span>Z<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">;</span>
   OffD<span class="token punctuation">[</span>X<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">;</span> OffD<span class="token punctuation">[</span>Y<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">;</span> OffD<span class="token punctuation">[</span>Z<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span>sweep<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span> sweep<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">;</span> sweep<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	   <span class="token keyword">double</span> sm <span class="token operator">=</span> <span class="token function">fabs</span><span class="token punctuation">(</span>OffD<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">fabs</span><span class="token punctuation">(</span>OffD<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">fabs</span><span class="token punctuation">(</span>OffD<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	   <span class="token keyword">if</span> <span class="token punctuation">(</span>sm<span class="token operator">==</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
	   <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span>Z<span class="token punctuation">;</span> i<span class="token operator">>=</span>X<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		   <span class="token keyword">int</span> p <span class="token operator">=</span> nxt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">int</span> q <span class="token operator">=</span> nxt<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
		   fabsOffDi <span class="token operator">=</span> <span class="token function">fabs</span><span class="token punctuation">(</span>OffD<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		   g <span class="token operator">=</span> <span class="token number">100.0</span><span class="token operator">*</span>fabsOffDi<span class="token punctuation">;</span>
		   <span class="token keyword">if</span> <span class="token punctuation">(</span>fabsOffDi<span class="token operator">></span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			   h <span class="token operator">=</span> Diag<span class="token punctuation">[</span>q<span class="token punctuation">]</span> <span class="token operator">-</span> Diag<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
			   fabsh <span class="token operator">=</span> <span class="token function">fabs</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
			   <span class="token keyword">if</span> <span class="token punctuation">(</span>fabsh<span class="token operator">+</span>g<span class="token operator">==</span>fabsh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				   t <span class="token operator">=</span> OffD<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">/</span>h<span class="token punctuation">;</span>
			   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				   theta <span class="token operator">=</span> <span class="token number">0.5</span><span class="token operator">*</span>h<span class="token operator">/</span>OffD<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
				   t <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token function">fabs</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">sqrt</span><span class="token punctuation">(</span>theta<span class="token operator">*</span>theta<span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				   <span class="token keyword">if</span> <span class="token punctuation">(</span>theta<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span> t <span class="token operator">=</span> <span class="token operator">-</span>t<span class="token punctuation">;</span>
			   <span class="token punctuation">}</span>
			   c <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>t<span class="token operator">*</span>t<span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> s <span class="token operator">=</span> t<span class="token operator">*</span>c<span class="token punctuation">;</span>
			   tau <span class="token operator">=</span> s<span class="token operator">/</span><span class="token punctuation">(</span>c<span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			   ta <span class="token operator">=</span> t<span class="token operator">*</span>OffD<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> OffD<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
			   Diag<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">=</span> ta<span class="token punctuation">;</span> Diag<span class="token punctuation">[</span>q<span class="token punctuation">]</span> <span class="token operator">+</span><span class="token operator">=</span> ta<span class="token punctuation">;</span>
			   OffDq <span class="token operator">=</span> OffD<span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">;</span>
			   OffD<span class="token punctuation">[</span>q<span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">=</span> s<span class="token operator">*</span><span class="token punctuation">(</span>OffD<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">+</span> tau<span class="token operator">*</span>OffD<span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			   OffD<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">+</span><span class="token operator">=</span> s<span class="token operator">*</span><span class="token punctuation">(</span>OffDq   <span class="token operator">-</span> tau<span class="token operator">*</span>OffD<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			   <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span>Z<span class="token punctuation">;</span> j<span class="token operator">>=</span>X<span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				   a <span class="token operator">=</span> U<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span> b <span class="token operator">=</span> U<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">;</span>
				   U<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">=</span> s<span class="token operator">*</span><span class="token punctuation">(</span>b <span class="token operator">+</span> tau<span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				   U<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>q<span class="token punctuation">]</span> <span class="token operator">+</span><span class="token operator">=</span> s<span class="token operator">*</span><span class="token punctuation">(</span>a <span class="token operator">-</span> tau<span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
			   <span class="token punctuation">}</span>
		   <span class="token punctuation">}</span>
	   <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   kv<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Diag<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">;</span> kv<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Diag<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">;</span> kv<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Diag<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">;</span> kv<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>kv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/* Return conjugate of quaternion. */</span>
ofQuaternion <span class="token function">Qt_Conj</span><span class="token punctuation">(</span>ofQuaternion q<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ofQuaternion qq<span class="token punctuation">;</span>
    qq<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>q<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> qq<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>q<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> qq<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>q<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> qq<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>qq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/* Return quaternion product qL * qR.  Note: order is important!
 * To combine rotations, use the product Mul(qSecond, qFirst),
 * which gives the effect of rotating by qFirst then qSecond. */</span>
ofQuaternion <span class="token function">Qt_Mul</span><span class="token punctuation">(</span>ofQuaternion qL<span class="token punctuation">,</span> ofQuaternion qR<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ofQuaternion qq<span class="token punctuation">;</span>
    qq<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> qL<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> qL<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> qL<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> qL<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qq<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> qL<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> qL<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> qL<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> qL<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qq<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> qL<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> qL<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> qL<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> qL<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qq<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> qL<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> qL<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> qL<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> qL<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>qR<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>qq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/* Construct a (possibly non-unit) quaternion from real components. */</span>
ofQuaternion <span class="token function">Qt_</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">,</span> <span class="token keyword">double</span> z<span class="token punctuation">,</span> <span class="token keyword">double</span> w<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ofQuaternion qq<span class="token punctuation">;</span>
    qq<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> x<span class="token punctuation">;</span> qq<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> y<span class="token punctuation">;</span> qq<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> z<span class="token punctuation">;</span> qq<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> w<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>qq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/******* Spectral Axis Adjustment *******/</span>

<span class="token comment" spellcheck="true">/* Given a unit quaternion, q, and a scale vector, k, find a unit quaternion, p,
 * which permutes the axes and turns freely in the plane of duplicate scale
 * factors, such that q p has the largest possible w component, i.e. the
 * smallest possible angle. Permutes k's components to go with q p instead of q.
 * See Ken Shoemake and Tom Duff. Matrix Animation and Polar Decomposition.
 * Proceedings of Graphics Interface 1992. Details on p. 262-263.
 */</span>
ofQuaternion <span class="token function">snuggle</span><span class="token punctuation">(</span>ofQuaternion q<span class="token punctuation">,</span> HVect <span class="token operator">*</span>k<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">define</span> sgn(n,v)    ((n)?-(v):(v))</span>
<span class="token macro property">#<span class="token directive keyword">define</span> swap(a,i,j) {a[3]=a[i]; a[i]=a[j]; a[j]=a[3];}</span>
<span class="token macro property">#<span class="token directive keyword">define</span> cycle(a,p)  if (p) {a[3]=a[0]; a[0]=a[1]; a[1]=a[2]; a[2]=a[3];}\
	else   {a[3]=a[2]; a[2]=a[1]; a[1]=a[0]; a[0]=a[3];}</span>

	ofQuaternion p <span class="token operator">=</span> q0001<span class="token punctuation">;</span>
	<span class="token keyword">double</span> ka<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> turn <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	ka<span class="token punctuation">[</span>X<span class="token punctuation">]</span> <span class="token operator">=</span> k<span class="token operator">-</span><span class="token operator">></span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ka<span class="token punctuation">[</span>Y<span class="token punctuation">]</span> <span class="token operator">=</span> k<span class="token operator">-</span><span class="token operator">></span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ka<span class="token punctuation">[</span>Z<span class="token punctuation">]</span> <span class="token operator">=</span> k<span class="token operator">-</span><span class="token operator">></span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>ka<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token operator">==</span>ka<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ka<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token operator">==</span>ka<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">)</span>
			turn <span class="token operator">=</span> W<span class="token punctuation">;</span>
		<span class="token keyword">else</span> turn <span class="token operator">=</span> Z<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ka<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token operator">==</span>ka<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">)</span>
			turn <span class="token operator">=</span> Y<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ka<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token operator">==</span>ka<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">)</span>
			turn <span class="token operator">=</span> X<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>turn<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ofQuaternion qtoz<span class="token punctuation">,</span> qp<span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span>  win<span class="token punctuation">;</span>
		<span class="token keyword">double</span> mag<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>turn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">Qt_Conj</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> X<span class="token operator">:</span> q <span class="token operator">=</span> <span class="token function">Qt_Mul</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> qtoz <span class="token operator">=</span> qxtoz<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">swap</span><span class="token punctuation">(</span>ka<span class="token punctuation">,</span>X<span class="token punctuation">,</span>Z<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> Y<span class="token operator">:</span> q <span class="token operator">=</span> <span class="token function">Qt_Mul</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> qtoz <span class="token operator">=</span> qytoz<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">swap</span><span class="token punctuation">(</span>ka<span class="token punctuation">,</span>Y<span class="token punctuation">,</span>Z<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> Z<span class="token operator">:</span> qtoz <span class="token operator">=</span> q0001<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		q <span class="token operator">=</span> <span class="token function">Qt_Conj</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>q<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>q<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>q<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>q<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">;</span>
		mag<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>q<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>q<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>q<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>q<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mag<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>q<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>q<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>q<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>q<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">bool</span> neg<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			neg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>mag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>neg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> mag<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>mag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>mag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">></span>mag<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">></span>mag<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
				win <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span> win <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mag<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">></span>mag<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> win <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span> win <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">switch</span> <span class="token punctuation">(</span>win<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>neg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> p <span class="token operator">=</span> q1000<span class="token punctuation">;</span> <span class="token keyword">else</span> p <span class="token operator">=</span> q0001<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>neg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> p <span class="token operator">=</span> qppmm<span class="token punctuation">;</span> <span class="token keyword">else</span> p <span class="token operator">=</span> qpppp<span class="token punctuation">;</span> <span class="token function">cycle</span><span class="token punctuation">(</span>ka<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>neg<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> p <span class="token operator">=</span> qmpmm<span class="token punctuation">;</span> <span class="token keyword">else</span> p <span class="token operator">=</span> qpppm<span class="token punctuation">;</span> <span class="token function">cycle</span><span class="token punctuation">(</span>ka<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		qp <span class="token operator">=</span> <span class="token function">Qt_Mul</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
		t <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>mag<span class="token punctuation">[</span>win<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		p <span class="token operator">=</span> <span class="token function">Qt_Mul</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token function">Qt_</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token operator">-</span>qp<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>t<span class="token punctuation">,</span>qp<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		p <span class="token operator">=</span> <span class="token function">Qt_Mul</span><span class="token punctuation">(</span>qtoz<span class="token punctuation">,</span> <span class="token function">Qt_Conj</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">double</span> qa<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pa<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> lo<span class="token punctuation">,</span> hi<span class="token punctuation">;</span>
		<span class="token keyword">bool</span> par <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token keyword">bool</span> neg<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">double</span> all<span class="token punctuation">,</span> big<span class="token punctuation">,</span> two<span class="token punctuation">;</span>
		qa<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> qa<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> qa<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> qa<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			pa<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
			neg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>qa<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>neg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> qa<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>qa<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
			par <span class="token operator">^</span><span class="token operator">=</span> neg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment" spellcheck="true">/* Find two largest components, indices in hi and lo */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>qa<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">></span>qa<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> lo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> lo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>qa<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">></span>qa<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> hi <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> hi <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>qa<span class="token punctuation">[</span>lo<span class="token punctuation">]</span><span class="token operator">></span>qa<span class="token punctuation">[</span>hi<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>qa<span class="token punctuation">[</span>lo<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">></span>qa<span class="token punctuation">[</span>hi<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				hi <span class="token operator">=</span> lo<span class="token punctuation">;</span> lo <span class="token operator">^</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				hi <span class="token operator">^</span><span class="token operator">=</span> lo<span class="token punctuation">;</span> lo <span class="token operator">^</span><span class="token operator">=</span> hi<span class="token punctuation">;</span> hi <span class="token operator">^</span><span class="token operator">=</span> lo<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>qa<span class="token punctuation">[</span>hi<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">></span>qa<span class="token punctuation">[</span>lo<span class="token punctuation">]</span><span class="token punctuation">)</span> lo <span class="token operator">=</span> hi<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		all <span class="token operator">=</span> <span class="token punctuation">(</span>qa<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>qa<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>qa<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>qa<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">;</span>
		two <span class="token operator">=</span> <span class="token punctuation">(</span>qa<span class="token punctuation">[</span>hi<span class="token punctuation">]</span><span class="token operator">+</span>qa<span class="token punctuation">[</span>lo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>SQRTHALF<span class="token punctuation">;</span>
		big <span class="token operator">=</span> qa<span class="token punctuation">[</span>hi<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>all<span class="token operator">></span>two<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>all<span class="token operator">></span>big<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/*all*/</span>
				<span class="token punctuation">{</span><span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> pa<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sgn</span><span class="token punctuation">(</span>neg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
				<span class="token function">cycle</span><span class="token punctuation">(</span>ka<span class="token punctuation">,</span>par<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/*big*/</span> pa<span class="token punctuation">[</span>hi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sgn</span><span class="token punctuation">(</span>neg<span class="token punctuation">[</span>hi<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>two<span class="token operator">></span>big<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/*two*/</span>
				pa<span class="token punctuation">[</span>hi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sgn</span><span class="token punctuation">(</span>neg<span class="token punctuation">[</span>hi<span class="token punctuation">]</span><span class="token punctuation">,</span>SQRTHALF<span class="token punctuation">)</span><span class="token punctuation">;</span>
				pa<span class="token punctuation">[</span>lo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sgn</span><span class="token punctuation">(</span>neg<span class="token punctuation">[</span>lo<span class="token punctuation">]</span><span class="token punctuation">,</span> SQRTHALF<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>lo<span class="token operator">></span>hi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					hi <span class="token operator">^</span><span class="token operator">=</span> lo<span class="token punctuation">;</span> lo <span class="token operator">^</span><span class="token operator">=</span> hi<span class="token punctuation">;</span> hi <span class="token operator">^</span><span class="token operator">=</span> lo<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>hi<span class="token operator">==</span>W<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					hi <span class="token operator">=</span> <span class="token string">"\001\002\000"</span><span class="token punctuation">[</span>lo<span class="token punctuation">]</span><span class="token punctuation">;</span>
					lo <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">-</span>hi<span class="token operator">-</span>lo<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token function">swap</span><span class="token punctuation">(</span>ka<span class="token punctuation">,</span>hi<span class="token punctuation">,</span>lo<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/*big*/</span>
				pa<span class="token punctuation">[</span>hi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sgn</span><span class="token punctuation">(</span>neg<span class="token punctuation">[</span>hi<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		p<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>pa<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> p<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>pa<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> p<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>pa<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> p<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> pa<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	k<span class="token operator">-</span><span class="token operator">></span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> ka<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">;</span> k<span class="token operator">-</span><span class="token operator">></span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> ka<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">;</span> k<span class="token operator">-</span><span class="token operator">></span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> ka<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/******* Decompose Affine Matrix *******/</span>

<span class="token comment" spellcheck="true">/* Decompose 4x4 affine matrix A as TFRUK(U transpose), where t contains the
 * translation components, q contains the rotation R, u contains U, k contains
 * scale factors, and f contains the sign of the determinant.
 * Assumes A transforms column vectors in right-handed coordinates.
 * See Ken Shoemake and Tom Duff. Matrix Animation and Polar Decomposition.
 * Proceedings of Graphics Interface 1992.
 */</span>
<span class="token keyword">void</span> <span class="token function">decompAffine</span><span class="token punctuation">(</span>_HMatrix A<span class="token punctuation">,</span> _affineParts <span class="token operator">*</span> parts<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	_HMatrix Q<span class="token punctuation">,</span> S<span class="token punctuation">,</span> U<span class="token punctuation">;</span>
	ofQuaternion p<span class="token punctuation">;</span>

	<span class="token comment" spellcheck="true">//Translation component.</span>
	parts<span class="token operator">-</span><span class="token operator">></span>t <span class="token operator">=</span> <span class="token function">ofVec4f</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>X<span class="token punctuation">]</span><span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">,</span> A<span class="token punctuation">[</span>Y<span class="token punctuation">]</span><span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">,</span> A<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">double</span> det <span class="token operator">=</span> <span class="token function">polarDecomp</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> Q<span class="token punctuation">,</span> S<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>det<span class="token operator">&lt;</span><span class="token number">0.0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">matrixCopy</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token punctuation">,</span> <span class="token operator">-</span>Q<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		parts<span class="token operator">-</span><span class="token operator">></span>f <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
		parts<span class="token operator">-</span><span class="token operator">></span>f <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

	parts<span class="token operator">-</span><span class="token operator">></span>q <span class="token operator">=</span> <span class="token function">quatFromMatrix</span><span class="token punctuation">(</span>Q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	parts<span class="token operator">-</span><span class="token operator">></span>k <span class="token operator">=</span> <span class="token function">spectDecomp</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span> U<span class="token punctuation">)</span><span class="token punctuation">;</span>
	parts<span class="token operator">-</span><span class="token operator">></span>u <span class="token operator">=</span> <span class="token function">quatFromMatrix</span><span class="token punctuation">(</span>U<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token function">snuggle</span><span class="token punctuation">(</span>parts<span class="token operator">-</span><span class="token operator">></span>u<span class="token punctuation">,</span> <span class="token operator">&</span>parts<span class="token operator">-</span><span class="token operator">></span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
	parts<span class="token operator">-</span><span class="token operator">></span>u <span class="token operator">=</span> <span class="token function">Qt_Mul</span><span class="token punctuation">(</span>parts<span class="token operator">-</span><span class="token operator">></span>u<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ofMatrix4x4<span class="token operator">::</span><span class="token function">decompose</span><span class="token punctuation">(</span> ofVec3f<span class="token operator">&</span> t<span class="token punctuation">,</span>
		   ofQuaternion<span class="token operator">&</span> r<span class="token punctuation">,</span>
		   ofVec3f<span class="token operator">&</span> s<span class="token punctuation">,</span>
		   ofQuaternion<span class="token operator">&</span> so <span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">{</span>

	_affineParts parts<span class="token punctuation">;</span>
    _HMatrix hmatrix<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Transpose copy of LTW</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            hmatrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">decompAffine</span><span class="token punctuation">(</span>hmatrix<span class="token punctuation">,</span> <span class="token operator">&</span>parts<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">double</span> mul <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">.</span>t<span class="token punctuation">[</span>W<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
        mul <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> parts<span class="token punctuation">.</span>t<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">;</span>

    t<span class="token punctuation">.</span>x <span class="token operator">=</span> parts<span class="token punctuation">.</span>t<span class="token punctuation">[</span>X<span class="token punctuation">]</span> <span class="token operator">*</span> mul<span class="token punctuation">;</span>
    t<span class="token punctuation">.</span>y <span class="token operator">=</span> parts<span class="token punctuation">.</span>t<span class="token punctuation">[</span>Y<span class="token punctuation">]</span> <span class="token operator">*</span> mul<span class="token punctuation">;</span>
    t<span class="token punctuation">.</span>z <span class="token operator">=</span> parts<span class="token punctuation">.</span>t<span class="token punctuation">[</span>Z<span class="token punctuation">]</span> <span class="token operator">*</span> mul<span class="token punctuation">;</span>

    r<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parts<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parts<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parts<span class="token punctuation">.</span>q<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mul <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">.</span>k<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
        mul <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> parts<span class="token punctuation">.</span>k<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// mul be sign of determinant to support negative scales.</span>
    mul <span class="token operator">*</span><span class="token operator">=</span> parts<span class="token punctuation">.</span>f<span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>x<span class="token operator">=</span> parts<span class="token punctuation">.</span>k<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> mul<span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>y <span class="token operator">=</span> parts<span class="token punctuation">.</span>k<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> mul<span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>z <span class="token operator">=</span> parts<span class="token punctuation">.</span>k<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> mul<span class="token punctuation">;</span>

    so<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span>u<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parts<span class="token punctuation">.</span>u<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parts<span class="token punctuation">.</span>u<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parts<span class="token punctuation">.</span>u<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">undef</span> SET_ROW</span>

std<span class="token operator">::</span>ostream<span class="token operator">&</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span>ostream<span class="token operator">&</span> os<span class="token punctuation">,</span> <span class="token keyword">const</span> ofMatrix4x4<span class="token operator">&</span> M<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
	os	<span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>

	os	<span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>

	os	<span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>

	os	<span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
		<span class="token operator">&lt;&lt;</span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> os<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

std<span class="token operator">::</span>istream<span class="token operator">&</span> <span class="token keyword">operator</span><span class="token operator">>></span><span class="token punctuation">(</span>std<span class="token operator">::</span>istream<span class="token operator">&</span> is<span class="token punctuation">,</span> ofMatrix4x4<span class="token operator">&</span> M<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> is<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	is <span class="token operator">>></span> M<span class="token punctuation">.</span>_mat<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> is<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div></div></div></div></div></div><script defer src="/_nuxt/payloads/1584626286009/openframeworks/math/ofMatrix4x4_cpp/payload.js"></script><script src="/_nuxt/3213b67383225fc2f59b.js" defer></script><script src="/_nuxt/d1291586b31fa28ca9d5.js" defer></script><script src="/_nuxt/5fe5bba000836bc4a25f.js" defer></script><script src="/_nuxt/f8d94d1c92ade1d8a6da.js" defer></script><script src="/_nuxt/9a7e20c23e9625feab77.js" defer></script>
  </body>
</html>
