{"data":[{"page":{"entry":{"name":"ofAVFoundationVideoPlayer.h","filename":"ofAVFoundationVideoPlayer.h","absolute":"/Users/Gilbert/Code/openFrameworks/libs/openFrameworks/video/ofAVFoundationVideoPlayer.h","path":"/openframeworks/video/ofAVFoundationVideoPlayer_h","route":"/openframeworks/video/ofAVFoundationVideoPlayer.h","dir":"../libs/openFrameworks/video","ext":"h","type":"source","id":326,"parent":323,"breadcrumbs":[323,164],"siblings":[],"translations":{}},"document":"<span class=\"token comment\" spellcheck=\"true\">//</span>\n<span class=\"token comment\" spellcheck=\"true\">//  ofAVFoundationVideoPlayer.h</span>\n<span class=\"token comment\" spellcheck=\"true\">//  Created by Lukasz Karluk on 06/07/14.</span>\n<span class=\"token comment\" spellcheck=\"true\">//\tMerged with code by Sam Kronick, James George and Elie Zananiri.</span>\n<span class=\"token comment\" spellcheck=\"true\">//</span>\n\n<span class=\"token comment\" spellcheck=\"true\">//----------------------------------------------------------</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">import</span> &lt;Foundation/Foundation.h></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">import</span> &lt;AVFoundation/AVFoundation.h></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">import</span> &lt;Accelerate/Accelerate.h></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">import</span> &lt;CoreMedia/CoreMedia.h></span>\n\n\n<span class=\"token comment\" spellcheck=\"true\">//----------------------------------------------------------</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;TargetConditionals.h></span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">if</span> (TARGET_OS_IPHONE_SIMULATOR) || (TARGET_OS_IPHONE) || (TARGET_IPHONE)</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> TARGET_IOS</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">else</span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> TARGET_OSX</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">endif</span></span>\n\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> USE_VIDEO_OUTPUT (defined(MAC_OS_X_VERSION_10_8) || defined(iOS6))</span>\n\n<span class=\"token comment\" spellcheck=\"true\">// so we are independend from oF in this class</span>\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">enum</span> _playerLoopType<span class=\"token punctuation\">{</span>\n    LOOP_NONE<span class=\"token operator\">=</span><span class=\"token number\">0x01</span><span class=\"token punctuation\">,</span>\n    LOOP_PALINDROME<span class=\"token operator\">=</span><span class=\"token number\">0x02</span><span class=\"token punctuation\">,</span>\n    LOOP_NORMAL<span class=\"token operator\">=</span><span class=\"token number\">0x03</span>\n<span class=\"token punctuation\">}</span> playerLoopType<span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\" spellcheck=\"true\">//---------------------------------------------------------- video player.</span>\n@interface ofAVFoundationVideoPlayer <span class=\"token operator\">:</span> NSObject <span class=\"token punctuation\">{</span>\n\t\n    AVPlayer <span class=\"token operator\">*</span> _player<span class=\"token punctuation\">;</span>\n\tAVAsset <span class=\"token operator\">*</span> _asset<span class=\"token punctuation\">;</span>\n    AVPlayerItem <span class=\"token operator\">*</span> _playerItem<span class=\"token punctuation\">;</span>\n\t\n\t\n\tAVAssetReader <span class=\"token operator\">*</span> _assetReader<span class=\"token punctuation\">;</span>\n\tAVAssetReaderTrackOutput <span class=\"token operator\">*</span> _assetReaderVideoTrackOutput<span class=\"token punctuation\">;</span>\n\tAVAssetReaderTrackOutput <span class=\"token operator\">*</span> _assetReaderAudioTrackOutput<span class=\"token punctuation\">;</span>\n\t\n<span class=\"token macro property\">#<span class=\"token directive keyword\">if</span> defined(USE_VIDEO_OUTPUT)</span>\n\tCMVideoFormatDescriptionRef _videoInfo<span class=\"token punctuation\">;</span>\n\tAVPlayerItemVideoOutput <span class=\"token operator\">*</span> _videoOutput<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">endif</span></span>\n\t\n\t\n    id timeObserver<span class=\"token punctuation\">;</span>\n    \n\tCMSampleBufferRef videoSampleBuffer<span class=\"token punctuation\">;</span>\n    CMSampleBufferRef audioSampleBuffer<span class=\"token punctuation\">;</span>\n    CMTime videoSampleTime<span class=\"token punctuation\">;</span>\n\tCMTime videoSampleTimePrev<span class=\"token punctuation\">;</span>\n    CMTime audioSampleTime<span class=\"token punctuation\">;</span>\n    CMTime synchSampleTime<span class=\"token punctuation\">;</span>\n\tCMTime duration<span class=\"token punctuation\">;</span>\n    CMTime currentTime<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> volume<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> speed<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">float</span> frameRate<span class=\"token punctuation\">;</span>\n    \n    NSInteger videoWidth<span class=\"token punctuation\">;</span>\n    NSInteger videoHeight<span class=\"token punctuation\">;</span>\n\t\n    playerLoopType loop<span class=\"token punctuation\">;</span>\n\t\n    BOOL bWillBeUpdatedExternally<span class=\"token punctuation\">;</span>\n    BOOL bReady<span class=\"token punctuation\">;</span>\n\tBOOL bLoaded<span class=\"token punctuation\">;</span>\n    BOOL bPlayStateBeforeLoad<span class=\"token punctuation\">;</span>\n    BOOL bUpdateFirstFrame<span class=\"token punctuation\">;</span>\n    BOOL bNewFrame<span class=\"token punctuation\">;</span>\n    BOOL bPlaying<span class=\"token punctuation\">;</span>\n\tBOOL bWasPlayingBackwards<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// for optimisation</span>\n    BOOL bFinished<span class=\"token punctuation\">;</span>\n    BOOL bAutoPlayOnLoad<span class=\"token punctuation\">;</span>\n    BOOL bSeeking<span class=\"token punctuation\">;</span>\n    BOOL bSampleVideo<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// default to YES</span>\n    BOOL bSampleAudio<span class=\"token punctuation\">;</span> <span class=\"token comment\" spellcheck=\"true\">// default to NO</span>\n\tBOOL bIsUnloaded<span class=\"token punctuation\">;</span>\n\tBOOL bStream<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">int</span> frameBeforeReady<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">float</span> positionBeforeReady<span class=\"token punctuation\">;</span>\n\t\n\tNSLock<span class=\"token operator\">*</span> asyncLock<span class=\"token punctuation\">;</span>\n\tNSCondition<span class=\"token operator\">*</span> deallocCond<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n@<span class=\"token function\">property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> retain<span class=\"token punctuation\">)</span> AVPlayer <span class=\"token operator\">*</span> player<span class=\"token punctuation\">;</span>\n@<span class=\"token function\">property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> retain<span class=\"token punctuation\">)</span> AVAsset <span class=\"token operator\">*</span> asset<span class=\"token punctuation\">;</span>\n@<span class=\"token function\">property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> retain<span class=\"token punctuation\">)</span> AVPlayerItem <span class=\"token operator\">*</span> playerItem<span class=\"token punctuation\">;</span>\n\n\n@<span class=\"token function\">property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> retain<span class=\"token punctuation\">)</span> AVAssetReader <span class=\"token operator\">*</span> assetReader<span class=\"token punctuation\">;</span>\n@<span class=\"token function\">property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> retain<span class=\"token punctuation\">)</span> AVAssetReaderTrackOutput <span class=\"token operator\">*</span> assetReaderVideoTrackOutput<span class=\"token punctuation\">;</span>\n@<span class=\"token function\">property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> retain<span class=\"token punctuation\">)</span> AVAssetReaderTrackOutput <span class=\"token operator\">*</span> assetReaderAudioTrackOutput<span class=\"token punctuation\">;</span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">if</span> defined(USE_VIDEO_OUTPUT)</span>\n@<span class=\"token function\">property</span> <span class=\"token punctuation\">(</span>nonatomic<span class=\"token punctuation\">,</span> retain<span class=\"token punctuation\">)</span> AVPlayerItemVideoOutput <span class=\"token operator\">*</span>videoOutput<span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">endif</span></span>\n\n\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>loadWithFile<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>NSString<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>file async<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>bAsync<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>loadWithPath<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>NSString<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>path async<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>bAsync<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>loadWithURL<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>NSURL<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>url async<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>bAsync stream<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>isStream<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>unloadVideoAsync<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>unloadVideo<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>update<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>play<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>pause<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>togglePlayPause<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>stepByCount<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span>frames<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>seekToStart<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>seekToEnd<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>seekToTime<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>CMTime<span class=\"token punctuation\">)</span>time<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>seekToTime<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>CMTime<span class=\"token punctuation\">)</span>time withTolerance<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>CMTime<span class=\"token punctuation\">)</span>tolerance<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>isReady<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>isLoaded<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>isPlaying<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>isNewFrame<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>isFinished<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setEnableVideoSampling<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>value<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setEnableAudioSampling<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>value<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setSynchSampleTime<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>CMTime<span class=\"token punctuation\">)</span>time<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setSynchSampleTimeInSec<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>time<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>CMTime<span class=\"token punctuation\">)</span>getVideoSampleTime<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>getVideoSampleTimeInSec<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>CMTime<span class=\"token punctuation\">)</span>getAudioSampleTime<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>getAudioSampleTimeInSec<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>CMSampleBufferRef<span class=\"token punctuation\">)</span>getVideoSampleBuffer<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>CMSampleBufferRef<span class=\"token punctuation\">)</span>getAudioSampleBuffer<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>CVImageBufferRef<span class=\"token punctuation\">)</span>getCurrentFrame<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>NSInteger<span class=\"token punctuation\">)</span>getWidth<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>NSInteger<span class=\"token punctuation\">)</span>getHeight<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>CMTime<span class=\"token punctuation\">)</span>getCurrentTime<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>getCurrentTimeInSec<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>CMTime<span class=\"token punctuation\">)</span>getDuration<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>getDurationInSec<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>getDurationInFrames<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>getCurrentFrameNum<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>getFrameRate<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setFrame<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>frame<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setPosition<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>position<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>getPosition<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setVolume<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>volume<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>getVolume<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setLoop<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>playerLoopType<span class=\"token punctuation\">)</span>loop<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>playerLoopType<span class=\"token punctuation\">)</span>getLoop<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setSpeed<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>speed<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>getSpeed<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setAutoplay<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>bAutoplay<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>getAutoplay<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setWillBeUpdatedExternally<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>value<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>close<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>setStreaming<span class=\"token operator\">:</span><span class=\"token punctuation\">(</span>BOOL<span class=\"token punctuation\">)</span>value<span class=\"token punctuation\">;</span>\n\n\n@end\n","type":"source","static":true}}],"fetch":[]}